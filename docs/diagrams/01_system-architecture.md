# システム構成図

**プロジェクト名**: 役所設備管理システム AWS ECS 移行プロジェクト
**作成日**: 2025-10-25
**バージョン**: 1.0

---

## 1. 全体構成図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            AWS Organizations                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────┐                                                       │
│  │  管理アカウント   │ Organizations管理、Billing統合                        │
│  └──────────────────┘                                                       │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │             共通系アカウント（network-shared）                        │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────┐   │  │
│  │  │  Egress VPC (10.255.0.0/16)                                  │   │  │
│  │  │  ┌─────────────────────────────────────────────────────┐   │   │  │
│  │  │  │ AWS Network Firewall (Windows Update用)              │   │   │  │
│  │  │  │  - *.windowsupdate.com                               │   │   │  │
│  │  │  │  - *.update.microsoft.com                            │   │   │  │
│  │  │  └─────────────────────────────────────────────────────┘   │   │  │
│  │  │  ┌─────────────┐  ┌──────────────┐                        │   │  │
│  │  │  │ NAT Gateway │  │ Internet GW  │                        │   │  │
│  │  │  └─────────────┘  └──────────────┘                        │   │  │
│  │  └─────────────────────────────────────────────────────────────┘   │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────┐   │  │
│  │  │  Transit Gateway (Hub)                                       │   │  │
│  │  │  - service-dev VPC Attachment                                │   │  │
│  │  │  - service-stg VPC Attachment                                │   │  │
│  │  │  - service-prod VPC Attachment                               │   │  │
│  │  │  - Egress VPC Attachment                                     │   │  │
│  │  │  - Direct Connect Gateway                                    │   │  │
│  │  │  - VPN Attachment (フレッツワイドVPN)                        │   │  │
│  │  └─────────────────────────────────────────────────────────────┘   │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────┐   │  │
│  │  │  Client VPN (管理・検証用)                                   │   │  │
│  │  │  - インフラ担当者用                                          │   │  │
│  │  │  - ルーティング確認、デバッグ用                              │   │  │
│  │  └─────────────────────────────────────────────────────────────┘   │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────┐   │  │
│  │  │  セキュリティ・監査サービス                                  │   │  │
│  │  │  - Security Hub (全アカウント集約)                           │   │  │
│  │  │  - GuardDuty (脅威検知)                                      │   │  │
│  │  │  - AWS Config (構成監査)                                     │   │  │
│  │  │  - CloudTrail (Organizations Trail)                          │   │  │
│  │  │  - S3バケット (ログ集約用)                                   │   │  │
│  │  └─────────────────────────────────────────────────────────────┘   │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────┐   │  │
│  │  │  Route53 Resolver (DNS転送)                                  │   │  │
│  │  └─────────────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  service-dev アカウント (VPC: 10.0.0.0/16)                           │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  service-stg アカウント (VPC: 10.1.0.0/16)                           │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  service-prod アカウント (VPC: 10.2.0.0/16)                          │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. サービス系アカウント詳細構成（dev/stg/prod共通）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  サービス系アカウント (service-dev/stg/prod)                                  │
│  VPC: 10.0.0.0/16 (dev) / 10.1.0.0/16 (stg) / 10.2.0.0/16 (prod)            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  【AZ-a】                           【AZ-c】                                 │
│                                                                              │
│  ┌────────────────────────┐        ┌────────────────────────┐              │
│  │ パブリックサブネット    │        │ パブリックサブネット    │              │
│  │ (10.x.0.0/24)          │        │ (10.x.1.0/24)          │              │
│  │                        │        │                        │              │
│  │ ┌──────────────────┐  │        │ ┌──────────────────┐  │              │
│  │ │ パブリックALB     │  │        │ │ パブリックALB     │  │              │
│  │ │ (事業者向け)      │◄─┼────────┼─┤ (事業者向け)      │  │              │
│  │ └──────────────────┘  │        │ └──────────────────┘  │              │
│  │                        │        │                        │              │
│  │ ┌──────────────────┐  │        │ ┌──────────────────┐  │              │
│  │ │ NAT Gateway       │  │        │ │ NAT Gateway       │  │              │
│  │ └──────────────────┘  │        │ └──────────────────┘  │              │
│  │         │              │        │         │              │              │
│  │         │ Internet GW  │        │         │ Internet GW  │              │
│  └─────────┼──────────────┘        └─────────┼──────────────┘              │
│            ▼                                  ▼                             │
│      インターネット                      インターネット                      │
│                                                                              │
│  ┌────────────────────────┐        ┌────────────────────────┐              │
│  │ プライベートサブネット  │        │ プライベートサブネット  │              │
│  │ (アプリ層)             │        │ (アプリ層)             │              │
│  │ (10.x.10.0/24)         │        │ (10.x.11.0/24)         │              │
│  │                        │        │                        │              │
│  │ ┌──────────────────┐  │        │ ┌──────────────────┐  │              │
│  │ │ 内部ALB           │  │        │ │ 内部ALB           │  │              │
│  │ │ (職員向け)        │◄─┼────────┼─┤ (職員向け)        │  │              │
│  │ └──────────────────┘  │        │ └──────────────────┘  │              │
│  │         │              │        │         │              │              │
│  │         ▼              │        │         ▼              │              │
│  │ ┌──────────────────┐  │        │ ┌──────────────────┐  │              │
│  │ │ ECS Fargate       │  │        │ │ ECS Fargate       │  │              │
│  │ │ ┌──────────────┐ │  │        │ │ ┌──────────────┐ │  │              │
│  │ │ │業務APIタスク  │ │  │        │ │ │業務APIタスク  │ │  │              │
│  │ │ │+ SPA配信      │ │  │        │ │ │+ SPA配信      │ │  │              │
│  │ │ └──────────────┘ │  │        │ │ └──────────────┘ │  │              │
│  │ │ ┌──────────────┐ │  │        │ │ ┌──────────────┐ │  │              │
│  │ │ │事業者APIタスク│ │  │        │ │ │事業者APIタスク│ │  │              │
│  │ │ └──────────────┘ │  │        │ │ └──────────────┘ │  │              │
│  │ │ ┌──────────────┐ │  │        │ │ ┌──────────────┐ │  │              │
│  │ │ │バッチタスク   │ │  │        │ │ │バッチタスク   │ │  │              │
│  │ │ │(EventBridge)  │ │  │        │ │ │(EventBridge)  │ │  │              │
│  │ │ └──────────────┘ │  │        │ │ └──────────────┘ │  │              │
│  │ └──────────────────┘  │        │ └──────────────────┘  │              │
│  └────────────────────────┘        └────────────────────────┘              │
│                                                                              │
│  ┌────────────────────────┐        ┌────────────────────────┐              │
│  │ プライベートサブネット  │        │ プライベートサブネット  │              │
│  │ (DB層)                 │        │ (DB層)                 │              │
│  │ (10.x.20.0/24)         │        │ (10.x.21.0/24)         │              │
│  │                        │        │                        │              │
│  │ ┌──────────────────┐  │        │ ┌──────────────────┐  │              │
│  │ │ RDS PostgreSQL    │  │        │ │ RDS PostgreSQL    │  │              │
│  │ │ (Primary/Standby) │◄─┼────────┼─┤ (マルチAZ)        │  │              │
│  │ └──────────────────┘  │        │ └──────────────────┘  │              │
│  └────────────────────────┘        └────────────────────────┘              │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  その他リソース                                                       │   │
│  │  - Cognito (職員用ユーザープール)                                    │   │
│  │  - Cognito (事業者用ユーザープール)                                  │   │
│  │  - ECR (コンテナレジストリ)                                          │   │
│  │  - Secrets Manager (DB接続情報、APIキー)                             │   │
│  │  - CloudWatch Logs                                                    │   │
│  │  - S3 (事業者向けSPA配信用) + CloudFront                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Transit Gateway Attachment                                           │   │
│  │  → 共通系アカウントのTransit Gatewayに接続                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. アクセス経路図

### 3.1 職員向けアクセス経路（完全閉域）

```
┌──────────────┐
│ 職員PC        │
│ (庁舎内)      │
└──────┬───────┘
       │ フレッツワイドVPN
       │ or
       │ Direct Connect
       ▼
┌─────────────────────────────────┐
│ 【共通系アカウント】             │
│  Transit Gateway                │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│ 【サービス系アカウント】         │
│  VPC (10.x.0.0/16)              │
│                                 │
│  ┌──────────────┐              │
│  │ 内部ALB       │              │
│  │ (internet-    │              │
│  │  facing:false)│              │
│  └──────┬───────┘              │
│         │                       │
│         ▼                       │
│  ┌──────────────┐              │
│  │ ECS Fargate   │              │
│  │ - 業務API     │              │
│  │ - React SPA   │              │
│  └──────┬───────┘              │
│         │                       │
│         ▼                       │
│  ┌──────────────┐              │
│  │ RDS PostgreSQL│              │
│  └──────────────┘              │
└─────────────────────────────────┘
```

### 3.2 事業者向けアクセス経路（インターネット公開）

```
┌──────────────┐
│ 事業者ブラウザ│
└──────┬───────┘
       │ HTTPS
       ▼
┌──────────────┐
│ CloudFront    │
│ + WAF         │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ S3            │
│ (React SPA)   │
└──────────────┘
       │
       │ API呼び出し
       ▼
┌─────────────────────────────────┐
│ 【サービス系アカウント】         │
│                                 │
│  ┌──────────────┐              │
│  │ パブリックALB │              │
│  │ (internet-    │              │
│  │  facing:true) │              │
│  └──────┬───────┘              │
│         │                       │
│         ▼                       │
│  ┌──────────────┐              │
│  │ ECS Fargate   │              │
│  │ - 事業者API   │              │
│  └──────┬───────┘              │
│         │                       │
│         ▼                       │
│  ┌──────────────┐              │
│  │ RDS PostgreSQL│              │
│  └──────────────┘              │
└─────────────────────────────────┘
```

### 3.3 庁舎端末のWindows Update経路

```
┌──────────────┐
│ 庁舎端末      │
│ (Windows)     │
└──────┬───────┘
       │ フレッツワイドVPN
       │ or
       │ Direct Connect
       ▼
┌─────────────────────────────────┐
│ 【共通系アカウント】             │
│  Transit Gateway                │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│ 【共通系アカウント】             │
│  Egress VPC (10.255.0.0/16)     │
│                                 │
│  ┌──────────────────────────┐  │
│  │ AWS Network Firewall      │  │
│  │ (ホワイトリスト)          │  │
│  │ - *.windowsupdate.com     │  │
│  │ - *.update.microsoft.com  │  │
│  └──────┬───────────────────┘  │
│         │                       │
│         ▼                       │
│  ┌──────────────┐              │
│  │ NAT Gateway   │              │
│  └──────┬───────┘              │
│         │                       │
│         ▼                       │
│  ┌──────────────┐              │
│  │ Internet GW   │              │
│  └──────┬───────┘              │
└─────────┼───────────────────────┘
          │
          ▼
    ┌──────────────┐
    │ Microsoft     │
    │ Update Server │
    └──────────────┘
```

---

## 4. リソース配置表

### 4.1 共通系アカウント（network-shared）

| リソース | 用途 | 備考 |
|---------|------|------|
| Transit Gateway | ネットワークHub | 全サービスアカウントと接続 |
| Egress VPC | インターネット出口 | 10.255.0.0/16 |
| AWS Network Firewall | Windows Updateフィルタリング | ホワイトリスト方式 |
| Direct Connect Gateway | オンプレミス接続 | フレッツワイドVPNと併用 |
| Client VPN | 管理・検証用 | インフラ担当者のみ |
| Security Hub | セキュリティ集約 | 全アカウント統合 |
| GuardDuty | 脅威検知 | 全アカウント統合 |
| AWS Config | 構成監査 | 全アカウント統合 |
| CloudTrail | 監査ログ | Organizations Trail |
| Route53 Resolver | DNS転送 | オンプレDNSと連携 |

### 4.2 サービス系アカウント（dev/stg/prod）

| リソース | dev | stg | prod | 備考 |
|---------|-----|-----|------|------|
| VPC CIDR | 10.0.0.0/16 | 10.1.0.0/16 | 10.2.0.0/16 | - |
| 内部ALB | ○ | ○ | ○ | 職員向け、閉域 |
| パブリックALB | ○ | ○ | ○ | 事業者向け、公開 |
| ECS Fargate (業務API) | 0.25vCPU/0.5GB | 0.25vCPU/0.5GB | 0.5vCPU/1GB | CPU70%でスケール |
| ECS Fargate (事業者API) | 0.25vCPU/0.5GB | 0.25vCPU/0.5GB | 0.5vCPU/1GB | CPU70%でスケール |
| ECS Fargate (バッチ) | 0.25vCPU/0.5GB | 0.25vCPU/0.5GB | 0.5vCPU/1GB | EventBridge起動 |
| RDS PostgreSQL | db.t4g.micro | db.t4g.small | db.t4g.medium | - |
| RDS マルチAZ | 無効 | 有効 | 有効 | prodは必須 |
| Cognito (職員用) | ○ | ○ | ○ | 各環境独立 |
| Cognito (事業者用) | ○ | ○ | ○ | 各環境独立 |
| CloudFront + S3 | ○ | ○ | ○ | 事業者向けSPA |

---

## 5. ネットワーク設計

### 5.1 CIDR設計

| アカウント/VPC | CIDR | 備考 |
|---------------|------|------|
| service-dev | 10.0.0.0/16 | 開発環境 |
| service-stg | 10.1.0.0/16 | ステージング環境 |
| service-prod | 10.2.0.0/16 | 本番環境 |
| Egress VPC (共通系) | 10.255.0.0/16 | Windows Update出口 |

### 5.2 サブネット設計（各サービスアカウント共通）

| サブネット種別 | AZ-a | AZ-c | 用途 |
|---------------|------|------|------|
| パブリックサブネット | 10.x.0.0/24 | 10.x.1.0/24 | パブリックALB、NAT GW |
| プライベートサブネット（アプリ層） | 10.x.10.0/24 | 10.x.11.0/24 | 内部ALB、ECS Fargate |
| プライベートサブネット（DB層） | 10.x.20.0/24 | 10.x.21.0/24 | RDS PostgreSQL |

※ x = 0 (dev), 1 (stg), 2 (prod)

---

## 6. セキュリティ設計

### 6.1 認証・認可

| システム | 認証方式 | 備考 |
|---------|---------|------|
| 職員向け業務API | Amazon Cognito (職員用ユーザープール) | MFA推奨 |
| 事業者向けAPI | Amazon Cognito (事業者用ユーザープール) | 事業者単位でデータ分離 |
| APIトークン | JWT | 有効期限30分 |

### 6.2 暗号化

| 項目 | 方式 | 備考 |
|------|------|------|
| 通信暗号化 | TLS 1.3 | ALB終端 |
| RDS保存時 | AES-256 (AWS KMS) | - |
| RDS転送時 | TLS 1.3 | - |
| S3保存時 | AES-256 (SSE-S3) | - |
| ECS環境変数 | Secrets Manager | DB接続情報等 |

### 6.3 ネットワークセキュリティ

| 項目 | 対策 | 備考 |
|------|------|------|
| 業務API | 内部ALB、VPN経由のみ | 完全閉域 |
| 事業者API | WAF適用 | OWASPルールセット |
| Windows Update | Network Firewall | ホワイトリスト方式 |
| VPCフローログ | 有効 | CloudWatch Logs経由でS3保管 |

---

## 7. 監視・ログ設計

### 7.1 監視項目

| 監視項目 | ツール | 閾値 | 通知先 |
|---------|--------|------|--------|
| ECS CPU使用率 | CloudWatch | 80%以上 | メール、Slack、Teams |
| ECS メモリ使用率 | CloudWatch | 80%以上 | メール、Slack、Teams |
| RDS CPU使用率 | CloudWatch | 80%以上 | メール、Slack、Teams |
| ALB 5xxエラー率 | CloudWatch | 5%以上 | メール、Slack、Teams |

### 7.2 ログ保管

| ログ種別 | 保管先 | 保管期間 | ライフサイクル |
|---------|--------|---------|---------------|
| アプリケーションログ | CloudWatch Logs → S3 | 2年 | 3ヶ月後にS3、1年後にGlacier |
| アクセスログ (ALB) | S3 | 2年 | 同上 |
| VPCフローログ | CloudWatch Logs → S3 | 1年 | 同上 |
| CloudTrail | S3 (共通系) | 2年 | 同上 |

---

## 8. DR（災害対策）設計

### 8.1 通常時の構成

- **リージョン**: 東京リージョン
- **AZ**: マルチAZ（2AZ）
- **対応範囲**: AZ障害に自動対応

### 8.2 災害時の対応

| シナリオ | 対応方針 | 目標復旧時間 |
|---------|---------|-------------|
| 単一AZ障害 | 自動フェイルオーバー | 数分（自動） |
| 東京リージョン壊滅 | 大阪リージョンへ手動再構築 | 24時間以内 |

### 8.3 DR準備

- CloudFormationテンプレートのGit管理
- RDSスナップショットの別リージョン（大阪）へのコピー（毎日）
- DR手順書の整備
- 年1回のDR訓練実施

---

**作成者**: AI開発ファシリテーター
**承認者**: （未定）
**承認日**: （未定）
