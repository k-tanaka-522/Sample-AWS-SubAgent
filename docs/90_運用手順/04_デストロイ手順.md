# デストロイ手順

## 目次

1. [概要](#概要)
2. [デストロイ順序](#デストロイ順序)
3. [Service Account デストロイ](#service-account-デストロイ)
4. [Shared Account デストロイ](#shared-account-デストロイ)
5. [保持されるリソースの削除](#保持されるリソースの削除)
6. [OIDC設定の削除](#oidc設定の削除)
7. [トラブルシューティング](#トラブルシューティング)

---

## 概要

### デストロイとは

CloudFormation スタックとそれに関連するすべてのAWSリソースを**完全に削除**する操作です。

### 重要な注意事項

⚠️ **この操作は不可逆です！**

- ✅ デストロイ前にバックアップを取得
- ✅ RDS スナップショット作成
- ✅ S3 バケットのデータをエクスポート
- ✅ CloudWatch Logs をアーカイブ
- ✅ 本番環境の場合は関係者全員の承認を得る

### デストロイが必要なケース

- 🧪 開発環境の完全削除（コスト削減）
- 🔄 環境の再構築
- 🧹 テスト環境のクリーンアップ
- 🚀 プロジェクト終了時の後始末

---

## デストロイ順序

### 重要: 依存関係の逆順

CloudFormation スタックは**依存関係の逆順**で削除する必要があります。

```
【削除順序】

1. Service Account（環境別）
   ↓
   06-monitoring（CloudWatch Alarms, SNS Topics）
   ↓
   05-storage（S3, CloudFront）
   ↓
   04-auth（Cognito User Pools）
   ↓
   03-compute（ECS, ALB, Target Groups）
   ↓
   02-database（RDS, DB Subnet Group）
   ↓
   01-network（VPC, Subnets, Transit Gateway Attachment）

2. Shared Account
   ↓
   3-client-vpn（Client VPN Endpoint）
   ↓
   2-network（Transit Gateway, Direct Connect）← Service Account削除後
   ↓
   1-foundation（CloudTrail, Config, GuardDuty, Security Hub）
```

**理由**:
- `03-compute` (ALB) は `01-network` (Subnet) に依存
- `02-database` (RDS) は `01-network` (Subnet, SecurityGroup) に依存
- `01-network` (Transit Gateway Attachment) は Shared Account の `2-network` (Transit Gateway) に依存
- **Shared Account の Transit Gateway を先に削除すると、Service Account の Transit Gateway Attachment 削除に失敗**

---

## Service Account デストロイ

### 前提条件

- ✅ AWS CLI 設定済み
- ✅ Service Account（AWS Account ID: 897167645238）に認証済み
- ✅ CloudFormation スタックがデプロイ済み

### Step 1: 環境選択

デストロイする環境を決定：
- `dev` - 開発環境
- `stg` - ステージング環境
- `prod` - 本番環境

### Step 2: デストロイスクリプト実行

```bash
cd infra/cloudformation/service

# 開発環境をデストロイ
./scripts/destroy-all.sh dev

# ステージング環境をデストロイ
./scripts/destroy-all.sh stg

# 本番環境をデストロイ（慎重に！）
./scripts/destroy-all.sh prod
```

### Step 3: 確認プロンプト

スクリプト実行時、以下が表示されます：

```
====================================
⚠️  DANGER: CloudFormation Stack Deletion
====================================
Environment: dev
Project:     facilities

The following stacks will be DELETED:
  - facilities-dev-06-monitoring
  - facilities-dev-05-storage
  - facilities-dev-04-auth
  - facilities-dev-03-compute
  - facilities-dev-02-database
  - facilities-dev-01-network

This operation is IRREVERSIBLE!
====================================

Are you sure you want to DELETE all stacks? (type 'DELETE' to confirm):
```

**重要**: `DELETE` と正確に入力してください（大文字）。

### Step 4: デストロイ実行

スクリプトは以下を自動実行します：

```
====================================
Deleting: facilities-dev-06-monitoring
====================================
Waiting for stack deletion to complete...
✅ Stack deleted: facilities-dev-06-monitoring

====================================
Deleting: facilities-dev-05-storage
====================================
Waiting for stack deletion to complete...
✅ Stack deleted: facilities-dev-05-storage

...（以下、01-network まで続く）

====================================
✅ All stacks deleted successfully
====================================

Note: Some resources may have DeletionPolicy: Retain
Check AWS Console for retained resources:
  - S3 Buckets
  - CloudWatch Log Groups
  - RDS Snapshots
====================================
```

### Step 5: 完了確認

```bash
# スタックが削除されたことを確認
aws cloudformation list-stacks \
  --stack-status-filter DELETE_COMPLETE \
  --query 'StackSummaries[?starts_with(StackName, `facilities-dev-`)].StackName'
```

**期待される出力**:
```json
[
  "facilities-dev-06-monitoring",
  "facilities-dev-05-storage",
  "facilities-dev-04-auth",
  "facilities-dev-03-compute",
  "facilities-dev-02-database",
  "facilities-dev-01-network"
]
```

---

## Shared Account デストロイ

### 重要: Service Account を先に削除

**必ず Service Account（全環境）を先に削除してください！**

理由:
- Service Account の `01-network` は Shared Account の Transit Gateway に Attachment している
- Transit Gateway に Attachment が残っていると、Shared Account の `2-network` が削除できない

### Step 1: Service Account が削除済みか確認

```bash
# Service Account でスタック確認
aws cloudformation list-stacks \
  --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
  --query 'StackSummaries[?starts_with(StackName, `facilities-`)].StackName'
```

**期待される出力**: 空（すべて削除済み）

### Step 2: デストロイスクリプト実行

```bash
cd infra/cloudformation/shared

# Shared Account デストロイ
./scripts/destroy-all.sh
```

### Step 3: 確認プロンプト

```
====================================
⚠️  DANGER: Shared Account Stack Deletion
====================================
Environment: prod
Project:     facilities

The following ORGANIZATION-LEVEL stacks will be DELETED:
  - facilities-shared-3-client-vpn-prod
  - facilities-shared-2-network-prod
  - facilities-shared-1-foundation-prod

This will affect:
  - Transit Gateway (ALL Service Accounts will lose connectivity)
  - CloudTrail, Config, GuardDuty, Security Hub (Organization-wide)
  - Direct Connect Gateway

This operation is IRREVERSIBLE!
====================================

Are you ABSOLUTELY sure? (type 'DELETE-SHARED' to confirm):
```

**重要**: `DELETE-SHARED` と正確に入力してください（大文字、ハイフン含む）。

### Step 4: デストロイ実行

```
====================================
Deleting: facilities-shared-3-client-vpn-prod
====================================
Waiting for stack deletion to complete...
✅ Stack deleted: facilities-shared-3-client-vpn-prod

====================================
Deleting: facilities-shared-2-network-prod
====================================
Waiting for stack deletion to complete...
✅ Stack deleted: facilities-shared-2-network-prod

====================================
Deleting: facilities-shared-1-foundation-prod
====================================
Waiting for stack deletion to complete...
✅ Stack deleted: facilities-shared-1-foundation-prod

====================================
✅ All Shared Account stacks deleted
====================================

⚠️  IMPORTANT: Check for retained resources:
  - S3 Audit Logs Bucket (DeletionPolicy: Retain)
  - CloudTrail Logs
  - CloudWatch Log Groups

These must be deleted manually if needed.
====================================
```

---

## 保持されるリソースの削除

### DeletionPolicy: Retain とは

CloudFormation テンプレートで `DeletionPolicy: Retain` が設定されているリソースは、スタック削除時に**自動削除されません**。

**対象リソース**:
- S3 バケット（監査ログ、アプリケーションデータ）
- RDS スナップショット
- CloudWatch Log Groups

### Service Account で保持されるリソース

#### 1. S3 バケット

```bash
# バケット一覧確認
aws s3 ls | grep facilities

# 期待される出力例:
# facilities-dev-app-data-897167645238
# facilities-dev-cloudfront-logs-897167645238
```

**削除手順**:
```bash
# バケット内のオブジェクトを削除
aws s3 rm s3://facilities-dev-app-data-897167645238 --recursive

# バケット削除
aws s3 rb s3://facilities-dev-app-data-897167645238

# CloudFront ログバケットも同様に削除
aws s3 rm s3://facilities-dev-cloudfront-logs-897167645238 --recursive
aws s3 rb s3://facilities-dev-cloudfront-logs-897167645238
```

#### 2. RDS スナップショット

```bash
# スナップショット一覧確認
aws rds describe-db-snapshots \
  --query 'DBSnapshots[?starts_with(DBSnapshotIdentifier, `facilities-dev-`)].DBSnapshotIdentifier'
```

**削除手順**:
```bash
# スナップショット削除
aws rds delete-db-snapshot \
  --db-snapshot-identifier facilities-dev-final-snapshot-20251026
```

#### 3. CloudWatch Log Groups

```bash
# ログ グループ一覧確認
aws logs describe-log-groups \
  --log-group-name-prefix /aws/ecs/facilities-dev
```

**削除手順**:
```bash
# ログ グループ削除
aws logs delete-log-group \
  --log-group-name /aws/ecs/facilities-dev/staff-api

aws logs delete-log-group \
  --log-group-name /aws/ecs/facilities-dev/vendor-api

aws logs delete-log-group \
  --log-group-name /aws/ecs/facilities-dev/batch
```

### Shared Account で保持されるリソース

#### 1. S3 監査ログバケット

```bash
# バケット確認
aws s3 ls | grep facilities-shared

# 期待される出力例:
# facilities-shared-audit-logs-897167645238
```

**削除手順**:
```bash
# バケット内のオブジェクトを削除
aws s3 rm s3://facilities-shared-audit-logs-897167645238 --recursive

# バケット削除
aws s3 rb s3://facilities-shared-audit-logs-897167645238
```

#### 2. CloudTrail ログ

CloudTrail S3バケットと同じ手順で削除。

---

## OIDC設定の削除

GitHub Actions OIDC 設定を完全に削除する場合。

### Step 1: GitHub Secret 削除

```bash
gh secret remove AWS_ROLE_ARN --repo k-tanaka-522/Sample-AWS-SubAgent
```

### Step 2: IAM Role から Policy をデタッチ

```bash
aws iam detach-role-policy \
  --role-name GitHubActionsDeployRole \
  --policy-arn arn:aws:iam::897167645238:policy/GitHubActionsDeployPolicy
```

### Step 3: IAM Role 削除

```bash
aws iam delete-role --role-name GitHubActionsDeployRole
```

### Step 4: IAM Policy 削除

```bash
aws iam delete-policy \
  --policy-arn arn:aws:iam::897167645238:policy/GitHubActionsDeployPolicy
```

### Step 5: OIDC Provider 削除

```bash
aws iam delete-open-id-connect-provider \
  --open-id-connect-provider-arn arn:aws:iam::897167645238:oidc-provider/token.actions.githubusercontent.com
```

### Step 6: 確認

```bash
# Role が削除されたことを確認
aws iam get-role --role-name GitHubActionsDeployRole
# 期待されるエラー: NoSuchEntity

# Policy が削除されたことを確認
aws iam get-policy --policy-arn arn:aws:iam::897167645238:policy/GitHubActionsDeployPolicy
# 期待されるエラー: NoSuchEntity

# OIDC Provider が削除されたことを確認
aws iam get-open-id-connect-provider \
  --open-id-connect-provider-arn arn:aws:iam::897167645238:oidc-provider/token.actions.githubusercontent.com
# 期待されるエラー: NoSuchEntity
```

---

## トラブルシューティング

### Error 1: Stack Deletion Failed

**エラー**:
```
❌ Failed to delete stack: facilities-dev-01-network

DELETE_FAILED: Resource [...] cannot be deleted (dependency exists)
```

**原因1**: 依存リソースが残っている
- 例: Transit Gateway Attachment が残っている状態で Transit Gateway を削除

**対処**:
```bash
# 依存リソースを手動で確認
aws cloudformation describe-stack-events \
  --stack-name facilities-dev-01-network \
  --max-items 10 \
  --query 'StackEvents[?ResourceStatus==`DELETE_FAILED`].[LogicalResourceId,ResourceStatusReason]' \
  --output table

# 依存リソースを先に削除
```

**原因2**: リソースが手動で削除されている

**対処**:
```bash
# スタックを強制削除
aws cloudformation delete-stack --stack-name facilities-dev-01-network

# または AWS Console で手動削除
```

### Error 2: S3 Bucket Not Empty

**エラー**:
```
DELETE_FAILED: The bucket you tried to delete is not empty (S3 Bucket)
```

**原因**: S3 バケットにオブジェクトが残っている

**対処**:
```bash
# バケット内のオブジェクトを削除
aws s3 rm s3://facilities-dev-app-data-897167645238 --recursive

# バージョニングが有効な場合は削除マーカーも削除
aws s3api delete-objects \
  --bucket facilities-dev-app-data-897167645238 \
  --delete "$(aws s3api list-object-versions \
      --bucket facilities-dev-app-data-897167645238 \
      --query '{Objects: Versions[].{Key:Key,VersionId:VersionId}}' \
      --output json)"

# バケット削除
aws s3 rb s3://facilities-dev-app-data-897167645238
```

### Error 3: Transit Gateway Attachment Still Exists

**エラー**:
```
DELETE_FAILED: Cannot delete Transit Gateway with active attachments
```

**原因**: Service Account の Transit Gateway Attachment が残っている

**対処**:
```bash
# 1. Service Account の 01-network スタックを削除
cd infra/cloudformation/service
./scripts/destroy-all.sh dev

# 2. Shared Account の 2-network スタックを削除
cd infra/cloudformation/shared
./scripts/destroy-all.sh
```

### Error 4: RDS Snapshot Already Exists

**エラー**:
```
Cannot create snapshot: facilities-dev-final-snapshot already exists
```

**原因**: 以前のデストロイ時に作成されたスナップショットが残っている

**対処**:
```bash
# 既存スナップショットを削除
aws rds delete-db-snapshot \
  --db-snapshot-identifier facilities-dev-final-snapshot

# または、スナップショット名を変更してスタック削除を再実行
```

### Error 5: CloudFormation Stack Does Not Exist

**エラー**:
```
⚠️  Stack does not exist: facilities-dev-06-monitoring
Skipping...
```

**原因**: スタックがすでに削除されている、またはデプロイされていない

**対処**: 問題なし。スクリプトが自動でスキップします。

---

## 完全削除チェックリスト

デストロイ完了後、以下を確認してください：

### CloudFormation スタック

```bash
# Service Account
aws cloudformation list-stacks \
  --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
  --query 'StackSummaries[?starts_with(StackName, `facilities-`)].StackName'

# 期待される出力: [] (空)
```

### S3 バケット

```bash
aws s3 ls | grep facilities

# 期待される出力: (空)
```

### RDS スナップショット

```bash
aws rds describe-db-snapshots \
  --query 'DBSnapshots[?starts_with(DBSnapshotIdentifier, `facilities-`)].DBSnapshotIdentifier'

# 期待される出力: [] (または保持したいスナップショットのみ)
```

### CloudWatch Log Groups

```bash
aws logs describe-log-groups \
  --log-group-name-prefix /aws/ecs/facilities

# 期待される出力: {"logGroups": []} (空)
```

### IAM Role / Policy

```bash
aws iam get-role --role-name GitHubActionsDeployRole
# 期待されるエラー: NoSuchEntity

aws iam get-policy --policy-arn arn:aws:iam::897167645238:policy/GitHubActionsDeployPolicy
# 期待されるエラー: NoSuchEntity
```

### OIDC Provider

```bash
aws iam get-open-id-connect-provider \
  --open-id-connect-provider-arn arn:aws:iam::897167645238:oidc-provider/token.actions.githubusercontent.com

# 期待されるエラー: NoSuchEntity
```

---

## 参考資料

- [CloudFormation: Deleting Stacks](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-cli-deleting-stack.html)
- [CloudFormation: DeletionPolicy Attribute](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-deletionpolicy.html)
- [S3: Empty Bucket](https://docs.aws.amazon.com/AmazonS3/latest/userguide/empty-bucket.html)

---

**作成者**: PM + SRE
**作成日**: 2025-10-26
