# ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤æ‰‹é †

## ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤é †åº](#ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤é †åº)
3. [Service Account ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤](#service-account-ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤)
4. [Shared Account ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤](#shared-account-ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤)
5. [ä¿æŒã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤](#ä¿æŒã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤)
6. [OIDCè¨­å®šã®å‰Šé™¤](#oidcè¨­å®šã®å‰Šé™¤)
7. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## æ¦‚è¦

### ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤ã¨ã¯

CloudFormation ã‚¹ã‚¿ãƒƒã‚¯ã¨ãã‚Œã«é–¢é€£ã™ã‚‹ã™ã¹ã¦ã®AWSãƒªã‚½ãƒ¼ã‚¹ã‚’**å®Œå…¨ã«å‰Šé™¤**ã™ã‚‹æ“ä½œã§ã™ã€‚

### é‡è¦ãªæ³¨æ„äº‹é …

âš ï¸ **ã“ã®æ“ä½œã¯ä¸å¯é€†ã§ã™ï¼**

- âœ… ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤å‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—
- âœ… RDS ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆ
- âœ… S3 ãƒã‚±ãƒƒãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- âœ… CloudWatch Logs ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
- âœ… æœ¬ç•ªç’°å¢ƒã®å ´åˆã¯é–¢ä¿‚è€…å…¨å“¡ã®æ‰¿èªã‚’å¾—ã‚‹

### ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤ãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹

- ğŸ§ª é–‹ç™ºç’°å¢ƒã®å®Œå…¨å‰Šé™¤ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
- ğŸ”„ ç’°å¢ƒã®å†æ§‹ç¯‰
- ğŸ§¹ ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- ğŸš€ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ‚äº†æ™‚ã®å¾Œå§‹æœ«

---

## ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤é †åº

### é‡è¦: ä¾å­˜é–¢ä¿‚ã®é€†é †

CloudFormation ã‚¹ã‚¿ãƒƒã‚¯ã¯**ä¾å­˜é–¢ä¿‚ã®é€†é †**ã§å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```
ã€å‰Šé™¤é †åºã€‘

1. Service Accountï¼ˆç’°å¢ƒåˆ¥ï¼‰
   â†“
   06-monitoringï¼ˆCloudWatch Alarms, SNS Topicsï¼‰
   â†“
   05-storageï¼ˆS3, CloudFrontï¼‰
   â†“
   04-authï¼ˆCognito User Poolsï¼‰
   â†“
   03-computeï¼ˆECS, ALB, Target Groupsï¼‰
   â†“
   02-databaseï¼ˆRDS, DB Subnet Groupï¼‰
   â†“
   01-networkï¼ˆVPC, Subnets, Transit Gateway Attachmentï¼‰

2. Shared Account
   â†“
   3-client-vpnï¼ˆClient VPN Endpointï¼‰
   â†“
   2-networkï¼ˆTransit Gateway, Direct Connectï¼‰â† Service Accountå‰Šé™¤å¾Œ
   â†“
   1-foundationï¼ˆCloudTrail, Config, GuardDuty, Security Hubï¼‰
```

**ç†ç”±**:
- `03-compute` (ALB) ã¯ `01-network` (Subnet) ã«ä¾å­˜
- `02-database` (RDS) ã¯ `01-network` (Subnet, SecurityGroup) ã«ä¾å­˜
- `01-network` (Transit Gateway Attachment) ã¯ Shared Account ã® `2-network` (Transit Gateway) ã«ä¾å­˜
- **Shared Account ã® Transit Gateway ã‚’å…ˆã«å‰Šé™¤ã™ã‚‹ã¨ã€Service Account ã® Transit Gateway Attachment å‰Šé™¤ã«å¤±æ•—**

---

## Service Account ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤

### å‰ææ¡ä»¶

- âœ… AWS CLI è¨­å®šæ¸ˆã¿
- âœ… Service Accountï¼ˆAWS Account ID: 897167645238ï¼‰ã«èªè¨¼æ¸ˆã¿
- âœ… CloudFormation ã‚¹ã‚¿ãƒƒã‚¯ãŒãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿

### Step 1: ç’°å¢ƒé¸æŠ

ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤ã™ã‚‹ç’°å¢ƒã‚’æ±ºå®šï¼š
- `dev` - é–‹ç™ºç’°å¢ƒ
- `stg` - ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
- `prod` - æœ¬ç•ªç’°å¢ƒ

### Step 2: ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ

```bash
cd infra/cloudformation/service

# é–‹ç™ºç’°å¢ƒã‚’ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤
./scripts/destroy-all.sh dev

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã‚’ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤
./scripts/destroy-all.sh stg

# æœ¬ç•ªç’°å¢ƒã‚’ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤ï¼ˆæ…é‡ã«ï¼ï¼‰
./scripts/destroy-all.sh prod
```

### Step 3: ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œæ™‚ã€ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```
====================================
âš ï¸  DANGER: CloudFormation Stack Deletion
====================================
Environment: dev
Project:     facilities

The following stacks will be DELETED:
  - facilities-dev-06-monitoring
  - facilities-dev-05-storage
  - facilities-dev-04-auth
  - facilities-dev-03-compute
  - facilities-dev-02-database
  - facilities-dev-01-network

This operation is IRREVERSIBLE!
====================================

Are you sure you want to DELETE all stacks? (type 'DELETE' to confirm):
```

**é‡è¦**: `DELETE` ã¨æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå¤§æ–‡å­—ï¼‰ã€‚

### Step 4: ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤å®Ÿè¡Œ

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã‚’è‡ªå‹•å®Ÿè¡Œã—ã¾ã™ï¼š

```
====================================
Deleting: facilities-dev-06-monitoring
====================================
Waiting for stack deletion to complete...
âœ… Stack deleted: facilities-dev-06-monitoring

====================================
Deleting: facilities-dev-05-storage
====================================
Waiting for stack deletion to complete...
âœ… Stack deleted: facilities-dev-05-storage

...ï¼ˆä»¥ä¸‹ã€01-network ã¾ã§ç¶šãï¼‰

====================================
âœ… All stacks deleted successfully
====================================

Note: Some resources may have DeletionPolicy: Retain
Check AWS Console for retained resources:
  - S3 Buckets
  - CloudWatch Log Groups
  - RDS Snapshots
====================================
```

### Step 5: å®Œäº†ç¢ºèª

```bash
# ã‚¹ã‚¿ãƒƒã‚¯ãŒå‰Šé™¤ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
aws cloudformation list-stacks \
  --stack-status-filter DELETE_COMPLETE \
  --query 'StackSummaries[?starts_with(StackName, `facilities-dev-`)].StackName'
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›**:
```json
[
  "facilities-dev-06-monitoring",
  "facilities-dev-05-storage",
  "facilities-dev-04-auth",
  "facilities-dev-03-compute",
  "facilities-dev-02-database",
  "facilities-dev-01-network"
]
```

---

## Shared Account ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤

### é‡è¦: Service Account ã‚’å…ˆã«å‰Šé™¤

**å¿…ãš Service Accountï¼ˆå…¨ç’°å¢ƒï¼‰ã‚’å…ˆã«å‰Šé™¤ã—ã¦ãã ã•ã„ï¼**

ç†ç”±:
- Service Account ã® `01-network` ã¯ Shared Account ã® Transit Gateway ã« Attachment ã—ã¦ã„ã‚‹
- Transit Gateway ã« Attachment ãŒæ®‹ã£ã¦ã„ã‚‹ã¨ã€Shared Account ã® `2-network` ãŒå‰Šé™¤ã§ããªã„

### Step 1: Service Account ãŒå‰Šé™¤æ¸ˆã¿ã‹ç¢ºèª

```bash
# Service Account ã§ã‚¹ã‚¿ãƒƒã‚¯ç¢ºèª
aws cloudformation list-stacks \
  --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
  --query 'StackSummaries[?starts_with(StackName, `facilities-`)].StackName'
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›**: ç©ºï¼ˆã™ã¹ã¦å‰Šé™¤æ¸ˆã¿ï¼‰

### Step 2: ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ

```bash
cd infra/cloudformation/shared

# Shared Account ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤
./scripts/destroy-all.sh
```

### Step 3: ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

```
====================================
âš ï¸  DANGER: Shared Account Stack Deletion
====================================
Environment: prod
Project:     facilities

The following ORGANIZATION-LEVEL stacks will be DELETED:
  - facilities-shared-3-client-vpn-prod
  - facilities-shared-2-network-prod
  - facilities-shared-1-foundation-prod

This will affect:
  - Transit Gateway (ALL Service Accounts will lose connectivity)
  - CloudTrail, Config, GuardDuty, Security Hub (Organization-wide)
  - Direct Connect Gateway

This operation is IRREVERSIBLE!
====================================

Are you ABSOLUTELY sure? (type 'DELETE-SHARED' to confirm):
```

**é‡è¦**: `DELETE-SHARED` ã¨æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå¤§æ–‡å­—ã€ãƒã‚¤ãƒ•ãƒ³å«ã‚€ï¼‰ã€‚

### Step 4: ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤å®Ÿè¡Œ

```
====================================
Deleting: facilities-shared-3-client-vpn-prod
====================================
Waiting for stack deletion to complete...
âœ… Stack deleted: facilities-shared-3-client-vpn-prod

====================================
Deleting: facilities-shared-2-network-prod
====================================
Waiting for stack deletion to complete...
âœ… Stack deleted: facilities-shared-2-network-prod

====================================
Deleting: facilities-shared-1-foundation-prod
====================================
Waiting for stack deletion to complete...
âœ… Stack deleted: facilities-shared-1-foundation-prod

====================================
âœ… All Shared Account stacks deleted
====================================

âš ï¸  IMPORTANT: Check for retained resources:
  - S3 Audit Logs Bucket (DeletionPolicy: Retain)
  - CloudTrail Logs
  - CloudWatch Log Groups

These must be deleted manually if needed.
====================================
```

---

## ä¿æŒã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤

### DeletionPolicy: Retain ã¨ã¯

CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ `DeletionPolicy: Retain` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤æ™‚ã«**è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã›ã‚“**ã€‚

**å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹**:
- S3 ãƒã‚±ãƒƒãƒˆï¼ˆç›£æŸ»ãƒ­ã‚°ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ï¼‰
- RDS ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
- CloudWatch Log Groups

### Service Account ã§ä¿æŒã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹

#### 1. S3 ãƒã‚±ãƒƒãƒˆ

```bash
# ãƒã‚±ãƒƒãƒˆä¸€è¦§ç¢ºèª
aws s3 ls | grep facilities

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹:
# facilities-dev-app-data-897167645238
# facilities-dev-cloudfront-logs-897167645238
```

**å‰Šé™¤æ‰‹é †**:
```bash
# ãƒã‚±ãƒƒãƒˆå†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤
aws s3 rm s3://facilities-dev-app-data-897167645238 --recursive

# ãƒã‚±ãƒƒãƒˆå‰Šé™¤
aws s3 rb s3://facilities-dev-app-data-897167645238

# CloudFront ãƒ­ã‚°ãƒã‚±ãƒƒãƒˆã‚‚åŒæ§˜ã«å‰Šé™¤
aws s3 rm s3://facilities-dev-cloudfront-logs-897167645238 --recursive
aws s3 rb s3://facilities-dev-cloudfront-logs-897167645238
```

#### 2. RDS ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ

```bash
# ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¸€è¦§ç¢ºèª
aws rds describe-db-snapshots \
  --query 'DBSnapshots[?starts_with(DBSnapshotIdentifier, `facilities-dev-`)].DBSnapshotIdentifier'
```

**å‰Šé™¤æ‰‹é †**:
```bash
# ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå‰Šé™¤
aws rds delete-db-snapshot \
  --db-snapshot-identifier facilities-dev-final-snapshot-20251026
```

#### 3. CloudWatch Log Groups

```bash
# ãƒ­ã‚° ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ç¢ºèª
aws logs describe-log-groups \
  --log-group-name-prefix /aws/ecs/facilities-dev
```

**å‰Šé™¤æ‰‹é †**:
```bash
# ãƒ­ã‚° ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤
aws logs delete-log-group \
  --log-group-name /aws/ecs/facilities-dev/staff-api

aws logs delete-log-group \
  --log-group-name /aws/ecs/facilities-dev/vendor-api

aws logs delete-log-group \
  --log-group-name /aws/ecs/facilities-dev/batch
```

### Shared Account ã§ä¿æŒã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹

#### 1. S3 ç›£æŸ»ãƒ­ã‚°ãƒã‚±ãƒƒãƒˆ

```bash
# ãƒã‚±ãƒƒãƒˆç¢ºèª
aws s3 ls | grep facilities-shared

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹:
# facilities-shared-audit-logs-897167645238
```

**å‰Šé™¤æ‰‹é †**:
```bash
# ãƒã‚±ãƒƒãƒˆå†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤
aws s3 rm s3://facilities-shared-audit-logs-897167645238 --recursive

# ãƒã‚±ãƒƒãƒˆå‰Šé™¤
aws s3 rb s3://facilities-shared-audit-logs-897167645238
```

#### 2. CloudTrail ãƒ­ã‚°

CloudTrail S3ãƒã‚±ãƒƒãƒˆã¨åŒã˜æ‰‹é †ã§å‰Šé™¤ã€‚

---

## OIDCè¨­å®šã®å‰Šé™¤

GitHub Actions OIDC è¨­å®šã‚’å®Œå…¨ã«å‰Šé™¤ã™ã‚‹å ´åˆã€‚

### Step 1: GitHub Secret å‰Šé™¤

```bash
gh secret remove AWS_ROLE_ARN --repo k-tanaka-522/Sample-AWS-SubAgent
```

### Step 2: IAM Role ã‹ã‚‰ Policy ã‚’ãƒ‡ã‚¿ãƒƒãƒ

```bash
aws iam detach-role-policy \
  --role-name GitHubActionsDeployRole \
  --policy-arn arn:aws:iam::897167645238:policy/GitHubActionsDeployPolicy
```

### Step 3: IAM Role å‰Šé™¤

```bash
aws iam delete-role --role-name GitHubActionsDeployRole
```

### Step 4: IAM Policy å‰Šé™¤

```bash
aws iam delete-policy \
  --policy-arn arn:aws:iam::897167645238:policy/GitHubActionsDeployPolicy
```

### Step 5: OIDC Provider å‰Šé™¤

```bash
aws iam delete-open-id-connect-provider \
  --open-id-connect-provider-arn arn:aws:iam::897167645238:oidc-provider/token.actions.githubusercontent.com
```

### Step 6: ç¢ºèª

```bash
# Role ãŒå‰Šé™¤ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
aws iam get-role --role-name GitHubActionsDeployRole
# æœŸå¾…ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼: NoSuchEntity

# Policy ãŒå‰Šé™¤ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
aws iam get-policy --policy-arn arn:aws:iam::897167645238:policy/GitHubActionsDeployPolicy
# æœŸå¾…ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼: NoSuchEntity

# OIDC Provider ãŒå‰Šé™¤ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
aws iam get-open-id-connect-provider \
  --open-id-connect-provider-arn arn:aws:iam::897167645238:oidc-provider/token.actions.githubusercontent.com
# æœŸå¾…ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼: NoSuchEntity
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Error 1: Stack Deletion Failed

**ã‚¨ãƒ©ãƒ¼**:
```
âŒ Failed to delete stack: facilities-dev-01-network

DELETE_FAILED: Resource [...] cannot be deleted (dependency exists)
```

**åŸå› 1**: ä¾å­˜ãƒªã‚½ãƒ¼ã‚¹ãŒæ®‹ã£ã¦ã„ã‚‹
- ä¾‹: Transit Gateway Attachment ãŒæ®‹ã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ Transit Gateway ã‚’å‰Šé™¤

**å¯¾å‡¦**:
```bash
# ä¾å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚’æ‰‹å‹•ã§ç¢ºèª
aws cloudformation describe-stack-events \
  --stack-name facilities-dev-01-network \
  --max-items 10 \
  --query 'StackEvents[?ResourceStatus==`DELETE_FAILED`].[LogicalResourceId,ResourceStatusReason]' \
  --output table

# ä¾å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚’å…ˆã«å‰Šé™¤
```

**åŸå› 2**: ãƒªã‚½ãƒ¼ã‚¹ãŒæ‰‹å‹•ã§å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹

**å¯¾å‡¦**:
```bash
# ã‚¹ã‚¿ãƒƒã‚¯ã‚’å¼·åˆ¶å‰Šé™¤
aws cloudformation delete-stack --stack-name facilities-dev-01-network

# ã¾ãŸã¯ AWS Console ã§æ‰‹å‹•å‰Šé™¤
```

### Error 2: S3 Bucket Not Empty

**ã‚¨ãƒ©ãƒ¼**:
```
DELETE_FAILED: The bucket you tried to delete is not empty (S3 Bucket)
```

**åŸå› **: S3 ãƒã‚±ãƒƒãƒˆã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ®‹ã£ã¦ã„ã‚‹

**å¯¾å‡¦**:
```bash
# ãƒã‚±ãƒƒãƒˆå†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤
aws s3 rm s3://facilities-dev-app-data-897167645238 --recursive

# ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãŒæœ‰åŠ¹ãªå ´åˆã¯å‰Šé™¤ãƒãƒ¼ã‚«ãƒ¼ã‚‚å‰Šé™¤
aws s3api delete-objects \
  --bucket facilities-dev-app-data-897167645238 \
  --delete "$(aws s3api list-object-versions \
      --bucket facilities-dev-app-data-897167645238 \
      --query '{Objects: Versions[].{Key:Key,VersionId:VersionId}}' \
      --output json)"

# ãƒã‚±ãƒƒãƒˆå‰Šé™¤
aws s3 rb s3://facilities-dev-app-data-897167645238
```

### Error 3: Transit Gateway Attachment Still Exists

**ã‚¨ãƒ©ãƒ¼**:
```
DELETE_FAILED: Cannot delete Transit Gateway with active attachments
```

**åŸå› **: Service Account ã® Transit Gateway Attachment ãŒæ®‹ã£ã¦ã„ã‚‹

**å¯¾å‡¦**:
```bash
# 1. Service Account ã® 01-network ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‰Šé™¤
cd infra/cloudformation/service
./scripts/destroy-all.sh dev

# 2. Shared Account ã® 2-network ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‰Šé™¤
cd infra/cloudformation/shared
./scripts/destroy-all.sh
```

### Error 4: RDS Snapshot Already Exists

**ã‚¨ãƒ©ãƒ¼**:
```
Cannot create snapshot: facilities-dev-final-snapshot already exists
```

**åŸå› **: ä»¥å‰ã®ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤æ™‚ã«ä½œæˆã•ã‚ŒãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒæ®‹ã£ã¦ã„ã‚‹

**å¯¾å‡¦**:
```bash
# æ—¢å­˜ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å‰Šé™¤
aws rds delete-db-snapshot \
  --db-snapshot-identifier facilities-dev-final-snapshot

# ã¾ãŸã¯ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåã‚’å¤‰æ›´ã—ã¦ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤ã‚’å†å®Ÿè¡Œ
```

### Error 5: CloudFormation Stack Does Not Exist

**ã‚¨ãƒ©ãƒ¼**:
```
âš ï¸  Stack does not exist: facilities-dev-06-monitoring
Skipping...
```

**åŸå› **: ã‚¹ã‚¿ãƒƒã‚¯ãŒã™ã§ã«å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã€ã¾ãŸã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ãªã„

**å¯¾å‡¦**: å•é¡Œãªã—ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè‡ªå‹•ã§ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚

---

## å®Œå…¨å‰Šé™¤ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤å®Œäº†å¾Œã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

### CloudFormation ã‚¹ã‚¿ãƒƒã‚¯

```bash
# Service Account
aws cloudformation list-stacks \
  --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
  --query 'StackSummaries[?starts_with(StackName, `facilities-`)].StackName'

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›: [] (ç©º)
```

### S3 ãƒã‚±ãƒƒãƒˆ

```bash
aws s3 ls | grep facilities

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›: (ç©º)
```

### RDS ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ

```bash
aws rds describe-db-snapshots \
  --query 'DBSnapshots[?starts_with(DBSnapshotIdentifier, `facilities-`)].DBSnapshotIdentifier'

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›: [] (ã¾ãŸã¯ä¿æŒã—ãŸã„ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®ã¿)
```

### CloudWatch Log Groups

```bash
aws logs describe-log-groups \
  --log-group-name-prefix /aws/ecs/facilities

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›: {"logGroups": []} (ç©º)
```

### IAM Role / Policy

```bash
aws iam get-role --role-name GitHubActionsDeployRole
# æœŸå¾…ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼: NoSuchEntity

aws iam get-policy --policy-arn arn:aws:iam::897167645238:policy/GitHubActionsDeployPolicy
# æœŸå¾…ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼: NoSuchEntity
```

### OIDC Provider

```bash
aws iam get-open-id-connect-provider \
  --open-id-connect-provider-arn arn:aws:iam::897167645238:oidc-provider/token.actions.githubusercontent.com

# æœŸå¾…ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼: NoSuchEntity
```

---

## å‚è€ƒè³‡æ–™

- [CloudFormation: Deleting Stacks](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-cli-deleting-stack.html)
- [CloudFormation: DeletionPolicy Attribute](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-deletionpolicy.html)
- [S3: Empty Bucket](https://docs.aws.amazon.com/AmazonS3/latest/userguide/empty-bucket.html)

---

**ä½œæˆè€…**: PM + SRE
**ä½œæˆæ—¥**: 2025-10-26
