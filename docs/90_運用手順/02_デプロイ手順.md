# デプロイ手順

## 目次

1. [通常デプロイ（CICD経由）](#通常デプロイcicd経由)
2. [緊急デプロイ（CLI手動実行）](#緊急デプロイcli手動実行)
3. [ロールバック](#ロールバック)
4. [デプロイ順序](#デプロイ順序)

---

## 通常デプロイ（CICD経由）

### フロー概要

```
ブランチ作成 → コード変更 → PR作成 → Change Set確認 → 承認 → マージ → 自動デプロイ
```

### Step 1: ブランチ作成

```bash
# 機能追加の場合
git checkout -b feature/add-monitoring-alerts

# バグ修正の場合
git checkout -b fix/rds-connection-timeout

# リファクタリングの場合
git checkout -b refactor/simplify-ecs-task-definition
```

### Step 2: コード変更

```bash
# CloudFormation テンプレート修正
vim infra/cloudformation/service/templates/monitoring/cloudwatch-alarms.yaml

# パラメーター修正（必要に応じて）
vim infra/cloudformation/service/parameters/dev.json
```

### Step 3: コミット・プッシュ

```bash
git add infra/cloudformation/service/
git commit -m "feat: Add RDS connection timeout alarm"
git push origin feature/add-monitoring-alerts
```

### Step 4: PR作成

```bash
# GitHub CLI で PR作成
gh pr create \
  --title "feat: Add RDS connection timeout alarm" \
  --body "## Changes
- Add CloudWatch Alarm for RDS connection timeout
- Threshold: > 100 connections for 5 minutes
- SNS notification to dev-team@example.com

## Checklist
- [x] テンプレート検証済み
- [x] パラメーター設定済み
- [ ] レビュー完了
- [ ] Change Set 確認完了"
```

### Step 5: GitHub Actions 実行（自動）

**preview ジョブが自動実行**:

1. ✅ AWS OIDC認証
2. ✅ 全スタックで Change Set 作成
3. ✅ 差分をPRコメントに投稿

**PRコメント例**:
```
### CloudFormation Change Preview

**01-network**: ⚠️ No changes
**02-database**: ⚠️ No changes
**03-compute**: ⚠️ No changes
**04-auth**: ⚠️ No changes
**05-storage**: ⚠️ No changes
**06-monitoring**: ✅ Changes detected

| Action | ResourceId | ResourceType | Replacement |
|--------|-----------|--------------|-------------|
| Add    | RDSConnectionAlarm | AWS::CloudWatch::Alarm | N/A |

---
**Change Set Name**: pr-123-20251026-123456
**Environment**: dev

⚠️ These Change Sets are **NOT executed**. They will be executed after merge.
```

### Step 6: レビュー・承認

**レビュアーが確認**:
1. Change Set の差分を確認
2. コードレビュー
3. Approve（承認）

**Branch Protection により以下が必須**:
- ✅ Status Check: preview ジョブ成功
- ✅ 1人以上の承認

### Step 7: マージ

```bash
# Squash and merge（推奨）
gh pr merge --squash

# または Web UI でマージ
```

### Step 8: GitHub Actions 実行（自動）

**deploy ジョブが自動実行**:

1. ✅ AWS OIDC認証
2. ✅ 全スタックを順次デプロイ
   - Change Set 作成
   - Change Set 実行
   - 変更がないスタックはスキップ
3. ✅ デプロイ完了

**デプロイログ例**:
```
====================================
Deploying: 01-network
====================================
⚠️ No changes detected. Skipping...

====================================
Deploying: 06-monitoring
====================================
Step 1: Validating template...
✅ Template is valid

Step 2: Filtering parameters...
✅ Parameters filtered (3 parameters)

Step 3: Creating Change Set...
✅ Change Set created

Step 4: Reviewing changes (dry-run)...
| Action | ResourceId | ResourceType |
|--------|-----------|--------------|
| Add    | RDSConnectionAlarm | AWS::CloudWatch::Alarm |

Step 7: Executing Change Set...
✅ Deployment completed successfully
```

---

## 緊急デプロイ（CLI手動実行）

### いつ使うか

- 🚨 緊急障害対応が必要な場合
- ⏰ 即座に復旧が必要な場合
- 🔥 PRレビューを待てない場合

### フロー概要

```
緊急対応 → CLI実行（即座にデプロイ） → コードに反映 → PR作成 → マージ
```

### Step 1: 緊急対応

```bash
# 問題発生（例: RDS接続エラー）
# SecurityGroup のポート設定ミスを発見
```

### Step 2: コード修正

```bash
vim infra/cloudformation/service/templates/network/security-groups.yaml

# 修正内容:
# - FromPort: 3306 → 5432（PostgreSQL）
# - ToPort: 3306 → 5432
```

### Step 3: CLI で即座にデプロイ

```bash
cd infra/cloudformation/service

# 本番環境の場合は注意！
./scripts/deploy.sh prod 01-network
```

**実行例**:
```
====================================
CloudFormation Deploy (Service Account)
====================================
Environment: prod
Stack:       facilities-prod-01-network
====================================

Step 1: Validating template...
✅ Template is valid

Step 2: Filtering parameters...
✅ Parameters filtered (7 parameters)

Step 3: Creating Change Set...
✅ Change Set created

Step 4: Reviewing changes (dry-run)...
| Action | ResourceId | ResourceType | Replacement |
|--------|-----------|--------------|-------------|
| Modify | RDSSecurityGroup | AWS::EC2::SecurityGroup | False |

⚠️  Execute Change Set on PRODUCTION? (yes/no): yes

Step 7: Executing Change Set...
✅ Deployment completed successfully

Time: 5分
```

### Step 4: コードに反映（Drift解消）

```bash
# 手動実行したコードをGitに反映
git checkout -b hotfix/security-group-port
git add infra/cloudformation/service/templates/network/security-groups.yaml
git commit -m "hotfix: Fix RDS SecurityGroup port (3306→5432)

緊急対応として手動デプロイ済み（2025-10-26 12:34）
Incident: RDS接続エラー
Cause: SecurityGroup ポート設定ミス
Fix: Port 3306 → 5432 に修正
Deploy: facilities-prod-01-network"

git push origin hotfix/security-group-port
```

### Step 5: PR作成 → マージ

```bash
gh pr create \
  --title "hotfix: RDS SecurityGroup port修正" \
  --body "## 緊急対応

**Incident**: RDS接続エラー
**手動デプロイ済み**: 2025-10-26 12:34
**環境**: prod

## 変更内容
- SecurityGroup ポート修正（3306 → 5432）

## 期待される動作
GitHub Actions 実行時に Change Set: \"No changes\"
（すでに手動で適用済みのため）"
```

**GitHub Actions 実行結果**:
```
====================================
Deploying: 01-network
====================================
⚠️ No changes detected. Skipping...
```

✅ IaCとAWS実態が一致

---

## ロールバック

### いつ使うか

- ❌ デプロイ後に問題が発生した場合
- 🔙 前回の安定した状態に戻したい場合

### 方法1: CloudFormation スタック ロールバック

```bash
cd infra/cloudformation/service

# ロールバック実行
./scripts/rollback.sh prod 03-compute
```

**実行例**:
```
====================================
CloudFormation Stack Rollback
====================================
Environment: prod
Stack:       facilities-prod-03-compute
====================================

⚠️  警告: この操作は前回の安定した状態にロールバックします

本当に実行しますか？ (yes/no): yes

Initiating rollback...
Waiting for rollback to complete...

✅ Rollback completed successfully
====================================
Stack:  facilities-prod-03-compute
Status: UPDATE_ROLLBACK_COMPLETE
====================================
```

### 方法2: Git Revert + 再デプロイ

```bash
# 1. 問題のあるコミットをrevert
git revert HEAD
git push origin main

# 2. GitHub Actions が自動的にrevert内容をデプロイ
# → 前回の安定した状態に戻る
```

### 方法3: 手動で前回のChange Setを実行

```bash
# 1. 前回のChange Setを確認
aws cloudformation list-change-sets \
  --stack-name facilities-prod-03-compute

# 2. 前回のChange Setを実行
aws cloudformation execute-change-set \
  --stack-name facilities-prod-03-compute \
  --change-set-name facilities-prod-03-compute-20251026-120000
```

---

## デプロイ順序

### Service Account（依存関係順）

```
1. 01-network（VPC, Subnets, SecurityGroups）
   ↓
2. 02-database（RDS）
   ↓
3. 03-compute（ECS, ALB）
   ↓
4. 04-auth（Cognito）
   ↓
5. 05-storage（S3, CloudFront）
   ↓
6. 06-monitoring（CloudWatch）
```

**一括デプロイ**:
```bash
cd infra/cloudformation/service
./scripts/deploy-all.sh dev  # 依存関係順に自動デプロイ
```

**個別デプロイ**:
```bash
# 順序を守る必要あり
./scripts/deploy.sh dev 01-network
./scripts/deploy.sh dev 02-database
./scripts/deploy.sh dev 03-compute
./scripts/deploy.sh dev 04-auth
./scripts/deploy.sh dev 05-storage
./scripts/deploy.sh dev 06-monitoring
```

### Shared Account（依存関係順）

```
1. 2-network（Transit Gateway）← Service Account の前提
   ↓
2. 1-foundation（CloudTrail, Config等）← オプション
   ↓
3. 3-client-vpn（Client VPN）← オプション
```

**重要**: Service Account をデプロイする前に、Shared Account の Transit Gateway を先にデプロイする必要があります。

---

## デプロイスクリプト詳細

### deploy.sh

**Usage**:
```bash
./scripts/deploy.sh <environment> <stack-type>
```

**例**:
```bash
./scripts/deploy.sh dev 01-network
./scripts/deploy.sh prod 03-compute
```

**オプション: DRY_RUN モード**:
```bash
# Change Set 作成のみ（実行しない）
DRY_RUN=true ./scripts/deploy.sh dev 01-network
```

### deploy-all.sh

**Usage**:
```bash
./scripts/deploy-all.sh <environment>
```

**例**:
```bash
./scripts/deploy-all.sh dev   # dev環境の全スタックデプロイ
./scripts/deploy-all.sh prod  # prod環境の全スタックデプロイ
```

**特徴**:
- 依存関係順に自動デプロイ
- 変更がないスタックは自動スキップ
- エラーが発生したら即座に停止

---

## トラブルシューティング

### デプロイ失敗: Change Set作成エラー

**エラー**:
```
An error occurred (ValidationError) when calling the CreateChangeSet operation
```

**原因**:
- テンプレート文法エラー
- パラメーター不足

**対処**:
```bash
# 1. テンプレート検証
aws cloudformation validate-template \
  --template-body file://stacks/01-network/stack.yaml

# 2. パラメーター確認
cat parameters/dev.json | jq
```

### デプロイ失敗: リソース作成エラー

**エラー**:
```
Resource [XXX] failed to create
```

**原因**:
- リソース制限（例: EIP上限）
- 依存リソース不足

**対処**:
```bash
# 1. スタックイベント確認
aws cloudformation describe-stack-events \
  --stack-name facilities-dev-01-network \
  --max-items 10

# 2. エラー詳細確認
aws cloudformation describe-stack-events \
  --stack-name facilities-dev-01-network \
  --query 'StackEvents[?ResourceStatus==`CREATE_FAILED`]'
```

### ロールバック失敗

**エラー**:
```
Stack cannot be rolled back
```

**原因**:
- リソースが手動削除されている
- リソースに外部依存がある

**対処**:
```bash
# 1. スタック削除（最後の手段）
aws cloudformation delete-stack \
  --stack-name facilities-dev-01-network

# 2. 再デプロイ
./scripts/deploy.sh dev 01-network
```

---

## 参考資料

- [CloudFormation デプロイ](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-cli-creating-stack.html)
- [Change Sets](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-changesets.html)
- [GitHub Actions](https://docs.github.com/en/actions)

---

**作成者**: PM + SRE
**作成日**: 2025-10-26
