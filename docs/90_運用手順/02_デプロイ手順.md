# ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

## ç›®æ¬¡

1. [é€šå¸¸ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆCICDçµŒç”±ï¼‰](#é€šå¸¸ãƒ‡ãƒ—ãƒ­ã‚¤cicdçµŒç”±)
2. [ç·Šæ€¥ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆCLIæ‰‹å‹•å®Ÿè¡Œï¼‰](#ç·Šæ€¥ãƒ‡ãƒ—ãƒ­ã‚¤cliæ‰‹å‹•å®Ÿè¡Œ)
3. [ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯](#ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯)
4. [ãƒ‡ãƒ—ãƒ­ã‚¤é †åº](#ãƒ‡ãƒ—ãƒ­ã‚¤é †åº)

---

## é€šå¸¸ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆCICDçµŒç”±ï¼‰

### ãƒ•ãƒ­ãƒ¼æ¦‚è¦

```
ãƒ–ãƒ©ãƒ³ãƒä½œæˆ â†’ ã‚³ãƒ¼ãƒ‰å¤‰æ›´ â†’ PRä½œæˆ â†’ Change Setç¢ºèª â†’ æ‰¿èª â†’ ãƒãƒ¼ã‚¸ â†’ è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
```

### Step 1: ãƒ–ãƒ©ãƒ³ãƒä½œæˆ

```bash
# æ©Ÿèƒ½è¿½åŠ ã®å ´åˆ
git checkout -b feature/add-monitoring-alerts

# ãƒã‚°ä¿®æ­£ã®å ´åˆ
git checkout -b fix/rds-connection-timeout

# ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®å ´åˆ
git checkout -b refactor/simplify-ecs-task-definition
```

### Step 2: ã‚³ãƒ¼ãƒ‰å¤‰æ›´

```bash
# CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿®æ­£
vim infra/cloudformation/service/templates/monitoring/cloudwatch-alarms.yaml

# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ä¿®æ­£ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
vim infra/cloudformation/service/parameters/dev.json
```

### Step 3: ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥

```bash
git add infra/cloudformation/service/
git commit -m "feat: Add RDS connection timeout alarm"
git push origin feature/add-monitoring-alerts
```

### Step 4: PRä½œæˆ

```bash
# GitHub CLI ã§ PRä½œæˆ
gh pr create \
  --title "feat: Add RDS connection timeout alarm" \
  --body "## Changes
- Add CloudWatch Alarm for RDS connection timeout
- Threshold: > 100 connections for 5 minutes
- SNS notification to dev-team@example.com

## Checklist
- [x] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼æ¸ˆã¿
- [x] ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼è¨­å®šæ¸ˆã¿
- [ ] ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†
- [ ] Change Set ç¢ºèªå®Œäº†"
```

### Step 5: GitHub Actions å®Ÿè¡Œï¼ˆè‡ªå‹•ï¼‰

**preview ã‚¸ãƒ§ãƒ–ãŒè‡ªå‹•å®Ÿè¡Œ**:

1. âœ… AWS OIDCèªè¨¼
2. âœ… å…¨ã‚¹ã‚¿ãƒƒã‚¯ã§ Change Set ä½œæˆ
3. âœ… å·®åˆ†ã‚’PRã‚³ãƒ¡ãƒ³ãƒˆã«æŠ•ç¨¿

**PRã‚³ãƒ¡ãƒ³ãƒˆä¾‹**:
```
### CloudFormation Change Preview

**01-network**: âš ï¸ No changes
**02-database**: âš ï¸ No changes
**03-compute**: âš ï¸ No changes
**04-auth**: âš ï¸ No changes
**05-storage**: âš ï¸ No changes
**06-monitoring**: âœ… Changes detected

| Action | ResourceId | ResourceType | Replacement |
|--------|-----------|--------------|-------------|
| Add    | RDSConnectionAlarm | AWS::CloudWatch::Alarm | N/A |

---
**Change Set Name**: pr-123-20251026-123456
**Environment**: dev

âš ï¸ These Change Sets are **NOT executed**. They will be executed after merge.
```

### Step 6: ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ‰¿èª

**ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒç¢ºèª**:
1. Change Set ã®å·®åˆ†ã‚’ç¢ºèª
2. ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
3. Approveï¼ˆæ‰¿èªï¼‰

**Branch Protection ã«ã‚ˆã‚Šä»¥ä¸‹ãŒå¿…é ˆ**:
- âœ… Status Check: preview ã‚¸ãƒ§ãƒ–æˆåŠŸ
- âœ… 1äººä»¥ä¸Šã®æ‰¿èª

### Step 7: ãƒãƒ¼ã‚¸

```bash
# Squash and mergeï¼ˆæ¨å¥¨ï¼‰
gh pr merge --squash

# ã¾ãŸã¯ Web UI ã§ãƒãƒ¼ã‚¸
```

### Step 8: GitHub Actions å®Ÿè¡Œï¼ˆè‡ªå‹•ï¼‰

**deploy ã‚¸ãƒ§ãƒ–ãŒè‡ªå‹•å®Ÿè¡Œ**:

1. âœ… AWS OIDCèªè¨¼
2. âœ… å…¨ã‚¹ã‚¿ãƒƒã‚¯ã‚’é †æ¬¡ãƒ‡ãƒ—ãƒ­ã‚¤
   - Change Set ä½œæˆ
   - Change Set å®Ÿè¡Œ
   - å¤‰æ›´ãŒãªã„ã‚¹ã‚¿ãƒƒã‚¯ã¯ã‚¹ã‚­ãƒƒãƒ—
3. âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†

**ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚°ä¾‹**:
```
====================================
Deploying: 01-network
====================================
âš ï¸ No changes detected. Skipping...

====================================
Deploying: 06-monitoring
====================================
Step 1: Validating template...
âœ… Template is valid

Step 2: Filtering parameters...
âœ… Parameters filtered (3 parameters)

Step 3: Creating Change Set...
âœ… Change Set created

Step 4: Reviewing changes (dry-run)...
| Action | ResourceId | ResourceType |
|--------|-----------|--------------|
| Add    | RDSConnectionAlarm | AWS::CloudWatch::Alarm |

Step 7: Executing Change Set...
âœ… Deployment completed successfully
```

---

## ç·Šæ€¥ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆCLIæ‰‹å‹•å®Ÿè¡Œï¼‰

### ã„ã¤ä½¿ã†ã‹

- ğŸš¨ ç·Šæ€¥éšœå®³å¯¾å¿œãŒå¿…è¦ãªå ´åˆ
- â° å³åº§ã«å¾©æ—§ãŒå¿…è¦ãªå ´åˆ
- ğŸ”¥ PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¾…ã¦ãªã„å ´åˆ

### ãƒ•ãƒ­ãƒ¼æ¦‚è¦

```
ç·Šæ€¥å¯¾å¿œ â†’ CLIå®Ÿè¡Œï¼ˆå³åº§ã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰ â†’ ã‚³ãƒ¼ãƒ‰ã«åæ˜  â†’ PRä½œæˆ â†’ ãƒãƒ¼ã‚¸
```

### Step 1: ç·Šæ€¥å¯¾å¿œ

```bash
# å•é¡Œç™ºç”Ÿï¼ˆä¾‹: RDSæ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼‰
# SecurityGroup ã®ãƒãƒ¼ãƒˆè¨­å®šãƒŸã‚¹ã‚’ç™ºè¦‹
```

### Step 2: ã‚³ãƒ¼ãƒ‰ä¿®æ­£

```bash
vim infra/cloudformation/service/templates/network/security-groups.yaml

# ä¿®æ­£å†…å®¹:
# - FromPort: 3306 â†’ 5432ï¼ˆPostgreSQLï¼‰
# - ToPort: 3306 â†’ 5432
```

### Step 3: CLI ã§å³åº§ã«ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
cd infra/cloudformation/service

# æœ¬ç•ªç’°å¢ƒã®å ´åˆã¯æ³¨æ„ï¼
./scripts/deploy.sh prod 01-network
```

**å®Ÿè¡Œä¾‹**:
```
====================================
CloudFormation Deploy (Service Account)
====================================
Environment: prod
Stack:       facilities-prod-01-network
====================================

Step 1: Validating template...
âœ… Template is valid

Step 2: Filtering parameters...
âœ… Parameters filtered (7 parameters)

Step 3: Creating Change Set...
âœ… Change Set created

Step 4: Reviewing changes (dry-run)...
| Action | ResourceId | ResourceType | Replacement |
|--------|-----------|--------------|-------------|
| Modify | RDSSecurityGroup | AWS::EC2::SecurityGroup | False |

âš ï¸  Execute Change Set on PRODUCTION? (yes/no): yes

Step 7: Executing Change Set...
âœ… Deployment completed successfully

Time: 5åˆ†
```

### Step 4: ã‚³ãƒ¼ãƒ‰ã«åæ˜ ï¼ˆDriftè§£æ¶ˆï¼‰

```bash
# æ‰‹å‹•å®Ÿè¡Œã—ãŸã‚³ãƒ¼ãƒ‰ã‚’Gitã«åæ˜ 
git checkout -b hotfix/security-group-port
git add infra/cloudformation/service/templates/network/security-groups.yaml
git commit -m "hotfix: Fix RDS SecurityGroup port (3306â†’5432)

ç·Šæ€¥å¯¾å¿œã¨ã—ã¦æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ï¼ˆ2025-10-26 12:34ï¼‰
Incident: RDSæ¥ç¶šã‚¨ãƒ©ãƒ¼
Cause: SecurityGroup ãƒãƒ¼ãƒˆè¨­å®šãƒŸã‚¹
Fix: Port 3306 â†’ 5432 ã«ä¿®æ­£
Deploy: facilities-prod-01-network"

git push origin hotfix/security-group-port
```

### Step 5: PRä½œæˆ â†’ ãƒãƒ¼ã‚¸

```bash
gh pr create \
  --title "hotfix: RDS SecurityGroup portä¿®æ­£" \
  --body "## ç·Šæ€¥å¯¾å¿œ

**Incident**: RDSæ¥ç¶šã‚¨ãƒ©ãƒ¼
**æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿**: 2025-10-26 12:34
**ç’°å¢ƒ**: prod

## å¤‰æ›´å†…å®¹
- SecurityGroup ãƒãƒ¼ãƒˆä¿®æ­£ï¼ˆ3306 â†’ 5432ï¼‰

## æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ
GitHub Actions å®Ÿè¡Œæ™‚ã« Change Set: \"No changes\"
ï¼ˆã™ã§ã«æ‰‹å‹•ã§é©ç”¨æ¸ˆã¿ã®ãŸã‚ï¼‰"
```

**GitHub Actions å®Ÿè¡Œçµæœ**:
```
====================================
Deploying: 01-network
====================================
âš ï¸ No changes detected. Skipping...
```

âœ… IaCã¨AWSå®Ÿæ…‹ãŒä¸€è‡´

---

## ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

### ã„ã¤ä½¿ã†ã‹

- âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ
- ğŸ”™ å‰å›ã®å®‰å®šã—ãŸçŠ¶æ…‹ã«æˆ»ã—ãŸã„å ´åˆ

### æ–¹æ³•1: CloudFormation ã‚¹ã‚¿ãƒƒã‚¯ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

```bash
cd infra/cloudformation/service

# ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
./scripts/rollback.sh prod 03-compute
```

**å®Ÿè¡Œä¾‹**:
```
====================================
CloudFormation Stack Rollback
====================================
Environment: prod
Stack:       facilities-prod-03-compute
====================================

âš ï¸  è­¦å‘Š: ã“ã®æ“ä½œã¯å‰å›ã®å®‰å®šã—ãŸçŠ¶æ…‹ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™

æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ (yes/no): yes

Initiating rollback...
Waiting for rollback to complete...

âœ… Rollback completed successfully
====================================
Stack:  facilities-prod-03-compute
Status: UPDATE_ROLLBACK_COMPLETE
====================================
```

### æ–¹æ³•2: Git Revert + å†ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# 1. å•é¡Œã®ã‚ã‚‹ã‚³ãƒŸãƒƒãƒˆã‚’revert
git revert HEAD
git push origin main

# 2. GitHub Actions ãŒè‡ªå‹•çš„ã«revertå†…å®¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
# â†’ å‰å›ã®å®‰å®šã—ãŸçŠ¶æ…‹ã«æˆ»ã‚‹
```

### æ–¹æ³•3: æ‰‹å‹•ã§å‰å›ã®Change Setã‚’å®Ÿè¡Œ

```bash
# 1. å‰å›ã®Change Setã‚’ç¢ºèª
aws cloudformation list-change-sets \
  --stack-name facilities-prod-03-compute

# 2. å‰å›ã®Change Setã‚’å®Ÿè¡Œ
aws cloudformation execute-change-set \
  --stack-name facilities-prod-03-compute \
  --change-set-name facilities-prod-03-compute-20251026-120000
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤é †åº

### Service Accountï¼ˆä¾å­˜é–¢ä¿‚é †ï¼‰

```
1. 01-networkï¼ˆVPC, Subnets, SecurityGroupsï¼‰
   â†“
2. 02-databaseï¼ˆRDSï¼‰
   â†“
3. 03-computeï¼ˆECS, ALBï¼‰
   â†“
4. 04-authï¼ˆCognitoï¼‰
   â†“
5. 05-storageï¼ˆS3, CloudFrontï¼‰
   â†“
6. 06-monitoringï¼ˆCloudWatchï¼‰
```

**ä¸€æ‹¬ãƒ‡ãƒ—ãƒ­ã‚¤**:
```bash
cd infra/cloudformation/service
./scripts/deploy-all.sh dev  # ä¾å­˜é–¢ä¿‚é †ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
```

**å€‹åˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤**:
```bash
# é †åºã‚’å®ˆã‚‹å¿…è¦ã‚ã‚Š
./scripts/deploy.sh dev 01-network
./scripts/deploy.sh dev 02-database
./scripts/deploy.sh dev 03-compute
./scripts/deploy.sh dev 04-auth
./scripts/deploy.sh dev 05-storage
./scripts/deploy.sh dev 06-monitoring
```

### Shared Accountï¼ˆä¾å­˜é–¢ä¿‚é †ï¼‰

```
1. 2-networkï¼ˆTransit Gatewayï¼‰â† Service Account ã®å‰æ
   â†“
2. 1-foundationï¼ˆCloudTrail, Configç­‰ï¼‰â† ã‚ªãƒ—ã‚·ãƒ§ãƒ³
   â†“
3. 3-client-vpnï¼ˆClient VPNï¼‰â† ã‚ªãƒ—ã‚·ãƒ§ãƒ³
```

**é‡è¦**: Service Account ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å‰ã«ã€Shared Account ã® Transit Gateway ã‚’å…ˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

---

## ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆè©³ç´°

### deploy.sh

**Usage**:
```bash
./scripts/deploy.sh <environment> <stack-type>
```

**ä¾‹**:
```bash
./scripts/deploy.sh dev 01-network
./scripts/deploy.sh prod 03-compute
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³: DRY_RUN ãƒ¢ãƒ¼ãƒ‰**:
```bash
# Change Set ä½œæˆã®ã¿ï¼ˆå®Ÿè¡Œã—ãªã„ï¼‰
DRY_RUN=true ./scripts/deploy.sh dev 01-network
```

### deploy-all.sh

**Usage**:
```bash
./scripts/deploy-all.sh <environment>
```

**ä¾‹**:
```bash
./scripts/deploy-all.sh dev   # devç’°å¢ƒã®å…¨ã‚¹ã‚¿ãƒƒã‚¯ãƒ‡ãƒ—ãƒ­ã‚¤
./scripts/deploy-all.sh prod  # prodç’°å¢ƒã®å…¨ã‚¹ã‚¿ãƒƒã‚¯ãƒ‡ãƒ—ãƒ­ã‚¤
```

**ç‰¹å¾´**:
- ä¾å­˜é–¢ä¿‚é †ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
- å¤‰æ›´ãŒãªã„ã‚¹ã‚¿ãƒƒã‚¯ã¯è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—
- ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚‰å³åº§ã«åœæ­¢

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—: Change Setä½œæˆã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼**:
```
An error occurred (ValidationError) when calling the CreateChangeSet operation
```

**åŸå› **:
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡æ³•ã‚¨ãƒ©ãƒ¼
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ä¸è¶³

**å¯¾å‡¦**:
```bash
# 1. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼
aws cloudformation validate-template \
  --template-body file://stacks/01-network/stack.yaml

# 2. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ç¢ºèª
cat parameters/dev.json | jq
```

### ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—: ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼**:
```
Resource [XXX] failed to create
```

**åŸå› **:
- ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ï¼ˆä¾‹: EIPä¸Šé™ï¼‰
- ä¾å­˜ãƒªã‚½ãƒ¼ã‚¹ä¸è¶³

**å¯¾å‡¦**:
```bash
# 1. ã‚¹ã‚¿ãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆç¢ºèª
aws cloudformation describe-stack-events \
  --stack-name facilities-dev-01-network \
  --max-items 10

# 2. ã‚¨ãƒ©ãƒ¼è©³ç´°ç¢ºèª
aws cloudformation describe-stack-events \
  --stack-name facilities-dev-01-network \
  --query 'StackEvents[?ResourceStatus==`CREATE_FAILED`]'
```

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¤±æ•—

**ã‚¨ãƒ©ãƒ¼**:
```
Stack cannot be rolled back
```

**åŸå› **:
- ãƒªã‚½ãƒ¼ã‚¹ãŒæ‰‹å‹•å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
- ãƒªã‚½ãƒ¼ã‚¹ã«å¤–éƒ¨ä¾å­˜ãŒã‚ã‚‹

**å¯¾å‡¦**:
```bash
# 1. ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤ï¼ˆæœ€å¾Œã®æ‰‹æ®µï¼‰
aws cloudformation delete-stack \
  --stack-name facilities-dev-01-network

# 2. å†ãƒ‡ãƒ—ãƒ­ã‚¤
./scripts/deploy.sh dev 01-network
```

---

## å‚è€ƒè³‡æ–™

- [CloudFormation ãƒ‡ãƒ—ãƒ­ã‚¤](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-cli-creating-stack.html)
- [Change Sets](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-changesets.html)
- [GitHub Actions](https://docs.github.com/en/actions)

---

**ä½œæˆè€…**: PM + SRE
**ä½œæˆæ—¥**: 2025-10-26
