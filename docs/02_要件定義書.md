# 役所設備管理システム AWS ECS 移行プロジェクト 要件定義書

**作成日**: 2025-10-24
**バージョン**: 1.0
**ステータス**: レビュー待ち

---

## 1. ドキュメント概要

### 1.1 目的
本ドキュメントは、役所設備管理システムのAWS ECS（Fargate）移行プロジェクトにおける機能要件・非機能要件を詳細に定義する。

### 1.2 対象読者
- プロジェクトオーナー（役所担当者）
- インフラ担当者
- アプリケーション開発チーム
- 運用担当者

### 1.3 関連ドキュメント
- [企画書](01_企画書.md)

---

## 2. システム概要

### 2.1 システム名称
役所設備管理システム

### 2.2 システムの目的
公共施設・庁舎の設備機器（空調、電気、消防設備等）の在庫管理、発注管理、レポート出力を行う業務システム

### 2.3 利用者
- **職員**: 100名（在庫管理、発注承認、レポート閲覧）
- **事業者**: 発注業者（伝票閲覧・入力）

### 2.4 稼働時間
- **稼働日**: 月曜日～土曜日
- **稼働時間**: 9:00～22:00
- **停止日**: 日曜日（完全停止）
- **メンテナンス可能時間**: 日曜日、または平日夜間（22:00～翌9:00）

---

## 3. 機能要件

### 3.1 システム構成

本システムは、3つの独立したアプリケーションで構成される：

| No | システム名 | アクセス方式 | 利用者 | 主要機能 |
|----|-----------|-------------|--------|----------|
| 1 | 業務アプリ（API） | 閉域（VPN経由） | 職員 | 在庫管理、発注管理、承認、レポート出力 |
| 2 | 事業者アプリ（API） | パブリック（インターネット） | 事業者 | 伝票閲覧、伝票入力 |
| 3 | 業務バッチ | 閉域（定期実行） | システム | 月次・年次集計、レポート自動生成 |

### 3.2 業務アプリ（職員向け）

#### 3.2.1 在庫管理機能
- **FR-001**: 設備機器の登録（品名、型番、購入日、保管場所、数量）
- **FR-002**: 設備機器の更新（情報変更、数量調整）
- **FR-003**: 設備機器の削除（論理削除）
- **FR-004**: 設備機器の検索（キーワード、カテゴリ、保管場所、期間）
- **FR-005**: 在庫一覧の表示（ページネーション、ソート、フィルタ）

#### 3.2.2 発注管理機能
- **FR-011**: 発注書の作成（発注先、品目、数量、納期、金額）
- **FR-012**: 発注書の承認フロー（申請者 → 承認者 → 確定）
- **FR-013**: 発注書の送信（PDF出力、事業者アプリへの連携）
- **FR-014**: 発注書の一覧表示（ステータス別、期間別）
- **FR-015**: 発注履歴の検索

#### 3.2.3 レポート機能
- **FR-021**: 月次在庫レポート（PDF/Excel出力）
- **FR-022**: 年次在庫レポート（PDF/Excel出力）
- **FR-023**: 発注実績レポート（期間指定、事業者別、品目別）
- **FR-024**: カスタムレポート（条件指定による任意レポート生成）

#### 3.2.4 認証・認可
- **FR-031**: ログイン（Cognito職員用ユーザープール）
- **FR-032**: ロール管理（管理者、一般職員、承認者）
- **FR-033**: 権限チェック（機能ごとのアクセス制御）
- **FR-034**: セッションタイムアウト（30分無操作でログアウト）

### 3.3 事業者アプリ（発注業者向け）

#### 3.3.1 伝票管理機能
- **FR-041**: 発注伝票の閲覧（自社宛の発注のみ表示）
- **FR-042**: 発注伝票の詳細表示（PDF表示）
- **FR-043**: 納品予定日の入力
- **FR-044**: 納品完了の報告（納品日、備考）
- **FR-045**: 伝票一覧の表示（ステータス別、期間別）

#### 3.3.2 認証・認可
- **FR-051**: ログイン（Cognito事業者用ユーザープール）
- **FR-052**: 事業者単位のデータ分離（自社の伝票のみアクセス可能）
- **FR-053**: セッションタイムアウト（30分無操作でログアウト）

### 3.4 業務バッチ

#### 3.4.1 定期処理
- **FR-061**: 月次在庫レポート自動生成（毎月1日 深夜2:00実行）
- **FR-062**: 年次在庫レポート自動生成（毎年1月1日 深夜2:00実行）
- **FR-063**: 発注期限アラート（納期3日前に通知）
- **FR-064**: データアーカイブ（3年経過データの圧縮保管）

#### 3.4.2 通知機能
- **FR-071**: メール通知（レポート生成完了、発注期限アラート）
- **FR-072**: Slack通知（バッチ処理完了、エラー通知）
- **FR-073**: Teams通知（バッチ処理完了、エラー通知）

---

## 4. 非機能要件

### 4.1 性能要件

#### 4.1.1 応答時間
| 項目 | 目標値 | 測定条件 |
|------|--------|----------|
| API応答時間（平均） | 300ms以内 | 通常時 |
| API応答時間（95%ile） | 500ms以内 | ピーク時（月末集計処理） |
| 画面初期表示 | 1秒以内 | フロントエンド含む |
| レポート出力 | 10秒以内 | 月次レポート（データ量1万件） |

#### 4.1.2 スループット
| 項目 | 目標値 | 備考 |
|------|--------|------|
| 同時接続ユーザー数 | 100 | 職員100名 + 事業者（変動） |
| API リクエスト数 | 1,000 req/min | ピーク時 |

#### 4.1.3 スケーラビリティ
- ECS Fargateタスクの自動スケーリング（CPU使用率70%で追加）
- 最小構成から最大5台まで自動拡張

### 4.2 可用性要件

#### 4.2.1 稼働率
- **目標**: 99.9%（月間43分以内のダウンタイム許容）
- **測定期間**: 稼働時間中（月～土 9:00-22:00）のみ
- **除外項目**: 計画メンテナンス時間（日曜日、平日夜間）

#### 4.2.2 冗長化構成
| コンポーネント | 冗長化方式 | 備考 |
|---------------|-----------|------|
| ECS Fargate | マルチAZ（2AZ） | 最小2タスク |
| RDS PostgreSQL | マルチAZ | 自動フェイルオーバー |
| ALB | マルチAZ | AWS標準 |
| NAT Gateway | マルチAZ | 各AZに1台 |

#### 4.2.3 障害復旧目標
| 項目 | 目標値 | 備考 |
|------|--------|------|
| RTO（目標復旧時間） | 1時間以内 | AZ障害時は自動復旧（数分） |
| RPO（目標復旧時点） | 5分以内 | RDS PITR使用 |

### 4.3 セキュリティ要件

#### 4.3.1 機密性レベル
- **機密性3（機微情報）**: 政府情報セキュリティ分類基準に準拠

#### 4.3.2 準拠規格
- ISMAP（Information system Security Management and Assessment Program）
- 政府情報システムにおけるクラウドサービス利用の基本方針

#### 4.3.3 ネットワークセキュリティ
- **業務アプリ**: プライベートサブネット配置、内部ALB（VPN経由のみ）
- **事業者アプリ**: プライベートサブネット配置、パブリックALB（インターネット公開）
- **RDS**: プライベートサブネット配置、ECSからのみアクセス可能
- **TLS**: TLS 1.3必須（TLS 1.2以下は拒否）
- **WAF**: AWS WAF適用（OWASPルールセット）

#### 4.3.4 認証・認可
| 項目 | 方式 | 備考 |
|------|------|------|
| 職員認証 | Amazon Cognito（職員用ユーザープール） | MFA推奨 |
| 事業者認証 | Amazon Cognito（事業者用ユーザープール） | 事業者単位でデータ分離 |
| APIトークン | JWT（JSON Web Token） | 有効期限30分 |
| パスワードポリシー | 最小8文字、英数字記号混在、90日ごと変更 | Cognito設定 |

#### 4.3.5 暗号化
| 項目 | 方式 | 備考 |
|------|------|------|
| 通信暗号化 | TLS 1.3 | ALB終端 |
| データベース暗号化（保存時） | AES-256（AWS KMS） | RDS暗号化 |
| データベース暗号化（転送時） | TLS 1.3 | RDS接続 |
| S3暗号化 | AES-256（SSE-S3） | ログ保管 |
| ECS環境変数 | AWS Secrets Manager | DB接続情報等 |

#### 4.3.6 監査ログ
| ログ種別 | 保管先 | 保管期間 | 備考 |
|---------|--------|---------|------|
| アプリケーションログ | CloudWatch Logs → S3 | 2年 | API呼び出し、認証、エラー |
| アクセスログ（ALB） | S3 | 2年 | すべてのHTTPリクエスト |
| データベースログ | CloudWatch Logs → S3 | 2年 | スロークエリ、エラー |
| AWSリソース変更ログ | CloudTrail | 2年 | すべてのAPI呼び出し |
| VPCフローログ | CloudWatch Logs → S3 | 1年 | ネットワーク通信 |

**ライフサイクルポリシー**:
- 直近3ヶ月: CloudWatch Logs（検索性重視）
- 3ヶ月～1年: S3 Standard（たまに参照）
- 1年～2年: S3 Glacier Flexible Retrieval（アーカイブ）
- 2年経過: 自動削除

### 4.4 運用・保守要件

#### 4.4.1 監視
| 監視項目 | ツール | 閾値 | 通知先 |
|---------|--------|------|--------|
| ECS CPU使用率 | CloudWatch | 80%以上 | メール、Slack、Teams |
| ECS メモリ使用率 | CloudWatch | 80%以上 | メール、Slack、Teams |
| RDS CPU使用率 | CloudWatch | 80%以上 | メール、Slack、Teams |
| RDS 接続数 | CloudWatch | 最大接続数の80% | メール、Slack、Teams |
| ALB 5xxエラー率 | CloudWatch | 5%以上 | メール、Slack、Teams |
| API応答時間 | CloudWatch | 95%ile > 1秒 | メール、Slack、Teams |

#### 4.4.2 バックアップ
| 対象 | 方式 | 頻度 | 保持期間 | 備考 |
|------|------|------|---------|------|
| RDS | 自動バックアップ | 毎日（深夜2:00） | 1ヶ月 | マルチAZ構成（影響なし） |
| RDS | 手動スナップショット | デプロイ前 | 無期限（手動削除） | ロールバック用 |
| RDS PITR | 継続的 | リアルタイム | 35日（最長） | 任意の時点に復旧可能 |
| CloudFormation | Git管理 | 変更時 | 無期限 | GitHub |
| アプリケーションコード | Git管理 | 変更時 | 無期限 | GitHub |

#### 4.4.3 デプロイ
| 項目 | 方式 | 備考 |
|------|------|------|
| デプロイ頻度 | 週1回 | 日曜日または平日夜間 |
| デプロイ方式 | ECSローリングアップデート | シンプル、運用しやすい |
| ダウンタイム | 数分程度許容 | メンテナンス時間中のため問題なし |
| ロールバック | 前のタスク定義に戻す | 5分以内 |
| CI/CD | GitHub Actions | ビルド、テスト、デプロイ自動化 |

#### 4.4.4 メンテナンス
| 項目 | 頻度 | 実施時間 | 備考 |
|------|------|---------|------|
| 計画メンテナンス | 週1回 | 日曜日または平日夜間（22:00-9:00） | デプロイ、RDSメンテナンス |
| RDSメンテナンスウィンドウ | 月1回程度 | 日曜日 深夜2:00-3:00 | AWSによる自動メンテナンス |
| OSパッチ適用 | 不要 | - | Fargateはマネージド |

#### 4.4.5 運用工数削減目標

| 項目 | 現状（EC2ベース） | 目標（ECS Fargate） | 削減率 |
|------|-----------------|-------------------|--------|
| サーバー管理工数 | 月20時間 | 月5時間 | 75%削減 |
| 夜間・休日の緊急出社 | 月2-3回 | 0回 | 100%削減 |

**達成方法**:
- Fargateによるサーバーレス化（OSレベルの管理が不要）
- CloudWatch監視とSNS通知による自動アラート
- 計画メンテナンスのメンテナンス時間中への集約
- ECSローリングアップデートによる安定したデプロイ

### 4.5 災害対策（DR）

#### 4.5.1 通常時の構成
- **リージョン**: 東京リージョン
- **AZ**: マルチAZ（2AZ）
- **対応範囲**: AZ障害に自動対応

#### 4.5.2 災害時の対応
| シナリオ | 対応方針 | 目標復旧時間 |
|---------|---------|-------------|
| 単一AZ障害 | 自動フェイルオーバー | 数分（自動） |
| 東京リージョン壊滅 | 別リージョン（大阪）へ手動再構築 | 24時間以内 |

#### 4.5.3 DR準備
- CloudFormationテンプレートのGit管理
- RDSスナップショットの別リージョン（大阪）へのコピー（毎日）
- DR手順書の整備
- 年1回のDR訓練実施

### 4.6 拡張性・保守性

#### 4.6.1 インフラのコード管理
- **IaC**: AWS CloudFormation
- **バージョン管理**: GitHub
- **環境差分管理**: パラメータファイル（dev/stg/prod）

#### 4.6.2 ドキュメント整備
- デプロイ手順書
- 運用手順書（監視、アラート対応、スケーリング）
- トラブルシューティングガイド
- セキュリティ対策ガイド（ISMAP準拠事項）
- DR（災害復旧）手順書

---

## 5. 技術スタック

### 5.1 アプリケーション

| レイヤー | 技術 | バージョン | 備考 |
|---------|------|----------|------|
| フロントエンド | React | 18 | SPA（既存継続） |
| バックエンド | Node.js + Express | 18 | REST API（既存継続） |
| データベース | PostgreSQL | 14 | RDS（新規構築） |

### 5.2 インフラ（AWS）

| カテゴリ | サービス | 用途 |
|---------|---------|------|
| コンテナ基盤 | ECS Fargate | アプリケーション実行環境 |
| データベース | RDS PostgreSQL 14 | データ永続化 |
| ネットワーク | VPC、サブネット、NAT Gateway | ネットワーク構成 |
| ロードバランサー | ALB（Application Load Balancer） | トラフィック分散 |
| 認証 | Amazon Cognito | ユーザー認証（職員用・事業者用） |
| DNS | Route53 | ドメイン管理 |
| CDN | CloudFront | フロントエンド配信 |
| ストレージ | S3 | フロントエンド配信、ログ保管 |
| コンテナレジストリ | ECR | Dockerイメージ管理 |
| シークレット管理 | Secrets Manager | DB接続情報、APIキー |
| 監視・ログ | CloudWatch | メトリクス、ログ、アラート |
| セキュリティ | WAF | Webアプリケーションファイアウォール |
| 証明書 | ACM（AWS Certificate Manager） | TLS証明書 |
| 変更管理 | CloudTrail | AWSリソース変更ログ |

### 5.3 CI/CD

| カテゴリ | ツール | 用途 |
|---------|--------|------|
| CI/CD | GitHub Actions | ビルド、テスト、デプロイ自動化 |
| IaC | CloudFormation | インフラのコード管理 |
| コンテナビルド | Docker | コンテナイメージ作成 |

---

## 6. 環境構成

### 6.1 環境一覧

| 環境 | 用途 | リソーススペック | VPC CIDR |
|------|------|------------------|----------|
| dev | 開発環境 | 最小構成 | 10.0.0.0/16 |
| stg | ステージング（本番前検証） | 中規模構成 | 10.1.0.0/16 |
| prod | 本番環境 | 本番スペック（オートスケーリング） | 10.2.0.0/16 |

### 6.2 リソーススペック

#### 6.2.1 ECS Fargate

| 環境 | CPU | メモリ | タスク数（最小-最大） | 備考 |
|------|-----|--------|---------------------|------|
| dev | 0.25 vCPU | 0.5GB | 1（固定） | 開発用 |
| stg | 0.25 vCPU | 0.5GB | 2（固定） | 検証用 |
| prod | 0.5 vCPU | 1GB | 2-5（オートスケーリング） | CPU 70%でスケール |

※ 業務API、事業者API、バッチで個別にタスク定義

#### 6.2.2 RDS PostgreSQL

| 環境 | インスタンスタイプ | ストレージ | マルチAZ | 備考 |
|------|------------------|----------|---------|------|
| dev | db.t4g.micro | 20GB（gp3） | 無効 | 開発用（コスト削減） |
| stg | db.t4g.small | 50GB（gp3） | 有効 | 検証用 |
| prod | db.t4g.medium | 100GB（gp3） | 有効 | 本番用（初期値） |

※ 実運用後、CloudWatchメトリクスを見て調整

---

## 7. データ移行

### 7.1 移行対象
- **現行RDS PostgreSQL**: 既存データベース
- **新規RDS PostgreSQL**: 3環境（dev/stg/prod）で新規構築

### 7.2 移行方式
| 環境 | 移行方式 | 備考 |
|------|---------|------|
| dev | 現行本番のスナップショット復元 | 開発用データ |
| stg | 現行本番のスナップショット復元 | 検証用データ |
| prod | AWS DMS（Database Migration Service）または論理バックアップ | 本番稼働時 |

### 7.3 移行スケジュール
1. dev環境構築・データ移行（設計フェーズ完了後）
2. stg環境構築・データ移行（実装フェーズ中）
3. prod環境構築・データ移行（本番稼働直前）

---

## 8. 制約条件

### 8.1 予算
- **初期構築費用**: 300万円以内
- **月額運用費用**: 100万円以内（AWS利用料のみ）

### 8.2 納期
- **本番稼働**: 12ヶ月以内
- **リリース方式**: 業務アプリ、事業者アプリ、バッチを同時ローンチ

### 8.3 技術制約
- **既存システムとの連携**: 社内ネットワーク（VPN経由）
- **コンプライアンス制約**: ISMAP準拠、機密性3レベル

### 8.4 運用制約
- **デプロイ頻度**: 週1回
- **運用体制**: インフラ担当者1名（委託）

---

## 9. 受入基準

### 9.1 機能要件
- [ ] すべての機能要件（FR-001～FR-073）が実装され、動作確認完了
- [ ] 職員・事業者の両方でログインから主要機能まで一通り動作

### 9.2 非機能要件
- [ ] 負荷テストで同時接続100ユーザー、応答時間95%ile < 500ms を達成
- [ ] 可用性99.9%を満たす構成（マルチAZ）
- [ ] ISMAP準拠のセキュリティ対策が実装済み
- [ ] 監査ログが2年間保管される設定

### 9.3 運用
- [ ] デプロイ手順書、運用手順書、DR手順書が整備済み
- [ ] CloudFormationでインフラがコード管理されている
- [ ] GitHub Actionsで自動デプロイが動作

### 9.4 移行
- [ ] 現行RDSから新規RDSへのデータ移行が完了
- [ ] データ整合性チェック完了

---

## 10. 承認

### レビュー・承認者
- （未定）

### 承認日
- （未定）

---

**備考**:
- 本要件定義書は、2025-10-24時点の情報をもとに作成しています。
- 設計フェーズで技術的な詳細が追加される可能性があります。
