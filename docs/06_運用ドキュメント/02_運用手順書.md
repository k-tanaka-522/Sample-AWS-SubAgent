# 運用手順書: 役所設備管理システム

**作成日**: 2025-10-25
**バージョン**: 1.0
**対象読者**: 運用担当者、SRE

---

## 目次

1. [日常監視](#日常監視)
2. [定期メンテナンス](#定期メンテナンス)
3. [スケール操作](#スケール操作)
4. [アラート対応](#アラート対応)
5. [ログ調査](#ログ調査)
6. [運用カレンダー](#運用カレンダー)

---

## 日常監視

### 1. CloudWatch Alarms の確認

**頻度**: 毎日 9:00、14:00、17:00（営業時間内3回）

**手順**:

```bash
# AWSコンソールにログイン
# CloudWatch > Alarms を開く

# または CLI で確認
aws cloudwatch describe-alarms \
  --state-value ALARM \
  --query 'MetricAlarms[*].[AlarmName,StateValue,StateReason]' \
  --output table
```

**確認項目**:

| 項目 | 正常状態 | 異常時の対応 |
|------|---------|------------|
| ECS CPU使用率 | OK（緑） | [アラート対応](#アラート対応)参照 |
| ECS メモリ使用率 | OK（緑） | [アラート対応](#アラート対応)参照 |
| RDS CPU使用率 | OK（緑） | [アラート対応](#アラート対応)参照 |
| RDS 接続数 | OK（緑） | [アラート対応](#アラート対応)参照 |
| ALB 5xxエラー率 | OK（緑） | [アラート対応](#アラート対応)参照 |
| ALB レイテンシ | OK（緑） | [アラート対応](#アラート対応)参照 |

**記録**:
- 異常が発生した場合は、Slackの `#ops-alerts` に記録
- 重大な問題は運用報告書に記載

---

### 2. CloudWatch Dashboard の確認

**頻度**: 毎日 9:00（始業時）

**手順**:

```
1. AWSコンソール > CloudWatch > Dashboards
2. "facility-prod-main" ダッシュボードを開く
```

**確認項目**:

| ウィジェット | 確認内容 | 正常範囲 |
|------------|---------|---------|
| ECS CPU & Memory | CPU/メモリ使用率の推移 | CPU < 70%、メモリ < 70% |
| ALB Performance | リクエスト数、レイテンシ | レイテンシ < 500ms |
| RDS Performance | CPU使用率、接続数 | CPU < 70%、接続数 < 80 |
| Network | データ転送量 | 異常な急増がないこと |

---

### 3. Log Insights でのエラーログ検索

**頻度**: 毎日 9:00（始業時）、障害発生時

**手順**:

```bash
# AWSコンソール > CloudWatch > Logs > Insights

# 過去1時間のエラーログ検索
fields @timestamp, level, message, statusCode
| filter level = "ERROR"
| sort @timestamp desc
| limit 100
```

**確認項目**:

- エラーログの件数（通常: 1時間あたり10件未満）
- 同一エラーの頻発（バグまたは障害の兆候）
- 5xxエラーの有無

**記録**:
- 重大なエラー（500エラー、DB接続エラー等）は運用報告書に記載

---

### 4. Cost Explorer でのコスト確認

**頻度**: 毎週月曜日 9:00

**手順**:

```
1. AWSコンソール > Cost Management > Cost Explorer
2. "Daily costs" を選択
3. フィルタ: "Service" で主要サービスごとに確認
```

**確認項目**:

| サービス | 目安（月額） | 異常検知 |
|---------|------------|---------|
| ECS Fargate | 30,000円 | 50%以上増加で調査 |
| RDS | 25,000円 | 50%以上増加で調査 |
| ALB | 20,000円 | 50%以上増加で調査 |
| CloudWatch | 10,000円 | 50%以上増加で調査 |
| **合計** | **約100,000円** | 予算の80%超過でアラート |

**対応**:
- 予算超過の兆候があれば、PM（プロジェクトマネージャー）に報告

---

## 定期メンテナンス

### 1. RDS バックアップの確認

**頻度**: 毎週月曜日 9:00

**手順**:

```bash
# RDS自動バックアップの確認
aws rds describe-db-snapshots \
  --db-instance-identifier facility-prod-db \
  --snapshot-type automated \
  --query 'DBSnapshots[*].[DBSnapshotIdentifier,SnapshotCreateTime,Status]' \
  --output table

# 最新のスナップショットが昨日のものか確認
```

**確認項目**:

- [ ] 自動スナップショットが毎日作成されているか
- [ ] スナップショットのステータスが `available` か
- [ ] 保持期間が7日間設定されているか

**異常時の対応**:
- スナップショットが作成されていない場合、AWSサポートに問い合わせ

---

### 2. CloudTrail ログの確認

**頻度**: 毎月1日 9:00

**手順**:

```bash
# 過去30日間のIAMユーザーの操作ログを確認
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=EventName,AttributeValue=ConsoleLogin \
  --start-time $(date -u -d '30 days ago' +%Y-%m-%dT%H:%M:%S) \
  --query 'Events[*].[EventTime,Username,SourceIPAddress]' \
  --output table
```

**確認項目**:

- [ ] 不正なログインがないか（見覚えのないIP、時間帯）
- [ ] 不要なIAMユーザーが操作していないか
- [ ] 重要なリソース変更（RDS削除、S3削除等）がないか

**記録**:
- 異常があれば、セキュリティインシデントとして報告

---

### 3. IAMアクセスキーのローテーション

**頻度**: 90日ごと

**手順**:

```bash
# アクセスキーの作成日確認
aws iam list-access-keys \
  --user-name ci-cd-user \
  --query 'AccessKeyMetadata[*].[AccessKeyId,CreateDate]' \
  --output table

# 90日以上経過しているキーをローテーション
```

**ローテーション手順**:

1. 新しいアクセスキーを作成
2. GitHub Actions のシークレットを更新
3. 動作確認（GitHub Actions のデプロイテスト）
4. 古いアクセスキーを無効化
5. 7日後、古いアクセスキーを削除

**チェックリスト**:
- [ ] 新しいアクセスキー作成
- [ ] GitHub Secretsを更新
- [ ] デプロイ動作確認
- [ ] 古いアクセスキー無効化
- [ ] 7日後、古いアクセスキー削除

---

### 4. セキュリティパッチ確認（RDS）

**頻度**: 毎月1日 9:00

**手順**:

```bash
# RDSメンテナンス情報確認
aws rds describe-pending-maintenance-actions \
  --resource-identifier arn:aws:rds:ap-northeast-1:123456789012:db:facility-prod-db \
  --query 'PendingMaintenanceActions[*].[Action,Description,ForcedApplyDate]' \
  --output table
```

**確認項目**:

- [ ] 強制適用日（ForcedApplyDate）が近いパッチがあるか
- [ ] メンテナンスウィンドウ内で適用可能か

**対応**:
- 強制適用日の1週間前までにメンテナンスウィンドウで手動適用

**メンテナンスウィンドウ**:
- 日曜日 深夜2:00-3:00

---

## スケール操作

### 1. ECS Auto Scaling の調整

**タイミング**: 月末（負荷集中）、年度末（大量処理）

**手順**:

```bash
# 現在のAuto Scaling設定確認
aws application-autoscaling describe-scalable-targets \
  --service-namespace ecs \
  --resource-ids service/facility-prod-cluster/staff-api

# 最大タスク数を一時的に10に変更
aws application-autoscaling register-scalable-target \
  --service-namespace ecs \
  --resource-id service/facility-prod-cluster/staff-api \
  --scalable-dimension ecs:service:DesiredCount \
  --min-capacity 2 \
  --max-capacity 10
```

**元に戻す**:
- 負荷が収まったら最大タスク数を5に戻す

---

### 2. RDS インスタンスサイズ変更

**タイミング**: CPU使用率が継続的に70%を超える場合

**手順**:

```bash
# 1. メンテナンスウィンドウで変更（推奨）
aws rds modify-db-instance \
  --db-instance-identifier facility-prod-db \
  --db-instance-class db.t4g.large \
  --apply-immediately false  # メンテナンスウィンドウで適用

# 2. 即座に変更（緊急時のみ）
aws rds modify-db-instance \
  --db-instance-identifier facility-prod-db \
  --db-instance-class db.t4g.large \
  --apply-immediately true  # 数分のダウンタイムあり
```

**ダウンタイム**:
- `--apply-immediately false`: なし（メンテナンスウィンドウで適用）
- `--apply-immediately true`: 約5-10分

**承認**:
- インスタンスサイズ変更は必ずPMの承認を得る

---

### 3. CloudFront キャッシュクリア

**タイミング**: フロントエンド（SPA）のデプロイ後

**手順**:

```bash
# 全ファイルのキャッシュクリア
aws cloudfront create-invalidation \
  --distribution-id E1234567890ABC \
  --paths "/*"

# 特定ファイルのみクリア
aws cloudfront create-invalidation \
  --distribution-id E1234567890ABC \
  --paths "/index.html" "/static/js/main.*.js"
```

**注意**:
- 全ファイルのキャッシュクリアは課金対象（月間1,000回まで無料）

---

## アラート対応

### 1. ALB 5XX エラー発生時の対応

**症状**: CloudWatch Alarmで `alb-5xx-error-rate` が発火

**対応手順**:

```bash
# 1. エラーログ確認
aws logs tail /ecs/staff-api --since 10m --follow

# 2. ECS タスクの状態確認
aws ecs describe-services \
  --cluster facility-prod-cluster \
  --services staff-api \
  --query 'services[0].{RunningCount:runningCount,PendingCount:pendingCount,DesiredCount:desiredCount}'

# 3. ヘルスチェック失敗の確認
aws elbv2 describe-target-health \
  --target-group-arn arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/facility-prod-staff-api-tg/xxxxxxxx
```

**原因と対処**:

| 原因 | 対処 |
|------|------|
| ECS タスククラッシュ | ECS Service が自動復旧（5分待機） |
| アプリケーションエラー | ログから原因特定、必要に応じてロールバック |
| DB接続エラー | RDS状態確認、Security Group確認 |

**エスカレーション**:
- 10分以内に自動復旧しない場合、開発チームに連絡

---

### 2. ECS CPU高負荷時の対応

**症状**: CloudWatch Alarmで `ecs-cpu-high` が発火

**対応手順**:

```bash
# 1. CPU使用率の推移確認
aws cloudwatch get-metric-statistics \
  --namespace AWS/ECS \
  --metric-name CPUUtilization \
  --dimensions Name=ClusterName,Value=facility-prod-cluster Name=ServiceName,Value=staff-api \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Average

# 2. Auto Scaling が動作しているか確認
aws ecs describe-services \
  --cluster facility-prod-cluster \
  --services staff-api \
  --query 'services[0].{DesiredCount:desiredCount,RunningCount:runningCount}'
```

**対応**:

| 状況 | 対処 |
|------|------|
| Auto Scalingが正常動作 | 自動復旧を待つ（5分） |
| Auto Scalingが動作しない | 手動でタスク数を増やす |
| タスク数が最大値に到達 | PMに報告、最大値を一時的に引き上げ |

**手動スケール**:

```bash
aws ecs update-service \
  --cluster facility-prod-cluster \
  --service staff-api \
  --desired-count 5
```

---

### 3. RDS ストレージ不足時の対応

**症状**: CloudWatch Alarmで `rds-storage-low` が発火

**対応手順**:

```bash
# 1. 現在のストレージ使用量確認
aws cloudwatch get-metric-statistics \
  --namespace AWS/RDS \
  --metric-name FreeStorageSpace \
  --dimensions Name=DBInstanceIdentifier,Value=facility-prod-db \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Average

# 2. ストレージ拡張（ダウンタイムなし）
aws rds modify-db-instance \
  --db-instance-identifier facility-prod-db \
  --allocated-storage 200 \
  --apply-immediately true
```

**承認**:
- ストレージ拡張は必ずPMの承認を得る（コスト増加）

**注意**:
- RDS ストレージは縮小できない（拡張のみ）

---

## ログ調査

### 1. ECS タスクログの確認

**タイミング**: エラー発生時、障害調査時

**手順**:

```bash
# リアルタイムでログを確認
aws logs tail /ecs/staff-api --follow

# 過去1時間のエラーログのみ
aws logs tail /ecs/staff-api --since 1h --filter-pattern "ERROR"

# 特定のリクエストIDで検索
aws logs filter-log-events \
  --log-group-name /ecs/staff-api \
  --filter-pattern "abc123"  # トレースID
```

---

### 2. RDS スロークエリログの確認

**タイミング**: レイテンシ増加時、月次レビュー

**手順**:

```bash
# CloudWatch Logs Insights
fields @timestamp, @message
| filter @message like /duration/
| parse @message /duration: (?<duration>\d+\.\d+) ms/
| filter duration > 1000  # 1秒以上のクエリ
| sort duration desc
| limit 20
```

**対処**:
- スロークエリが頻発する場合、インデックス追加を検討

---

### 3. WAF ブロックログの確認

**タイミング**: 不正アクセスの兆候時、月次レビュー

**手順**:

```bash
# WAFログをS3から確認
aws s3 ls s3://facility-waf-logs-prod/ --recursive | tail -20

# Athenaでクエリ（事前設定必要）
SELECT * FROM waf_logs
WHERE action = 'BLOCK'
ORDER BY timestamp DESC
LIMIT 100
```

---

## 運用カレンダー

### 日次

| 時刻 | タスク |
|------|--------|
| 9:00 | CloudWatch Alarms確認、Dashboardレビュー、エラーログ検索 |
| 14:00 | CloudWatch Alarms確認 |
| 17:00 | CloudWatch Alarms確認、当日の運用報告 |

### 週次

| 曜日 | タスク |
|------|--------|
| 月曜日 9:00 | RDSバックアップ確認、コスト確認 |
| 日曜日 深夜2:00 | 定期デプロイ（計画時） |

### 月次

| 日付 | タスク |
|------|--------|
| 1日 9:00 | CloudTrailログ確認、RDSセキュリティパッチ確認 |

### 四半期ごと

| タイミング | タスク |
|-----------|--------|
| 90日ごと | IAMアクセスキーのローテーション |
| 4月、7月、10月、1月 | DR訓練（バックアップ復元訓練） |

### 年次

| タイミング | タスク |
|-----------|--------|
| 4月 | フェイルオーバー訓練 |
| 10月 | リージョン障害訓練（DR訓練） |

---

## 緊急連絡先

| 役割 | 連絡先 | 対応範囲 |
|------|--------|---------|
| 運用担当者（当番） | （未定） | アラート一次対応 |
| システム管理者 | （未定） | 障害エスカレーション |
| 開発チーム | （未定） | アプリケーションエラー対応 |
| AWSサポート | AWSコンソール | インフラ障害対応 |

---

**作成者**: SRE（Claude）
**承認者**: （未定）
**最終更新**: 2025-10-25
