# トラブルシューティングガイド: 役所設備管理システム

**作成日**: 2025-10-25
**バージョン**: 1.0
**対象読者**: 運用担当者、SRE、開発チーム

---

## 目次

1. [よくあるトラブルと対処法](#よくあるトラブルと対処法)
2. [ログ調査手順](#ログ調査手順)
3. [緊急時の切り戻し手順](#緊急時の切り戻し手順)
4. [FAQ](#faq)

---

## よくあるトラブルと対処法

### トラブル1: API が応答しない

#### 症状

- ブラウザで `https://admin-api.facility.example.com/health` にアクセスしても応答がない
- CloudWatch Alarm で `alb-5xx-error-rate` が発火

#### 原因と対処

| 原因 | 確認方法 | 対処法 |
|------|---------|--------|
| **ECS タスクが停止している** | `aws ecs describe-services --cluster facility-prod-cluster --services staff-api` | ECS Serviceが自動復旧（5分待機）。復旧しない場合は手動で `force-new-deployment` |
| **ALB ヘルスチェック失敗** | `aws elbv2 describe-target-health --target-group-arn <tg-arn>` | ヘルスチェックパス `/health` が正常か確認。アプリケーションログでエラー確認 |
| **RDS 接続エラー** | CloudWatch Logs で `ECONNREFUSED` を検索 | Security Group、Secrets Manager のDB接続情報を確認 |
| **WAF がブロックしている** | WAF ログで `BLOCK` アクションを確認 | 正当なリクエストならWAFルールを調整 |

#### 詳細手順

**1. ECS タスク状態確認**

```bash
aws ecs describe-services \
  --cluster facility-prod-cluster \
  --services staff-api \
  --query 'services[0].{RunningCount:runningCount,DesiredCount:desiredCount,PendingCount:pendingCount}'
```

**期待結果**: `RunningCount == DesiredCount` (通常は2)

**異常時**:
```bash
# 強制再デプロイ
aws ecs update-service \
  --cluster facility-prod-cluster \
  --service staff-api \
  --force-new-deployment
```

**2. ALB ヘルスチェック確認**

```bash
aws elbv2 describe-target-health \
  --target-group-arn arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/facility-prod-staff-api-tg/xxxxxxxx
```

**期待結果**: すべてのターゲットが `healthy`

**異常時**: タスクログで `/health` エンドポイントのエラーを確認

**3. RDS 接続確認**

```bash
# RDS エンドポイント確認
aws rds describe-db-instances \
  --db-instance-identifier facility-prod-db \
  --query 'DBInstances[0].Endpoint.Address'

# Security Group 確認
aws ec2 describe-security-groups \
  --group-ids sg-xxxxx \
  --query 'SecurityGroups[0].IpPermissions'
```

**期待結果**: ECS Security GroupからRDS Security Groupへのポート5432が許可されている

---

### トラブル2: ログインできない（Cognito）

#### 症状

- ブラウザで職員用画面にログインできない
- エラーメッセージ: "Invalid username or password"

#### 原因と対処

| 原因 | 確認方法 | 対処法 |
|------|---------|--------|
| **パスワード入力ミス** | ユーザーに再入力を依頼 | パスワードリセット |
| **ユーザーが無効化されている** | Cognito User Poolsでユーザー状態確認 | ユーザーを有効化 |
| **Cognito User Poolが誤削除** | AWSコンソールでUser Pool存在確認 | CloudFormationから再作成（[DR手順書](04_DR手順書.md)参照） |
| **JWTトークンの検証エラー** | アプリケーションログで `jwt` エラーを検索 | Cognito User Pool IDが正しいか確認 |

#### 詳細手順

**1. ユーザー状態確認**

```bash
aws cognito-idp admin-get-user \
  --user-pool-id ap-northeast-1_xxxxxx \
  --username staff-001
```

**期待結果**: `UserStatus: CONFIRMED`, `Enabled: true`

**2. パスワードリセット**

```bash
aws cognito-idp admin-set-user-password \
  --user-pool-id ap-northeast-1_xxxxxx \
  --username staff-001 \
  --password NewPassword123! \
  --permanent
```

**3. Cognito User Pool 存在確認**

```bash
aws cognito-idp describe-user-pool \
  --user-pool-id ap-northeast-1_xxxxxx
```

**エラーが出る場合**: User Poolが削除されている可能性あり。CloudFormationから再作成。

---

### トラブル3: バッチ処理が失敗する

#### 症状

- 月次レポート生成バッチが失敗
- CloudWatch Logs にエラーログ
- Slack/Teams に通知が届かない

#### 原因と対処

| 原因 | 確認方法 | 対処法 |
|------|---------|--------|
| **ECS タスク起動失敗** | CloudWatch Logs で `cannot pull image` を検索 | ECRイメージが存在するか確認 |
| **タイムアウト** | CloudWatch Logs で `timeout` を検索 | タスク定義のタイムアウト設定を延長 |
| **メモリ不足** | CloudWatch Logs で `OOMKilled` を検索 | タスク定義のメモリを増やす |
| **DB接続エラー** | CloudWatch Logs で `ECONNREFUSED` を検索 | RDS状態確認、Security Group確認 |

#### 詳細手順

**1. バッチタスクの実行履歴確認**

```bash
# ECS タスク一覧（バッチ）
aws ecs list-tasks \
  --cluster facility-prod-cluster \
  --family batch

# タスク詳細確認
aws ecs describe-tasks \
  --cluster facility-prod-cluster \
  --tasks <task-id> \
  --query 'tasks[0].{StopCode:stopCode,StoppedReason:stoppedReason,LastStatus:lastStatus}'
```

**2. CloudWatch Logs でエラー確認**

```bash
aws logs tail /ecs/batch --since 1h --filter-pattern "ERROR"
```

**3. メモリ不足の場合**

```yaml
# infra/cloudformation/service/nested/compute/batch.yaml を編集
TaskDefinition:
  Properties:
    Memory: 2048  # 1024 から 2048 に増やす
```

**4. 再実行**

```bash
# EventBridge ルールを手動実行
aws events put-events \
  --entries '[{"Source":"manual","DetailType":"Scheduled Event","Detail":"{}"}]'
```

---

### トラブル4: CloudFrontの配信が遅い

#### 症状

- フロントエンド（SPA）の初期ロードが遅い
- ブラウザのDevToolsで数秒かかる

#### 原因と対処

| 原因 | 確認方法 | 対処法 |
|------|---------|--------|
| **キャッシュミス** | CloudFront メトリクスで `CacheHitRate` を確認 | キャッシュTTLを調整、`Cache-Control` ヘッダーを設定 |
| **オリジン（S3）が遅い** | S3アクセスログでレイテンシ確認 | S3リージョン確認、Transfer Acceleration有効化 |
| **大きなファイルサイズ** | ブラウザDevToolsでファイルサイズ確認 | 圧縮（gzip/brotli）、画像最適化、コード分割 |
| **地理的距離** | ユーザーの所在地を確認 | 問題なし（CloudFrontは世界中にエッジロケーション） |

#### 詳細手順

**1. CloudFront キャッシュヒット率確認**

```bash
aws cloudwatch get-metric-statistics \
  --namespace AWS/CloudFront \
  --metric-name CacheHitRate \
  --dimensions Name=DistributionId,Value=E1234567890ABC \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Average
```

**期待結果**: 80%以上

**2. キャッシュクリア後に再確認**

```bash
aws cloudfront create-invalidation \
  --distribution-id E1234567890ABC \
  --paths "/*"
```

**3. S3オブジェクトのメタデータ確認**

```bash
aws s3api head-object \
  --bucket facility-prod-admin-spa \
  --key index.html \
  --query 'Metadata'
```

**期待結果**: `Cache-Control: public, max-age=3600` が設定されている

---

## ログ調査手順

### 1. ECS タスクログの確認

#### シナリオ: API エラーの原因調査

**手順**:

```bash
# ステップ1: リアルタイムログ確認
aws logs tail /ecs/staff-api --follow

# ステップ2: 過去1時間のエラーログのみ
aws logs tail /ecs/staff-api --since 1h --filter-pattern "ERROR"

# ステップ3: 特定のHTTPステータスコードで検索
aws logs filter-log-events \
  --log-group-name /ecs/staff-api \
  --filter-pattern '"statusCode":500'
```

**ログ例**:

```json
{
  "timestamp": "2025-10-25T12:34:56.789Z",
  "level": "ERROR",
  "message": "Database connection failed",
  "error": {
    "code": "ECONNREFUSED",
    "errno": -111,
    "syscall": "connect"
  }
}
```

**対処**: RDS接続エラー → Security Group、Secrets Manager確認

---

### 2. RDS スロークエリログの確認

#### シナリオ: API レイテンシ増加

**手順**:

```bash
# CloudWatch Logs Insights でスロークエリ検索
aws logs start-query \
  --log-group-name /aws/rds/instance/facility-prod-db/slowquery \
  --start-time $(date -u -d '1 hour ago' +%s) \
  --end-time $(date -u +%s) \
  --query-string 'fields @timestamp, @message | filter @message like /duration/ | parse @message /duration: (?<duration>\d+\.\d+) ms/ | filter duration > 1000 | sort duration desc | limit 20'
```

**ログ例**:

```
duration: 2345.67 ms  statement: SELECT * FROM orders WHERE created_at > '2024-01-01'
```

**対処**: インデックス追加を検討

```sql
CREATE INDEX idx_orders_created_at ON orders(created_at);
```

---

### 3. WAF ブロックログの確認

#### シナリオ: 事業者がアクセスできない

**手順**:

```bash
# WAFログをS3から取得（最新10ファイル）
aws s3 ls s3://facility-waf-logs-prod/ --recursive | tail -10

# ダウンロードして確認
aws s3 cp s3://facility-waf-logs-prod/2025/10/25/12/xxxxx.gz . --region ap-northeast-1
gunzip xxxxx.gz
cat xxxxx | jq '.action, .httpRequest'
```

**ログ例**:

```json
{
  "action": "BLOCK",
  "httpRequest": {
    "clientIp": "203.0.113.45",
    "uri": "/api/vendors/123",
    "httpMethod": "GET"
  },
  "ruleGroupList": [
    {
      "ruleGroupId": "AWS-AWSManagedRulesCommonRuleSet",
      "terminatingRule": {
        "ruleId": "SizeRestrictions_BODY"
      }
    }
  ]
}
```

**対処**: 正当なリクエストならWAFルールを調整

---

## 緊急時の切り戻し手順

### 1. ECS タスク定義のロールバック

#### タイミング

- デプロイ後にAPIエラーが多発
- 動作が不安定

#### 手順

```bash
# ステップ1: 現在のタスク定義確認
aws ecs describe-services \
  --cluster facility-prod-cluster \
  --services staff-api \
  --query 'services[0].taskDefinition'

# 出力例: facility-prod-staff-api:45

# ステップ2: 前のタスク定義（:44）に戻す
aws ecs update-service \
  --cluster facility-prod-cluster \
  --service staff-api \
  --task-definition facility-prod-staff-api:44

# ステップ3: デプロイ完了待機
aws ecs wait services-stable \
  --cluster facility-prod-cluster \
  --services staff-api

# ステップ4: 動作確認
curl -f https://admin-api.facility.example.com/health
```

**所要時間**: 約5分

---

### 2. CloudFormation スタックのロールバック

#### タイミング

- CloudFormationデプロイ後にインフラエラー
- スタック状態が `UPDATE_FAILED`

#### 手順

```bash
cd infra/cloudformation/service

# ステップ1: スタック状態確認
aws cloudformation describe-stacks \
  --stack-name facility-prod-compute \
  --query 'Stacks[0].StackStatus'

# 出力例: UPDATE_FAILED

# ステップ2: ロールバック実行
./scripts/rollback.sh prod compute

# ステップ3: ロールバック完了待機（約10分）
aws cloudformation wait stack-rollback-complete \
  --stack-name facility-prod-compute

# ステップ4: スタック状態確認
aws cloudformation describe-stacks \
  --stack-name facility-prod-compute \
  --query 'Stacks[0].StackStatus'

# 出力例: UPDATE_ROLLBACK_COMPLETE
```

**所要時間**: 約10-15分

---

### 3. RDS スナップショットからの復元（データ損失時）

#### タイミング

- データベースのデータが誤削除された
- データ破損

#### 手順

**重要**: データ復元は慎重に。必ずPMの承認を得る。

```bash
# ステップ1: 最新のスナップショット確認
aws rds describe-db-snapshots \
  --db-instance-identifier facility-prod-db \
  --query 'DBSnapshots[*].[DBSnapshotIdentifier,SnapshotCreateTime,Status]' \
  --output table

# ステップ2: 別インスタンスとして復元（本番DBには上書きしない）
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier facility-prod-db-restored \
  --db-snapshot-identifier facility-prod-db-automated-2025-10-25-02-00 \
  --db-subnet-group-name facility-prod-db-subnet-group \
  --vpc-security-group-ids sg-xxxxx

# ステップ3: 復元完了待機（約15分）
aws rds wait db-instance-available \
  --db-instance-identifier facility-prod-db-restored

# ステップ4: 復元されたデータを確認
psql -h facility-prod-db-restored.xxxxxxxx.ap-northeast-1.rds.amazonaws.com \
  -U admin -d facility

# ステップ5: 誤削除されたデータをエクスポート
pg_dump -h facility-prod-db-restored.xxxxxxxx.ap-northeast-1.rds.amazonaws.com \
  -U admin -d facility -t orders --data-only > recovered_data.sql

# ステップ6: 本番DBにインポート
psql -h facility-prod-db.xxxxxxxx.ap-northeast-1.rds.amazonaws.com \
  -U admin -d facility -f recovered_data.sql

# ステップ7: 復元用DBを削除（コスト削減）
aws rds delete-db-instance \
  --db-instance-identifier facility-prod-db-restored \
  --skip-final-snapshot
```

**所要時間**: 約30分

---

## FAQ

### Q1: デプロイ中にエラーが出た場合、自動でロールバックされますか？

**A**: はい、ECS Service には `DeploymentCircuitBreaker` が設定されています。ヘルスチェック失敗が続くと自動でロールバックされます。

---

### Q2: RDSのディスク容量を減らせますか？

**A**: いいえ、RDSのストレージは縮小できません。拡張のみ可能です。不要なデータは定期的に削除してください。

---

### Q3: メンテナンス時間外にデプロイできますか？

**A**: 技術的には可能ですが、推奨しません。ユーザーがアクセスしている時間帯はリスクが高いため、メンテナンス時間（日曜日、または平日夜間22:00-9:00）にデプロイしてください。

---

### Q4: CloudWatch Logsの保持期間を延長できますか？

**A**: はい、CloudFormationテンプレートで `RetentionInDays` を変更してください。ただし、コスト増加に注意。

---

### Q5: 障害発生時、どこに連絡すればいいですか？

**A**: 緊急連絡先（[運用手順書](02_運用手順書.md)参照）に従ってください。重大な障害は運用担当者 → システム管理者 → 開発チームの順にエスカレーション。

---

### Q6: CloudFrontのキャッシュをクリアする頻度は？

**A**: フロントエンド（SPA）のデプロイ時のみ。頻繁にクリアすると課金されます（月間1,000回まで無料）。

---

### Q7: IAMアクセスキーが漏洩した場合の対処は？

**A**:

1. 即座にアクセスキーを無効化
2. 新しいアクセスキーを作成
3. GitHub Secretsを更新
4. CloudTrailでアクセスキーの使用履歴を確認
5. 不正な操作があればAWSサポートに連絡

---

**作成者**: SRE（Claude）
**承認者**: （未定）
**最終更新**: 2025-10-25
