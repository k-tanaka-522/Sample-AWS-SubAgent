# デプロイ手順書: 役所設備管理システム

**作成日**: 2025-10-25
**バージョン**: 1.0
**対象読者**: SRE、インフラ担当者

---

## 目次

1. [概要](#概要)
2. [前提条件](#前提条件)
3. [デプロイ手順（CloudFormation）](#デプロイ手順cloudformation)
4. [デプロイ手順（アプリケーション）](#デプロイ手順アプリケーション)
5. [ロールバック手順](#ロールバック手順)
6. [トラブルシューティング](#トラブルシューティング)

---

## 概要

本ドキュメントは、役所設備管理システムのデプロイ手順を記載する。

### デプロイ対象

- **インフラ**: CloudFormation（VPC、RDS、ECS、ALB等）
- **アプリケーション**: Docker イメージ（ECR→ECS）
- **環境**: Dev、Stg、Prod

### デプロイ頻度

- **定期デプロイ**: 週1回（日曜日 深夜2:00-3:00）
- **緊急デプロイ**: 必要に応じて（平日夜間22:00-9:00）

### メンテナンス時間

- **日曜日**: 完全停止（デプロイ可能）
- **平日夜間**: 22:00-9:00（デプロイ可能）

---

## 前提条件

### 必要なツール

- AWS CLI (version 2.x)
- Docker (version 20.x以降)
- Git
- bash（スクリプト実行用）

### AWS認証情報

```bash
# AWS CLI設定確認
aws configure list

# 必要な権限
# - CloudFormation: フルアクセス
# - ECR: プッシュ権限
# - ECS: サービス更新権限
```

### S3バケット（ネステッドテンプレート保管用）

```bash
# Dev環境
facility-cloudformation-templates-dev

# Stg環境
facility-cloudformation-templates-stg

# Prod環境
facility-cloudformation-templates-prod
```

**事前作成**: デプロイ前にS3バケットを手動作成してください。

---

## デプロイ手順（CloudFormation）

### 1. 初回デプロイ（全スタック一括）

#### Dev環境

```bash
cd infra/cloudformation/service

# すべてのスタックを依存関係順にデプロイ
./scripts/deploy-all.sh dev
```

**デプロイ順序**:
1. network（VPC、Subnet、Security Groups）
2. database（RDS PostgreSQL）
3. auth（Cognito）
4. compute（ECS、ALB）
5. frontend（S3、CloudFront）
6. monitoring（CloudWatch、SNS）
7. batch（EventBridge）

**所要時間**: 約30-40分

#### Stg環境

```bash
./scripts/deploy-all.sh stg
```

#### Prod環境

```bash
# ⚠️ 本番環境デプロイは承認プロンプトが表示されます
./scripts/deploy-all.sh prod
```

---

### 2. 個別スタックデプロイ

特定のスタックのみ更新する場合：

#### dry-run（変更内容確認のみ）

```bash
# Change Set作成
./scripts/create-changeset.sh dev network

# 変更内容確認（実行はしない）
./scripts/describe-changeset.sh dev network
```

#### デプロイ実行

```bash
# Change Set実行
./scripts/execute-changeset.sh dev network
```

#### 一括実行（Change Set作成→確認→実行）

```bash
./scripts/deploy.sh dev network
```

---

### 3. 環境差分の確認

環境ごとのパラメータは `parameters/{env}.json` で管理：

```bash
# Dev環境のパラメータ
cat parameters/dev.json

# Prod環境のパラメータ
cat parameters/prod.json
```

**主な差分**:
- VPC CIDR（10.0.0.0/16、10.1.0.0/16、10.2.0.0/16）
- RDS インスタンスタイプ（db.t4g.micro、db.t4g.small、db.t4g.medium）
- RDS Multi-AZ（Dev: 無効、Stg/Prod: 有効）
- ECS タスク数（Dev: 1、Prod: 2-10）

---

## デプロイ手順（アプリケーション）

### 1. Dockerイメージのビルド・プッシュ

#### 職員向けAPI

```bash
cd app/staff-api

# Dockerイメージビルド
docker build -t staff-api:latest .

# ECRログイン
aws ecr get-login-password --region ap-northeast-1 | \
  docker login --username AWS --password-stdin <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com

# タグ付け
docker tag staff-api:latest <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/staff-api:latest
docker tag staff-api:latest <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/staff-api:$(git rev-parse --short HEAD)

# プッシュ
docker push <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/staff-api:latest
docker push <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/staff-api:$(git rev-parse --short HEAD)
```

#### 事業者向けAPI

```bash
cd app/vendor-api

docker build -t vendor-api:latest .
docker tag vendor-api:latest <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/vendor-api:latest
docker push <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/vendor-api:latest
```

#### バッチ

```bash
cd app/batch

docker build -t batch:latest .
docker tag batch:latest <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/batch:latest
docker push <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/batch:latest
```

---

### 2. ECS サービス更新（ローリングアップデート）

#### 職員向けAPI

```bash
aws ecs update-service \
  --cluster facility-prod-cluster \
  --service staff-api \
  --force-new-deployment
```

**デプロイフロー**:
1. 新タスク起動（旧2 + 新1 = 3タスク）
2. ヘルスチェック成功確認
3. 旧タスク1つ停止（旧1 + 新1 = 2タスク）
4. 新タスクもう1つ起動（旧1 + 新2 = 3タスク）
5. 旧タスク停止（新2タスク）

**所要時間**: 約5-10分

#### デプロイ失敗時の自動ロールバック

`DeploymentCircuitBreaker` が有効なため、以下の場合に自動ロールバック：
- ヘルスチェック連続失敗
- タスク起動失敗

---

### 3. GitHub Actions による自動デプロイ

`.github/workflows/deploy-service-prod.yml` を使用：

```yaml
on:
  push:
    branches:
      - main
    paths:
      - 'app/staff-api/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Build and push
        # ... ECRプッシュ
      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster facility-prod-cluster \
            --service staff-api \
            --force-new-deployment
```

---

## ロールバック手順

### 1. CloudFormation ロールバック

```bash
cd infra/cloudformation/service

# スタックをロールバック
./scripts/rollback.sh prod compute
```

**条件**: スタック状態が `UPDATE_FAILED` または `UPDATE_ROLLBACK_FAILED`

---

### 2. ECS タスク定義ロールバック

前のタスク定義に戻す：

```bash
# 現在のタスク定義確認
aws ecs describe-services \
  --cluster facility-prod-cluster \
  --services staff-api \
  --query 'services[0].taskDefinition'

# 前のタスク定義に戻す
aws ecs update-service \
  --cluster facility-prod-cluster \
  --service staff-api \
  --task-definition facility-prod-staff-api:42  # 前のリビジョン番号
```

**所要時間**: 約5分

---

### 3. RDS スナップショットからの復元

#### 手動スナップショットから復元

```bash
# スナップショット一覧
aws rds describe-db-snapshots \
  --db-instance-identifier facility-prod-db \
  --query 'DBSnapshots[*].[DBSnapshotIdentifier,SnapshotCreateTime]' \
  --output table

# スナップショットから復元
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier facility-prod-db-restored \
  --db-snapshot-identifier facility-prod-db-manual-20251025-1400 \
  --db-subnet-group-name facility-prod-db-subnet-group \
  --vpc-security-group-ids sg-xxxxx
```

#### PITR（ポイントインタイムリカバリ）

```bash
# 特定時刻に復元
aws rds restore-db-instance-to-point-in-time \
  --source-db-instance-identifier facility-prod-db \
  --target-db-instance-identifier facility-prod-db-pitr \
  --restore-time 2025-10-25T10:30:00Z
```

---

## トラブルシューティング

### 問題1: Change Set作成失敗

**症状**: `aws cloudformation create-change-set` がエラー

**原因**:
- テンプレート構文エラー
- パラメータ不足

**対処**:
```bash
# テンプレート検証
./scripts/validate.sh

# エラー詳細確認
aws cloudformation describe-change-set \
  --stack-name facility-prod-network \
  --change-set-name <changeset-name>
```

---

### 問題2: ECS タスク起動失敗

**症状**: タスクが `RUNNING` にならない

**原因**:
- Dockerイメージ取得失敗
- ヘルスチェック失敗
- DB接続失敗

**対処**:
```bash
# タスクログ確認
aws logs tail /ecs/staff-api --follow

# タスク停止理由確認
aws ecs describe-tasks \
  --cluster facility-prod-cluster \
  --tasks <task-id> \
  --query 'tasks[0].stoppedReason'
```

---

### 問題3: RDS接続エラー

**症状**: アプリケーションからRDS接続失敗

**原因**:
- Security Group設定ミス
- Secrets Manager シークレット不正

**対処**:
```bash
# Security Group確認
aws ec2 describe-security-groups \
  --group-ids sg-xxxxx

# Secrets Manager確認
aws secretsmanager get-secret-value \
  --secret-id facility-prod-db-secret
```

---

## チェックリスト

### デプロイ前

- [ ] デプロイ対象の変更内容を確認
- [ ] Change Set で変更内容をdry-run
- [ ] バックアップ（RDS手動スナップショット）
- [ ] メンテナンス時間内か確認

### デプロイ中

- [ ] CloudWatch Logsでエラー監視
- [ ] ECS タスク起動状況確認
- [ ] ALB ヘルスチェック状況確認

### デプロイ後

- [ ] ヘルスチェックエンドポイント確認
- [ ] APIエンドポイント動作確認
- [ ] CloudWatch Alarmsの状態確認
- [ ] アクセスログ確認

---

**作成者**: SRE（Claude）
**承認者**: （未定）
**最終更新**: 2025-10-25
