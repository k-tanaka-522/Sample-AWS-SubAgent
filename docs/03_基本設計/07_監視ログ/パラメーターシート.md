# 監視ログ - パラメーターシート

**作成日**: 2025-10-25
**バージョン**: 1.4
**ステータス**: ユーザー承認完了、実装開始

**更新履歴**:
- v1.4 (2025-10-25): AWS X-Ray パラメーター追加
- v1.3 (2025-10-25): 組織レベル監査サービス追加
- v1.2 (2025-10-25): Container Insights 設定追加
- v1.1 (2025-10-25): 初版作成

---

## 概要

このドキュメントは、CloudWatch監視・アラート、ログ保管、AWS X-Ray に関するCloudFormation実装時に参照する設定値を環境別にまとめたものです。

---

## 6. 監視・ログパラメーター

### 6.1 CloudWatch Alarms 閾値（prod環境）

| メトリクス | 閾値 | 評価期間 | 通知先 |
|-----------|------|---------|--------|
| ECS CPU使用率 | 80%以上 | 2分間連続 | SNS Topic |
| ECS メモリ使用率 | 80%以上 | 2分間連続 | SNS Topic |
| RDS CPU使用率 | 80%以上 | 5分間連続 | SNS Topic |
| RDS フリーストレージ容量 | 10GB以下 | 1回 | SNS Topic |
| RDS 接続数 | 160以上（最大200の80%） | 1回 | SNS Topic |
| ALB TargetResponseTime | 95%ile > 1秒 | 2分間連続 | SNS Topic |
| ALB HTTPCode_Target_5XX | 5%以上 | 2分間連続 | SNS Topic |
| **X-Ray エラー率** | **5%以上** | **2分間連続** | **SNS Topic** |
| **X-Ray レスポンスタイム（95%ile）** | **500ms超過** | **2分間連続** | **SNS Topic** |

### 6.2 ログ保管期間

| ログ種別 | CloudWatch保持期間 | S3保持期間 | S3ライフサイクル |
|---------|-------------------|-----------|----------------|
| ECS アプリケーションログ | 3ヶ月 | 2年 | 3ヶ月～1年: Standard<br/>1年～2年: Glacier |
| RDS PostgreSQLログ | 3ヶ月 | 2年 | 同上 |
| ALB アクセスログ | - | 2年 | 同上 |
| VPCフローログ | 1ヶ月 | 1年 | - |
| CloudTrail | - | 2年 | 同上 |
| **X-Ray トレースデータ** | **30日** | **-** | **-** |

### 6.3 SNS Topic 設定

| Topic 名 | 用途 | サブスクリプション | 備考 |
|---------|------|---------------|------|
| facilities-prod-alerts | 本番環境アラート | Email（運用チーム） | 重要度: 高 |
| facilities-stg-alerts | ステージング環境アラート | Email（開発チーム） | 重要度: 中 |
| facilities-dev-alerts | 開発環境アラート | Email（開発チーム） | 重要度: 低 |

### 6.4 CloudWatch Container Insights

| 環境 | 有効化 | 保持期間 | 備考 |
|------|-------|---------|------|
| dev | 有効 | 3日 | コスト削減 |
| stg | 有効 | 7日 | 検証用 |
| prod | 有効 | 30日 | 本番運用 |

### 6.5 AWS X-Ray 設定

#### 6.5.1 X-Ray サンプリングルール

| 環境 | サンプリング率 | 保持期間 | 備考 |
|------|-------------|---------|------|
| dev | 100% | 30日 | デバッグ用、全トレース |
| stg | 10% | 30日 | 検証用、コスト削減 |
| prod | 5% | 30日 | コスト最適化、統計的に十分 |

#### 6.5.2 X-Ray サイドカーコンテナ設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| イメージ | `public.ecr.aws/xray/aws-xray-daemon:latest` | 公式イメージ |
| CPU | 32 | 軽量（0.03125 vCPU） |
| メモリ | 256MB | 軽量 |
| ポート | 2000/udp | X-Ray デーモン |
| ログ | CloudWatch Logs | `/ecs/xray-daemon` |

#### 6.5.3 X-Ray サンプリングルール詳細（prod環境）

| ルール名 | 条件 | サンプリング率 | 優先順位 | 備考 |
|---------|------|--------------|---------|------|
| error-sampling | HTTPステータス 5xx | 100% | 1 | すべてのエラーをトレース |
| high-latency-sampling | レスポンスタイム > 1秒 | 100% | 2 | パフォーマンス問題の特定 |
| default-sampling | すべて | 5% | 100 | 通常リクエスト |

#### 6.5.4 X-Ray IAM Permissions

**Task Execution Role に追加する権限**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "xray:PutTraceSegments",
        "xray:PutTelemetryRecords"
      ],
      "Resource": "*"
    }
  ]
}
```

#### 6.5.5 X-Ray 環境変数（ECS Task Definition）

**アプリケーションコンテナに追加**:
| 環境変数 | 設定値 | 備考 |
|---------|--------|------|
| `AWS_XRAY_DAEMON_ADDRESS` | `xray-daemon:2000` | サイドカーコンテナのホスト名 |
| `AWS_XRAY_CONTEXT_MISSING` | `LOG_ERROR` | トレースコンテキストがない場合はログ出力 |
| `AWS_XRAY_TRACING_NAME` | `facilities-staff-api` | サービス名（X-Ray Service Map で表示） |

#### 6.5.6 X-Ray CloudWatch Alarms（prod環境）

**CloudFormation YAML 例**:
```yaml
# X-Ray エラー率アラーム
XRayErrorRateAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: facilities-prod-xray-error-rate
    MetricName: ErrorRate
    Namespace: AWS/XRay
    Statistic: Average
    Period: 120
    EvaluationPeriods: 2
    Threshold: 5.0
    ComparisonOperator: GreaterThanThreshold
    AlarmActions:
      - !Ref AlertsSNSTopic

# X-Ray レスポンスタイムアラーム（95%ile）
XRayLatencyAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: facilities-prod-xray-latency-p95
    MetricName: ApproximateLatency
    Namespace: AWS/XRay
    ExtendedStatistic: p95
    Period: 120
    EvaluationPeriods: 2
    Threshold: 500.0
    ComparisonOperator: GreaterThanThreshold
    AlarmActions:
      - !Ref AlertsSNSTopic
```

---

## 0.8 組織レベル監査・セキュリティサービス（Shared Account）

| サービス | 設定 | 保存先 | 備考 |
|---------|------|--------|------|
| **CloudTrail（組織）** | 有効 | s3://facilities-shared-logs/cloudtrail/ | 組織全体のAPI呼び出し記録 |
| **Config（組織）** | 有効 | s3://facilities-shared-logs/config/ | リソース設定変更記録 |
| **GuardDuty（組織）** | 有効 | SNS: facilities-shared-security-alerts | 脅威検知 |
| **Security Hub（組織）** | 有効 | SNS: facilities-shared-security-alerts | セキュリティ統合 |

---

**作成者**: SRE（PM 委譲タスク）+ architect（X-Ray設計）
**最終更新**: 2025-10-25
