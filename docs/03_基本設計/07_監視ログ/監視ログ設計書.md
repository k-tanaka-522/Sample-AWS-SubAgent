# 07. 監視ログ設計

**作成日**: 2025-10-25
**バージョン**: 1.1
**ステータス**: PM レビュー待ち

**更新履歴**:
- v1.1 (2025-10-25): 設定値を削除、設計理由と設計アプローチのみに簡潔化
- v1.0 (2025-10-25): 初版作成

---

## 7.1 監視設計概要

### 監視の目的

1. **障害の早期検知**: システム障害を即座に検知し、迅速に対応
2. **性能監視**: レスポンスタイム、スループットの継続的な監視
3. **コスト監視**: AWS利用料の予算超過を防止
4. **セキュリティ監視**: 不正アクセスや異常なアクセスパターンの検知

### 設計方針

**4つの監視レイヤー**:
1. **アプリケーション層**: ECS タスクのCPU、メモリ、ログ
2. **データベース層**: RDS のCPU、接続数、スロークエリ
3. **ネットワーク層**: ALB のレスポンスタイム、エラー率
4. **セキュリティ層**: VPCフローログ、CloudTrail、不正アクセス検知

---

## 7.2 CloudWatch メトリクス監視

### 監視設計の考え方

**監視対象の選定基準**:
- **Critical**: サービス停止に直結するメトリクス（ECS タスク数、RDS 接続不可等）
- **High**: パフォーマンス劣化を示すメトリクス（CPU 80%、メモリ 80%等）
- **Medium**: コスト最適化に関連するメトリクス（予算超過警告）

**閾値の考え方**:
- CPU/メモリ: 80%（スケールアウト検討のタイミング）
- レスポンスタイム: 95%ile > 1秒（ユーザー体験悪化の指標）
- エラー率: 5%（アプリケーション異常の指標）

**アラート評価期間**:
- ECS: 2分間連続（一時的なスパイクを無視）
- RDS: 5分間連続（より慎重な判断）
- ALB: 2分間連続（ユーザー影響が大きいため早期検知）

**具体的な閾値、評価期間の詳細は、`05_実装準備/パラメーターシート.xlsx` を参照してください。**

---

## 7.3 CloudWatch Logs 設計

### ログ設計の考え方

**ログ保管の方針**:
- **直近3ヶ月**: CloudWatch Logs に保持（リアルタイム検索）
- **3ヶ月以降**: S3 にエクスポート（長期保管、コスト削減）
- **2年経過**: 削除（監査要件を満たしたら削除）

**ログのライフサイクル**:
```mermaid
graph LR
    A["CloudWatch Logs<br/>(直近3ヶ月)"] -->|エクスポート| B["S3 Standard<br/>(3ヶ月～1年)"]
    B -->|移行| C["S3 Glacier<br/>(1年～2年)"]
    C -->|削除| D["削除<br/>(2年経過)"]

    style A fill:#e6f3ff
    style B fill:#ffe6e6
    style C fill:#fff3e6
    style D fill:#f0f0f0
```

**具体的なロググループ名、保管期間の日数等は、パラメーターシートを参照してください。**

---

## 7.4 アプリケーションログの構造化

### 構造化ログの設計方針

**JSON形式のログ**を推奨します：

```json
{
  "timestamp": "2025-10-25T10:30:00.123Z",
  "level": "INFO",
  "service": "staff-api",
  "traceId": "abc123def456",
  "userId": "EMP001",
  "action": "equipment.create",
  "method": "POST",
  "path": "/api/equipment",
  "statusCode": 201,
  "responseTime": 150,
  "message": "Equipment created successfully"
}
```

**構造化ログのメリット**:
- CloudWatch Logs Insights で高速検索
- 特定のユーザー、エンドポイント、エラーに絞り込み可能
- トレーシング（traceId）による分散トレーシング

**ログレベルの使い分け**:
- **DEBUG**: 開発時のデバッグ情報
- **INFO**: 通常の動作ログ（本番環境はINFO以上）
- **WARN**: 警告（エラーではない）
- **ERROR**: エラー
- **FATAL**: 致命的エラー

---

## 7.5 CloudWatch Alarms 設計

### アラーム設計の考え方

**アラーム作成の基準**:
- **Critical**: サービス停止に直結（ECS タスク数 0、RDS 接続不可）
- **High**: パフォーマンス劣化（CPU 80%、メモリ 80%、レスポンスタイム 1秒超）
- **Medium**: 予算超過警告（コスト監視）

**通知先の設計**:
- SNS Topic 経由でメール、Slack、Teams に通知
- 複数の通知手段により、見逃しを防止

**具体的なアラーム定義（CloudFormation YAML）、閾値、評価期間等は、パラメーターシートを参照してください。**

---

## 7.6 SNS 通知設計

### 通知設計の考え方

**3つのSNS Topic**:
1. **facilities-prod-alerts**: 障害・警告アラート（インフラチーム）
2. **facilities-prod-billing**: コスト関連アラート（財務担当）
3. **facilities-prod-security**: セキュリティアラート（セキュリティチーム）

**通知手段の多様化**:
- メール: 正式な通知（記録に残る）
- Slack: リアルタイム通知（チームでの共有）
- Microsoft Teams: 組織標準のツール

**通知フロー**:
```mermaid
sequenceDiagram
    participant CW as CloudWatch Alarm
    participant SNS as SNS Topic
    participant Email as メール
    participant Slack as Slack
    participant Teams as Teams

    CW->>CW: 閾値超過検知
    CW->>SNS: アラーム発火
    SNS->>Email: 通知送信
    SNS->>Slack: 通知送信
    SNS->>Teams: 通知送信
```

**具体的なSNS Topic ARN、サブスクリプションのメールアドレス、Webhook URL等は、パラメーターシートを参照してください。**

---

## 7.7 VPCフローログ設計

### VPCフローログの設計方針

**監視目的**:
1. **不正アクセスの検知**: 異常なIPアドレスからのアクセス
2. **ネットワークトラブルシューティング**: 通信失敗の原因調査
3. **セキュリティ監査**: すべてのネットワーク通信の記録

**設計アプローチ**:
- VPC全体を監視対象とする
- すべてのトラフィック（許可・拒否）を記録
- CloudWatch Logs に送信（リアルタイム監視）

**具体的なVPCフローログ設定、ロググループ名、保管期間等は、パラメーターシートを参照してください。**

---

## 7.8 CloudTrail 設計

### CloudTrail の設計方針

**監査目的**:
1. **監査**: すべてのAWS API呼び出しを記録
2. **セキュリティインシデント調査**: 不正なAPI呼び出しの検出
3. **コンプライアンス**: ISMAP準拠の証跡管理

**設計アプローチ**:
- すべてのリージョンで有効化（マルチリージョン対応）
- ログファイル検証有効化（改ざん検知）
- S3 に保存、CloudWatch Logs にも配信（リアルタイム監視）
- データイベント記録（S3、Lambda のオブジェクトレベルのAPI呼び出し）

**具体的なCloudTrail 証跡名、S3バケット名、保管期間等は、パラメーターシートを参照してください。**

---

## 7.9 AWS Billing Alerts

### コスト監視の設計方針

**予算超過の早期検知**:
- 予算の50%、80%、100%で段階的にアラート
- 財務担当にメール通知
- コスト最適化の検討タイミングを明確化

**具体的な予算額、閾値、通知先等は、パラメーターシートを参照してください。**

---

## 7.10 ダッシュボード設計

### CloudWatch Dashboard の設計方針

**1つのメインダッシュボードに統合**:
- ECS: CPU使用率、メモリ使用率、タスク数
- RDS: CPU使用率、接続数、フリーストレージ容量
- ALB: レスポンスタイム、5xxエラー数、リクエスト数

**ダッシュボードのメリット**:
- システム全体の状態を一目で把握
- 障害発生時の迅速な原因特定
- 性能監視（パフォーマンスチューニングの材料）

**具体的なダッシュボード名、ウィジェット構成等は、パラメーターシートを参照してください。**

---

## 7.11 ヒアリング結果と仮決定

### 仮決定事項

以下の項目は、本来ユーザーに確認すべきですが、合理的な仮決定をしました：

| 項目 | 仮決定内容 | 理由 | ユーザー確認推奨度 |
|------|----------|------|------------------|
| アラート閾値（CPU） | 80% | 一般的な閾値、スケールアウト検討のタイミング | 中 |
| アラート閾値（メモリ） | 80% | 一般的な閾値、メモリリーク検知 | 中 |
| ログ保管期間（CloudWatch） | 3ヶ月 | コストとリアルタイム検索のバランス | 低 |
| ログ保管期間（S3） | 2年 | ISMAP監査要件を考慮 | 低 |
| SNS 通知先 | メール、Slack、Teams | 多様な通知手段で見逃し防止 | 中 |
| CloudWatch Dashboard 構成 | メインダッシュボード1つ | シンプルな構成、運用しやすい | 低 |

---

**作成者**: architect サブエージェント
**最終更新**: 2025-10-25
