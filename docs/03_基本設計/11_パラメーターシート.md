# 11. パラメーターシート

**作成日**: 2025-10-25
**バージョン**: 1.1
**ステータス**: PM レビュー待ち

**更新履歴**:
- v1.1 (2025-10-25): Shared Account パラメーター追加（Transit Gateway、Direct Connect、Organizations）
- v1.0 (2025-10-25): 初版作成

---

## 概要

このドキュメントは、CloudFormation実装時に参照する設定値を環境別・アカウント別にまとめたパラメーターシートです。

本プロジェクトは **マルチアカウント構成** を採用しており、以下の2アカウントで構成されます：
- **Shared Account**: ネットワークハブ（Transit Gateway、Direct Connect）、組織レベル監査基盤
- **Service Account**: アプリケーション実行環境（ECS、RDS、ALB等）

---

## 0. Shared Account パラメーター

### 0.1 AWS Organizations

| 項目 | 設定値 | 備考 |
|------|--------|------|
| 管理アカウント | Shared Account | AWS Organizations の管理アカウント |
| 組織ユニット (OU) | ou=shared, ou=services | Shared Account と Service Account を分離 |
| メンバーアカウント | Service Account | 設備管理サービス用アカウント |

### 0.2 Transit Gateway

| 項目 | 設定値 | 備考 |
|------|--------|------|
| Transit Gateway ID | tgw-XXXXXXXXXXXX | 実装時に生成 |
| ASN | 64512 | プライベートASN |
| CIDR ブロック | - | ルーティングのみ使用 |
| デフォルトルートテーブル関連付け | 無効 | 手動ルートテーブル管理 |
| デフォルトルートテーブル伝播 | 無効 | 手動ルート伝播管理 |
| DNS サポート | 有効 | VPC間DNS解決 |
| VPN ECMP サポート | 有効 | 将来の冗長化対応 |
| マルチキャストサポート | 無効 | 不要 |

### 0.3 Transit Gateway Route Table

| Route Table 名 | アタッチメント | ルート先 | ターゲット | 備考 |
|---------------|-------------|---------|----------|------|
| tgw-rtb-on-premises | Direct Connect Gateway | 10.0.0.0/16, 10.1.0.0/16, 10.2.0.0/16 | Service VPC Attachments | 拠点 → Service VPC |
| tgw-rtb-service-vpc | Service VPC Attachments (dev/stg/prod) | 172.16.0.0/16 | Direct Connect Gateway | Service VPC → 拠点 |

### 0.4 Direct Connect

| 項目 | 設定値 | 備考 |
|------|--------|------|
| 接続名 | facilities-dx-100mbps | |
| 接続タイプ | Hosted Connection | パートナー経由 |
| 帯域幅 | 100Mbps | 初期値（将来的に1Gbps拡張可能） |
| ロケーション | 東京（Equinix TY2等） | パートナーによる |
| VLAN ID | XXXX | パートナー提供 |

### 0.5 Direct Connect Gateway

| 項目 | 設定値 | 備考 |
|------|--------|------|
| Direct Connect Gateway ID | dxgw-XXXXXXXXXXXX | 実装時に生成 |
| 名前 | facilities-dxgw | |
| ASN | 64512 | Transit Gateway と同じASN |
| 関連付け | Transit Gateway (tgw-XXXXXXXXXXXX) | |

### 0.6 Transit Virtual Interface (VIF)

| 項目 | 設定値 | 備考 |
|------|--------|------|
| VIF 名 | facilities-transit-vif | |
| VIF タイプ | Transit | Transit Gateway 接続用 |
| VLAN | XXXX | Direct Connect と同じVLAN |
| BGP ASN（AWS側） | 64512 | Transit Gateway ASN |
| BGP ASN（拠点側） | 65000 | 拠点のASN（仮） |
| BGP 認証キー | (Secrets Manager で管理) | MD5認証 |
| アドレスファミリー | IPv4 | |
| AWS 側 BGP IP | 169.254.1.1/30 | Link-local アドレス |
| 拠点側 BGP IP | 169.254.1.2/30 | Link-local アドレス |
| 広告プレフィックス（AWS → 拠点） | 10.0.0.0/16, 10.1.0.0/16, 10.2.0.0/16 | Service VPC CIDR |
| 広告プレフィックス（拠点 → AWS） | 172.16.0.0/16 | 拠点CIDR |

### 0.7 拠点CIDR設計

| 拠点 | CIDR | IPアドレス数 | 備考 |
|------|------|-------------|------|
| **拠点ネットワーク（集約）** | 172.16.0.0/16 | 65,536 | 20拠点の集約CIDR |
| 拠点01 | 172.16.1.0/24 | 256 | 端末100台 + 余裕 |
| 拠点02 | 172.16.2.0/24 | 256 | 端末100台 + 余裕 |
| 拠点03 | 172.16.3.0/24 | 256 | 端末100台 + 余裕 |
| 拠点04～20 | 172.16.4.0/24 ～ 172.16.20.0/24 | 256 | 各拠点 /24 を割り当て |

### 0.8 組織レベル監査・セキュリティサービス

| サービス | 設定 | 保存先 | 備考 |
|---------|------|--------|------|
| **CloudTrail（組織）** | 有効 | s3://facilities-shared-logs/cloudtrail/ | 組織全体のAPI呼び出し記録 |
| **Config（組織）** | 有効 | s3://facilities-shared-logs/config/ | リソース設定変更記録 |
| **GuardDuty（組織）** | 有効 | SNS: facilities-shared-security-alerts | 脅威検知 |
| **Security Hub（組織）** | 有効 | SNS: facilities-shared-security-alerts | セキュリティ統合 |

### 0.9 Resource Access Manager (RAM) 共有

| 共有リソース | 共有先 | 備考 |
|----------|--------|------|
| Transit Gateway | Service Account | VPC Attachment 作成のため共有 |

---

## 1. Service Account ネットワークパラメーター

### 1.1 VPC CIDR

| 環境 | VPC CIDR | IPアドレス数 | 備考 |
|------|----------|-------------|------|
| dev | 10.0.0.0/16 | 65,536 | 開発環境 |
| stg | 10.1.0.0/16 | 65,536 | ステージング環境 |
| prod | 10.2.0.0/16 | 65,536 | 本番環境 |

### 1.2 サブネット設計（dev環境: 10.0.0.0/16）

| サブネット種別 | AZ | CIDR | 用途 | IPアドレス数 |
|-------------|----|----|------|-------------|
| Public Subnet 1 | ap-northeast-1a | 10.0.0.0/24 | ALB、NAT Gateway | 256 |
| Private Subnet 1 | ap-northeast-1a | 10.0.2.0/24 | ECS Fargate | 256 |
| DB Subnet 1 | ap-northeast-1a | 10.0.4.0/24 | RDS PostgreSQL | 256 |

**注**: dev環境はシングルAZ構成でコスト削減

### 1.3 サブネット設計（stg環境: 10.1.0.0/16）

| サブネット種別 | AZ | CIDR | 用途 | IPアドレス数 |
|-------------|----|----|------|-------------|
| Public Subnet 1 | ap-northeast-1a | 10.1.0.0/24 | ALB、NAT Gateway | 256 |
| Public Subnet 2 | ap-northeast-1c | 10.1.1.0/24 | ALB、NAT Gateway | 256 |
| Private Subnet 1 | ap-northeast-1a | 10.1.2.0/24 | ECS Fargate | 256 |
| Private Subnet 2 | ap-northeast-1c | 10.1.3.0/24 | ECS Fargate | 256 |
| DB Subnet 1 | ap-northeast-1a | 10.1.4.0/24 | RDS PostgreSQL | 256 |
| DB Subnet 2 | ap-northeast-1c | 10.1.5.0/24 | RDS PostgreSQL | 256 |

### 1.4 サブネット設計（prod環境: 10.2.0.0/16）

| サブネット種別 | AZ | CIDR | 用途 | IPアドレス数 |
|-------------|----|----|------|-------------|
| Public Subnet 1 | ap-northeast-1a | 10.2.0.0/24 | ALB、NAT Gateway | 256 |
| Public Subnet 2 | ap-northeast-1c | 10.2.1.0/24 | ALB、NAT Gateway | 256 |
| Private Subnet 1 | ap-northeast-1a | 10.2.2.0/24 | ECS Fargate | 256 |
| Private Subnet 2 | ap-northeast-1c | 10.2.3.0/24 | ECS Fargate | 256 |
| DB Subnet 1 | ap-northeast-1a | 10.2.4.0/24 | RDS PostgreSQL | 256 |
| DB Subnet 2 | ap-northeast-1c | 10.2.5.0/24 | RDS PostgreSQL | 256 |

### 1.5 NAT Gateway 配置

| 環境 | NAT Gateway 1 (AZ-a) | NAT Gateway 2 (AZ-c) | 備考 |
|------|---------------------|---------------------|------|
| dev | Public Subnet 1 (10.0.0.0/24) | - | シングルAZ構成 |
| stg | Public Subnet 1 (10.1.0.0/24) | Public Subnet 2 (10.1.1.0/24) | マルチAZ構成 |
| prod | Public Subnet 1 (10.2.0.0/24) | Public Subnet 2 (10.2.1.0/24) | マルチAZ構成 |

---

## 2. ECS Fargateパラメーター

### 2.1 ECS Cluster

| 環境 | Cluster 名 | キャパシティプロバイダー | Container Insights |
|------|-----------|----------------------|-------------------|
| dev | facilities-dev-cluster | FARGATE, FARGATE_SPOT | 有効 |
| stg | facilities-stg-cluster | FARGATE, FARGATE_SPOT | 有効 |
| prod | facilities-prod-cluster | FARGATE | 有効 |

### 2.2 ECS Task Definition（業務アプリ: staff-api）

| 環境 | Task Definition名 | CPU | メモリ | ポート | 備考 |
|------|------------------|-----|--------|--------|------|
| dev | facilities-staff-api | 0.25 vCPU (256) | 0.5GB (512) | 3000 | 開発用最小構成 |
| stg | facilities-staff-api | 0.25 vCPU (256) | 0.5GB (512) | 3000 | 検証用 |
| prod | facilities-staff-api | 0.5 vCPU (512) | 1GB (1024) | 3000 | 本番用 |

### 2.3 ECS Task Definition（事業者アプリ: vendor-api）

| 環境 | Task Definition名 | CPU | メモリ | ポート | 備考 |
|------|------------------|-----|--------|--------|------|
| dev | facilities-vendor-api | 0.25 vCPU (256) | 0.5GB (512) | 3000 | 開発用最小構成 |
| stg | facilities-vendor-api | 0.25 vCPU (256) | 0.5GB (512) | 3000 | 検証用 |
| prod | facilities-vendor-api | 0.5 vCPU (512) | 1GB (1024) | 3000 | 本番用 |

### 2.4 ECS Task Definition（バッチ: batch）

| 環境 | Task Definition名 | CPU | メモリ | 備考 |
|------|------------------|-----|--------|------|
| dev | facilities-batch | 0.25 vCPU (256) | 0.5GB (512) | 開発用最小構成 |
| stg | facilities-batch | 1 vCPU (1024) | 2GB (2048) | 検証用 |
| prod | facilities-batch | 2 vCPU (2048) | 4GB (4096) | 本番用（大量データ処理） |

### 2.5 ECS Service（タスク数）

| 環境 | staff-api タスク数 | vendor-api タスク数 | batch タスク数 | 備考 |
|------|------------------|-------------------|--------------|------|
| dev | 1（固定） | 1（固定） | 手動起動 | シングルタスク |
| stg | 2（固定） | 2（固定） | 手動起動 | マルチAZ |
| prod | 2-5（オートスケーリング） | 2-5（オートスケーリング） | 手動起動 | CPU 70%でスケール |

### 2.6 オートスケーリング設定（prod環境）

| パラメーター | staff-api | vendor-api | 備考 |
|------------|----------|-----------|------|
| 最小タスク数 | 2 | 2 | 通常時 |
| 最大タスク数 | 5 | 5 | ピーク時 |
| スケールアウト閾値 | CPU 70% | CPU 70% | 2分間連続 |
| スケールイン閾値 | CPU 50% | CPU 50% | 5分間連続 |
| クールダウン期間 | 300秒 | 300秒 | 頻繁なスケール防止 |

---

## 3. RDS PostgreSQLパラメーター

### 3.1 RDS インスタンス

| 環境 | インスタンス識別子 | インスタンスタイプ | vCPU | メモリ | ストレージ | マルチAZ |
|------|------------------|------------------|------|--------|----------|---------|
| dev | facilities-dev-db | db.t4g.micro | 2 | 1GB | 20GB (gp3) | 無効 |
| stg | facilities-stg-db | db.t4g.small | 2 | 2GB | 50GB (gp3) | 有効 |
| prod | facilities-prod-db | db.t4g.medium | 2 | 4GB | 100GB (gp3) | 有効 |

### 3.2 RDS データベース設定

| パラメーター | 設定値 | 備考 |
|------------|--------|------|
| エンジン | PostgreSQL | |
| エンジンバージョン | 14.11 | 安定版 |
| データベース名 | facilities | |
| マスターユーザー名 | admin | Secrets Managerで管理 |
| ポート | 5432 | PostgreSQLデフォルト |

### 3.3 RDS バックアップ設定

| 環境 | バックアップ保持期間 | PITR保持期間 | バックアップウィンドウ（UTC） | バックアップウィンドウ（JST） |
|------|------------------|------------|------------------------|------------------------|
| dev | 7日 | 7日 | 17:00-18:00 | 02:00-03:00 |
| stg | 7日 | 7日 | 17:00-18:00 | 02:00-03:00 |
| prod | 7日 | 35日（最長） | 17:00-18:00 | 02:00-03:00 |

### 3.4 RDS メンテナンス設定

| 環境 | メンテナンスウィンドウ（UTC） | メンテナンスウィンドウ（JST） | 自動マイナーバージョンアップ |
|------|------------------------|------------------------|----------------------|
| dev | 日 17:00-18:00 | 日 02:00-03:00 | 有効 |
| stg | 日 17:00-18:00 | 日 02:00-03:00 | 有効 |
| prod | 日 17:00-18:00 | 日 02:00-03:00 | 有効 |

### 3.5 RDS パラメータグループ（カスタム）

| パラメーター | デフォルト値 | 推奨値 | 備考 |
|------------|------------|--------|------|
| max_connections | LEAST({DBInstanceClassMemory/9531392},5000) | 200 | 接続プーリング使用前提 |
| shared_buffers | {DBInstanceClassMemory/32768} | {DBInstanceClassMemory/16384} | キャッシュサイズ増加 |
| effective_cache_size | {DBInstanceClassMemory/16384} | {DBInstanceClassMemory*3/4} | クエリプランナーヒント |
| work_mem | 4MB | 16MB | ソート・ハッシュ処理 |
| maintenance_work_mem | GREATEST({DBInstanceClassMemory/63963136},65536) | 256MB | VACUUM、CREATE INDEX |
| log_statement | none | all | すべてのSQL文をログ出力 |
| log_min_duration_statement | -1 | 1000 | 1秒以上のスロークエリ |

---

## 4. ALB（Application Load Balancer）パラメーター

### 4.1 ALB 構成

| ALB名 | 環境 | スキーム | サブネット | リスナー | ターゲットグループ |
|-------|------|---------|----------|---------|----------------|
| facilities-staff-alb | prod | internal | Public 1, 2 | HTTPS 443 | staff-api-tg |
| facilities-vendor-alb | prod | internet-facing | Public 1, 2 | HTTPS 443 | vendor-api-tg |

### 4.2 ターゲットグループ設定

| ターゲットグループ名 | ターゲットタイプ | プロトコル | ポート | 登録解除の遅延 |
|-------------------|---------------|----------|--------|--------------|
| staff-api-tg | ip | HTTP | 3000 | 300秒 |
| vendor-api-tg | ip | HTTP | 3000 | 300秒 |

### 4.3 ヘルスチェック設定

| パラメーター | 設定値 | 備考 |
|------------|--------|------|
| ヘルスチェックパス | /health | |
| プロトコル | HTTP | |
| ポート | 3000 | |
| 間隔 | 30秒 | |
| タイムアウト | 5秒 | |
| 正常判定しきい値 | 2回連続成功 | |
| 異常判定しきい値 | 2回連続失敗 | |

---

## 5. Cognitoパラメーター

### 5.1 ユーザープール

| ユーザープール名 | 用途 | MFA | パスワードポリシー |
|---------------|------|-----|----------------|
| facilities-staff-pool | 職員認証 | 推奨（任意） | 最小8文字、英数字記号混在、90日ごと変更 |
| facilities-vendor-pool | 事業者認証 | 推奨（任意） | 最小8文字、英数字記号混在、90日ごと変更 |

### 5.2 JWT設定

| パラメーター | 設定値 | 備考 |
|------------|--------|------|
| トークン有効期限 | 30分 | |
| リフレッシュトークン有効期限 | 30日 | |

---

## 6. 監視・ログパラメーター

### 6.1 CloudWatch Alarms 閾値（prod環境）

| メトリクス | 閾値 | 評価期間 | 通知先 |
|-----------|------|---------|--------|
| ECS CPU使用率 | 80%以上 | 2分間連続 | SNS Topic |
| ECS メモリ使用率 | 80%以上 | 2分間連続 | SNS Topic |
| RDS CPU使用率 | 80%以上 | 5分間連続 | SNS Topic |
| RDS フリーストレージ容量 | 10GB以下 | 1回 | SNS Topic |
| RDS 接続数 | 160以上（最大200の80%） | 1回 | SNS Topic |
| ALB TargetResponseTime | 95%ile > 1秒 | 2分間連続 | SNS Topic |
| ALB HTTPCode_Target_5XX | 5%以上 | 2分間連続 | SNS Topic |

### 6.2 ログ保管期間

| ログ種別 | CloudWatch保持期間 | S3保持期間 | S3ライフサイクル |
|---------|-------------------|-----------|----------------|
| ECS アプリケーションログ | 3ヶ月 | 2年 | 3ヶ月～1年: Standard<br/>1年～2年: Glacier |
| RDS PostgreSQLログ | 3ヶ月 | 2年 | 同上 |
| ALB アクセスログ | - | 2年 | 同上 |
| VPCフローログ | 1ヶ月 | 1年 | - |
| CloudTrail | - | 2年 | 同上 |

---

## 7. バッチ処理スケジュール

### 7.1 EventBridge スケジュール（prod環境）

| バッチ処理 | スケジュール（cron） | 実行時刻（UTC） | 実行時刻（JST） | 備考 |
|----------|-------------------|--------------|--------------|------|
| 月次レポート生成 | cron(0 17 1 * ? *) | 毎月1日 17:00 | 毎月1日 02:00 | 深夜実行 |
| 年次レポート生成 | cron(0 17 1 1 ? *) | 毎年1月1日 17:00 | 毎年1月1日 02:00 | 深夜実行 |
| 発注期限アラート | cron(0 8 * * ? *) | 毎日 08:00 | 毎日 17:00 | 業務終了時 |

**注**: EventBridgeのスケジュール式はUTC時刻のため、JST → UTC に変換（-9時間）

---

## 8. セキュリティパラメーター

### 8.1 TLS設定

| パラメーター | 設定値 | 備考 |
|------------|--------|------|
| TLSバージョン | TLS 1.3 | TLS 1.2以下は拒否 |
| 暗号化アルゴリズム | AES-256 | |

### 8.2 暗号化設定

| 対象 | 暗号化方式 | KMSキー | 備考 |
|------|----------|--------|------|
| RDS（保存時） | AES-256 | AWS マネージド (aws/rds) | |
| RDS（転送時） | TLS 1.3 | - | SSL/TLS必須 |
| S3 | AES-256 | SSE-S3 | ログ保管 |
| ECS環境変数 | - | Secrets Manager | DB接続情報等 |

---

## 9. DR（災害対策）パラメーター

### 9.1 バックアップコピー先

| 対象 | プライマリリージョン | DRリージョン | 頻度 |
|------|-------------------|-----------|------|
| RDS スナップショット | ap-northeast-1（東京） | ap-northeast-3（大阪） | 毎日 |
| CloudFormation | GitHub | GitHub | 変更時 |

### 9.2 目標値

| 項目 | 目標値 | 備考 |
|------|--------|------|
| RTO（目標復旧時間） | 24時間以内 | 東京リージョン壊滅時 |
| RPO（目標復旧時点） | 5分以内 | PITR使用 |

---

## 10. コスト試算（月額）

### 10.1 環境別コスト（月額）

| 環境 | 月額（円） | 主要コスト |
|------|----------|----------|
| dev | 約30,000円 | ECS Fargate（最小）、RDS（db.t4g.micro）、NAT Gateway（1AZ） |
| stg | 約50,000円 | ECS Fargate（最小）、RDS（db.t4g.small）、NAT Gateway（2AZ） |
| prod | 約83,680円 | ECS Fargate（0.5vCPU）、RDS（db.t4g.medium）、NAT Gateway（2AZ） |
| **合計** | **約163,680円** | **予算100万円以内を達成** |

---

## 11. 命名規則

### 11.1 リソース命名規則

```
{project}-{env}-{resource}-{optional}

例:
- facilities-prod-cluster
- facilities-prod-db
- facilities-staff-api
```

| プレフィックス | 説明 | 例 |
|------------|------|---|
| facilities | プロジェクト名 | - |
| dev / stg / prod | 環境 | - |
| cluster | ECS Cluster | facilities-prod-cluster |
| db | RDS Instance | facilities-prod-db |
| alb | ALB | facilities-staff-alb |
| vpc | VPC | facilities-prod-vpc |

---

## 12. ヒアリング事項（仮決定）

以下の項目は、本来ユーザーに確認すべきですが、合理的な仮決定をしています：

| 項目 | 仮決定内容 | 理由 | ユーザー確認推奨度 |
|------|----------|------|------------------|
| VPC CIDR設計 | dev: 10.0/16, stg: 10.1/16, prod: 10.2/16 | 標準的な分割、重複なし | 中 |
| サブネット分割 | /24 単位（256 IPアドレス） | ECS タスク数を考慮して十分な余裕 | 低 |
| ECS タスク CPU/メモリ（API） | 0.5vCPU/1GB | 要件定義書の記載に基づく | 低 |
| ECS タスク CPU/メモリ（バッチ） | 2vCPU/4GB | 大量データ処理のため、APIより多く割り当て | 中 |
| RDS インスタンスタイプ（prod） | db.t4g.medium | 性能要件とコストのバランス | 中 |
| CloudWatch アラート閾値 | CPU 80%, Memory 80% | 一般的な閾値 | 中 |
| ログ保管期間（S3 Glacier） | 1年～2年 | 監査要件を考慮 | 低 |
| DR リージョン | 大阪リージョン | 東京リージョンからの地理的距離 | 高（災害対策のため） |
| バッチ実行時刻 | 深夜2:00（JST） | 業務時間外の低負荷時間帯 | 低 |

---

**作成者**: PM（architect サブエージェント監修）
**最終更新**: 2025-10-25
