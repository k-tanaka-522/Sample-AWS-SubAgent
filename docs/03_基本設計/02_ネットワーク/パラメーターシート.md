# ネットワーク - パラメーターシート

**作成日**: 2025-10-25
**バージョン**: 1.3
**ステータス**: ユーザー承認完了、実装開始

---

## 概要

このドキュメントは、ネットワーク関連のCloudFormation実装時に参照する設定値を環境別・アカウント別にまとめたものです。

本プロジェクトは **マルチアカウント構成** を採用しており、以下の2アカウントで構成されます：
- **Shared Account**: ネットワークハブ（Transit Gateway、Client VPN）
- **Service Account**: アプリケーション実行環境（VPC、サブネット）

---

## 0. Shared Account パラメーター

### 0.1 AWS Organizations

| 項目 | 設定値 | 備考 |
|------|--------|------|
| 管理アカウント | Shared Account | AWS Organizations の管理アカウント |
| 組織ユニット (OU) | ou=shared, ou=services | Shared Account と Service Account を分離 |
| メンバーアカウント | Service Account | 設備管理サービス用アカウント |

### 0.2 Transit Gateway

| 項目 | 設定値 | 備考 |
|------|--------|------|
| Transit Gateway ID | tgw-XXXXXXXXXXXX | 実装時に生成 |
| ASN | 64512 | プライベートASN |
| CIDR ブロック | - | ルーティングのみ使用 |
| デフォルトルートテーブル関連付け | 無効 | 手動ルートテーブル管理 |
| デフォルトルートテーブル伝播 | 無効 | 手動ルート伝播管理 |
| DNS サポート | 有効 | VPC間DNS解決 |
| VPN ECMP サポート | 有効 | 将来の冗長化対応 |
| マルチキャストサポート | 無効 | 不要 |

### 0.3 Transit Gateway Route Table

| Route Table 名 | アタッチメント | ルート先 | ターゲット | 備考 |
|---------------|-------------|---------|----------|------|
| tgw-rtb-on-premises | Direct Connect Gateway | 10.0.0.0/16, 10.1.0.0/16, 10.2.0.0/16 | Service VPC Attachments | 拠点 → Service VPC |
| tgw-rtb-service-vpc | Service VPC Attachments (dev/stg/prod) | 172.16.0.0/16 | Direct Connect Gateway | Service VPC → 拠点 |

### 0.4 拠点接続方式（Client VPN - 暫定実装）

**実装方針**:
- **現在**: AWS Client VPN を **Shared Account（Transit Gateway）に接続**（BGP ASN 準備中のため暫定）
- **将来**: Direct Connect へ移行（BGP ASN 確定後）

**構成**:
```
拠点（20拠点）
  ↓ Client VPN
Shared Account: Client VPN Endpoint
  ↓ Transit Gateway Attachment
Shared Account: Transit Gateway
  ↓ TGW Attachments
Service VPC (dev/stg/prod)
```

| 項目 | 設定値 | 備考 |
|------|--------|------|
| 配置先 | **Shared Account** | Transit Gateway に接続 |
| Client VPN Endpoint 名 | facilities-shared-client-vpn | |
| クライアント CIDR ブロック | 172.16.0.0/22 | VPN クライアント用 IP プール（1,024アドレス） |
| 認証方式 | 証明書ベース認証（ACM） | 拠点ごとにクライアント証明書発行 |
| スプリットトンネル | 有効 | AWS VPC 宛のみ VPN 経由 |
| 同時接続数 | 100 | 職員100名 + 余裕 |
| DNS サーバー | 拠点DNSサーバー | 拠点側で設定 |
| ログ記録 | CloudWatch Logs | 接続ログ、監査対応（ISMAP準拠） |
| トランスポートプロトコル | UDP | パフォーマンス優先 |
| セッションタイムアウト | 12時間 | 稼働時間中の再接続を削減 |
| Transit Gateway Attachment | tgw-attach-client-vpn | Client VPN → TGW 接続 |

### 0.5 Client VPN ルーティング（Transit Gateway 経由）

**ルーティング設計**:
- Client VPN Endpoint → Transit Gateway へルート追加
- Transit Gateway Route Table（tgw-rtb-on-premises）に Client VPN Attachment を追加
- 拠点からすべての Service VPC へアクセス可能

| ターゲットネットワーク | ルート先 | 説明 |
|------------------|---------|------|
| 10.0.0.0/16 | Transit Gateway | 開発環境 VPC へのルーティング |
| 10.1.0.0/16 | Transit Gateway | ステージング環境 VPC へのルーティング |
| 10.2.0.0/16 | Transit Gateway | 本番環境 VPC へのルーティング |

### 0.6 Direct Connect（将来実装）

**ステータス**: ⏳ **準備中**（BGP ASN 確定後に実装）

| 項目 | 設定値 | 備考 |
|------|--------|------|
| 接続名 | facilities-dx-100mbps | 将来実装 |
| 接続タイプ | Hosted Connection | パートナー経由 |
| 帯域幅 | 100Mbps | 初期値（将来的に1Gbps拡張可能） |
| ロケーション | 東京（Equinix TY2等） | パートナーによる |
| VLAN ID | XXXX | パートナー提供 |
| BGP ASN（AWS側） | 64512 | Transit Gateway ASN |
| BGP ASN（拠点側） | 65000（仮） | **🔴 準備中**: 拠点ネットワーク管理者に確認中 |
| 実装予定 | BGP ASN 確定後 | Client VPN から移行 |

### 0.7 拠点CIDR設計

| 拠点 | CIDR | IPアドレス数 | 備考 |
|------|------|-------------|------|
| **拠点ネットワーク（集約）** | 172.16.0.0/16 | 65,536 | 20拠点の集約CIDR |
| 拠点01 | 172.16.1.0/24 | 256 | 端末100台 + 余裕 |
| 拠点02 | 172.16.2.0/24 | 256 | 端末100台 + 余裕 |
| 拠点03 | 172.16.3.0/24 | 256 | 端末100台 + 余裕 |
| 拠点04～20 | 172.16.4.0/24 ～ 172.16.20.0/24 | 256 | 各拠点 /24 を割り当て |

### 0.8 Resource Access Manager (RAM) 共有

| 共有リソース | 共有先 | 備考 |
|----------|--------|------|
| Transit Gateway | Service Account | VPC Attachment 作成のため共有 |

---

## 1. Service Account ネットワークパラメーター

### 1.1 VPC CIDR

| 環境 | VPC CIDR | IPアドレス数 | 備考 |
|------|----------|-------------|------|
| dev | 10.0.0.0/16 | 65,536 | 開発環境 |
| stg | 10.1.0.0/16 | 65,536 | ステージング環境 |
| prod | 10.2.0.0/16 | 65,536 | 本番環境 |

### 1.2 サブネット設計（dev環境: 10.0.0.0/16）

| サブネット種別 | AZ | CIDR | 用途 | IPアドレス数 |
|-------------|----|----|------|-------------|
| Public Subnet 1 | ap-northeast-1a | 10.0.0.0/24 | ALB、NAT Gateway | 256 |
| Private Subnet 1 | ap-northeast-1a | 10.0.2.0/24 | ECS Fargate | 256 |
| DB Subnet 1 | ap-northeast-1a | 10.0.4.0/24 | RDS PostgreSQL | 256 |

**注**: dev環境はシングルAZ構成でコスト削減

### 1.3 サブネット設計（stg環境: 10.1.0.0/16）

| サブネット種別 | AZ | CIDR | 用途 | IPアドレス数 |
|-------------|----|----|------|-------------|
| Public Subnet 1 | ap-northeast-1a | 10.1.0.0/24 | ALB、NAT Gateway | 256 |
| Public Subnet 2 | ap-northeast-1c | 10.1.1.0/24 | ALB、NAT Gateway | 256 |
| Private Subnet 1 | ap-northeast-1a | 10.1.2.0/24 | ECS Fargate | 256 |
| Private Subnet 2 | ap-northeast-1c | 10.1.3.0/24 | ECS Fargate | 256 |
| DB Subnet 1 | ap-northeast-1a | 10.1.4.0/24 | RDS PostgreSQL | 256 |
| DB Subnet 2 | ap-northeast-1c | 10.1.5.0/24 | RDS PostgreSQL | 256 |

### 1.4 サブネット設計（prod環境: 10.2.0.0/16）

| サブネット種別 | AZ | CIDR | 用途 | IPアドレス数 |
|-------------|----|----|------|-------------|
| Public Subnet 1 | ap-northeast-1a | 10.2.0.0/24 | ALB、NAT Gateway | 256 |
| Public Subnet 2 | ap-northeast-1c | 10.2.1.0/24 | ALB、NAT Gateway | 256 |
| Private Subnet 1 | ap-northeast-1a | 10.2.2.0/24 | ECS Fargate | 256 |
| Private Subnet 2 | ap-northeast-1c | 10.2.3.0/24 | ECS Fargate | 256 |
| DB Subnet 1 | ap-northeast-1a | 10.2.4.0/24 | RDS PostgreSQL | 256 |
| DB Subnet 2 | ap-northeast-1c | 10.2.5.0/24 | RDS PostgreSQL | 256 |

### 1.5 NAT Gateway 配置

| 環境 | NAT Gateway 1 (AZ-a) | NAT Gateway 2 (AZ-c) | 備考 |
|------|---------------------|---------------------|------|
| dev | Public Subnet 1 (10.0.0.0/24) | - | シングルAZ構成 |
| stg | Public Subnet 1 (10.1.0.0/24) | Public Subnet 2 (10.1.1.0/24) | マルチAZ構成 |
| prod | Public Subnet 1 (10.2.0.0/24) | Public Subnet 2 (10.2.1.0/24) | マルチAZ構成 |

### 1.6 VPCエンドポイント（コスト削減）

| エンドポイント | タイプ | 用途 | コスト試算（prod、月額） | 備考 |
|-------------|------|------|-------------------|------|
| S3 | Gateway | ログ保管、静的ファイル | 無料（通信料のみ） | NAT Gateway 経由通信を削減 |
| ECR（API） | Interface | コンテナイメージ取得 | $0.01/時間 + 通信料 ≈ ¥1,100 | タスク起動時のイメージPull |
| ECR（DKR） | Interface | コンテナイメージ取得 | $0.01/時間 + 通信料 ≈ ¥1,100 | タスク起動時のイメージPull |
| Secrets Manager | Interface | DB接続情報取得 | $0.01/時間 + 通信料 ≈ ¥1,100 | タスク起動時のシークレット取得 |

**設置方針**:
- **dev/stg**: 実装せず（コスト優先）
- **prod**: 実運用後、CloudWatch Logs でトラフィック分析し、NAT Gateway 通信料と VPC Endpoint コストを比較して導入判断

**期待効果（prod環境）**:
- NAT Gateway データ処理料金削減: 月5-10GB削減で約¥500-1,000円削減可能性
- VPC Endpoint 追加コスト: 約¥3,300円/月（3エンドポイント）
- **差分**: 初期導入時は微増だが、スケールアウト時に効果大

---

**作成者**: SRE（PM 委譲タスク）
**最終更新**: 2025-10-25
