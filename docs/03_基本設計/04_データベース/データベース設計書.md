# 04. データベース設計

**作成日**: 2025-10-25
**バージョン**: 1.0
**ステータス**: PM レビュー待ち

---

## 4.1 RDS PostgreSQL 概要

### 採用理由（ADR-002参照）

- ACID保証による発注管理のトランザクション整合性確保
- マルチAZ構成による高可用性（99.9%）
- 自動バックアップとPITR（35日）によるデータ保護
- 現行システムからの移行がスムーズ（PostgreSQL継続）

---

## 4.2 RDS インスタンス設計

### インスタンス設計方針

**環境別の方針**:
- **dev環境**: シングルAZ、最小スペック（コスト削減）
- **stg環境**: マルチAZ、中程度スペック（本番構成の検証）
- **prod環境**: マルチAZ、適切なスペック（可用性とパフォーマンスのバランス）

**性能調整**:
- 実運用後、CloudWatch メトリクス（CPU使用率、メモリ使用率、接続数）を見て調整
- ストレージ自動スケーリング有効化（初期値から最大値まで自動拡張）

**注**: 具体的なインスタンスタイプ、ストレージサイズ、月額コストは、パラメーターシートを参照してください。

---

## 4.3 RDS 詳細設計方針

### 基本設計方針

**エンジン設定**:
- PostgreSQL 安定版を使用
- マルチAZ配置による自動フェイルオーバー
- ストレージ自動スケーリング有効化

**ネットワーク設定**:
- DB Subnet に配置（完全閉域）
- パブリックアクセス無効
- VPC セキュリティグループによるアクセス制御

**認証情報管理**:
- Secrets Manager でマスターパスワード管理（ハードコード禁止）
- 自動ローテーション推奨

**バックアップ戦略**:
- 自動バックアップ有効化（業務時間外の低負荷時間帯）
- バックアップ保持期間: 1週間
- DR対策: バックアップコピーを大阪リージョンに保管

**ポイントインタイムリカバリ（PITR）**:
- PITR 有効化（最長保持期間）
- RPO: 5分以内（任意の時点に復旧可能）
- 誤削除時の復旧に有効

**注**: 具体的なRDS設定（エンジンバージョン、インスタンスクラス、ストレージサイズ、IOPS、ポート番号等）は、パラメーターシートを参照してください。

---

## 4.4 暗号化設計

### 暗号化方針

**保存時の暗号化**:
- AWS KMS による暗号化有効化
- AES-256 暗号化アルゴリズム
- AWS マネージドキー または カスタムKMSキー使用可能

**転送時の暗号化**:
- SSL/TLS 必須
- TLS 1.3 推奨
- RDS提供の証明書使用

**注**: 具体的なKMS設定、接続文字列は、パラメーターシートを参照してください。

---

## 4.5 監視・アラート設計

### 監視方針

**CloudWatch メトリクス監視**:
監視対象メトリクス:
- CPU使用率（高負荷検知）
- フリーストレージ容量（ストレージ不足検知）
- データベース接続数（接続数上限検知）
- レプリカラグ（マルチAZレプリケーション遅延検知）
- スワップ使用量（メモリ不足検知）

**アラート通知**:
- SNS経由で メール、Slack、Teams に通知
- 閾値超過時に自動通知

**Enhanced Monitoring**:
- OSレベルのメトリクス取得（CPU、メモリ、ディスクI/O、ネットワークI/O、プロセス一覧）
- 詳細なパフォーマンス分析に使用

**注**: 具体的な閾値、粒度、モニタリングロールは、パラメーターシートを参照してください。

---

## 4.6 パラメータグループ設計

### カスタムパラメータグループ方針

**基本方針**:
- デフォルトパラメータグループではなく、カスタムパラメータグループを作成
- 性能、監査要件に応じたパラメータ調整

**主な調整パラメータ**:
- **max_connections**: 接続数上限を制限（接続プーリング使用を前提）
- **shared_buffers**: キャッシュサイズ増加（性能向上）
- **effective_cache_size**: クエリプランナーのヒント
- **work_mem**: ソート・ハッシュ処理のメモリ
- **maintenance_work_mem**: VACUUM、CREATE INDEX のメモリ
- **log_statement**: すべてのSQL文をログ出力（監査要件）
- **log_min_duration_statement**: スロークエリログ出力（性能分析）

**注**: 具体的なパラメータ値は、パラメーターシートを参照してください。

---

## 4.7 メンテナンス設計

### メンテナンス方針

**メンテナンスウィンドウ**:
- 業務時間外に設定（システム影響を最小化）
- 自動マイナーバージョンアップグレード有効化（セキュリティパッチ適用）

**メンテナンス内容**:
- OS パッチ適用
- PostgreSQL マイナーバージョンアップグレード

**ダウンタイム**:
- マルチAZ構成のため、ダウンタイムは最小限（数分程度）

**注**: 具体的なメンテナンスウィンドウ時間は、パラメーターシートを参照してください。

---

## 4.8 データ移行設計

### 移行方針

**移行対象**:
- 現行RDS PostgreSQL → 新規RDS PostgreSQL（3環境）

**環境別移行方式**:
- **dev/stg環境**: 現行本番のスナップショット復元（開発・検証用データ）
- **prod環境**: AWS DMS または 論理バックアップ

### 移行方式の選択

**方式1: AWS DMS（推奨）**:
- Full load + CDC（変更データキャプチャ）による最小ダウンタイム移行
- レプリケーションインスタンス経由でデータ同期
- カットオーバー時のダウンタイムを最小化

**方式2: 論理バックアップ（pg_dump/pg_restore）**:
- シンプルな移行方式
- ダウンタイム発生（バックアップ・復元時間）
- データ整合性チェックが容易

### 移行スケジュール

1. dev環境構築・データ移行（設計フェーズ完了後）
2. stg環境構築・データ移行（実装フェーズ中）
3. prod環境構築・データ移行（本番稼働直前）

**注**: 具体的な移行手順、コマンド例は、実装フェーズで詳細化します。

---

## 4.9 災害対策（DR）設計

### DR方針

**RDS スナップショット戦略**:
- 自動スナップショット: 毎日（業務時間外）、保持期間指定
- 手動スナップショット: デプロイ前（無期限保持）
- スナップショットコピー: DR リージョン（大阪リージョン）に自動コピー

### DR 手順

**災害発生時（東京リージョン壊滅）**:
1. DR リージョン（大阪）のスナップショットから復元
2. VPCエンドポイント更新（Secrets Manager）
3. ECS タスク再起動
4. 動作確認

**目標復旧時間（RTO）**: 24時間以内

**注**: 具体的なDR手順、コマンド例は、DR計画書を参照してください。

---

## 4.10 ヒアリング事項（仮決定）

以下の項目は、本来ユーザーに確認すべきですが、合理的な仮決定をしました：

| 項目 | 仮決定内容 | ユーザー確認推奨度 |
|------|----------|------------------|
| RDS インスタンスタイプ | 性能要件とコストのバランス | 中 |
| RDS ストレージ | データ量の見積もりに基づく | 中 |
| バックアップ保持期間 | 1週間分で十分 | 低 |
| PITR 保持期間 | 最長保持（長期復旧可能性確保） | 低 |
| バックアップウィンドウ | 業務時間外の低負荷時間帯 | 低 |
| メンテナンスウィンドウ | 業務時間外、システム停止日 | 低 |
| DR リージョン | 東京から地理的距離を確保 | 高（災害対策のため） |
| パラメータグループ設定 | カスタム（監査要件考慮） | 中 |

**注**: 具体的な設定値は、パラメーターシートを参照してください。

---

**作成者**: architect サブエージェント
**最終更新**: 2025-10-25
