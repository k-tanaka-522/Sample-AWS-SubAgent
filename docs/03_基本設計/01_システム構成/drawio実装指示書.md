# draw.io 実装指示書（マルチアカウント全体構成図）

**作成日**: 2025-10-29
**バージョン**: 1.0
**対象**: coder サブエージェント
**タスク**: マルチアカウント全体構成図を draw.io で実装

---

## 1. 概要

### 目的
拠点 → Shared Account → Service Account のデータフロー全体を可視化し、経由するAWSサービスをすべて明示した図を draw.io で作成する。

### 設計方針
1. **3つのVPC（dev/stg/prod）を明示的に表現**
2. **Client VPN（暫定実装）を明記し、将来のDirect Connect移行を注釈**
3. **すべてのAWSサービスを網羅**
4. **2つのデータフローを色分けして明確に表現**

---

## 2. 図の構成

### 2.1 全体レイアウト

```
┌─────────────────┐   ┌────────────────────────────┐   ┌─────────────────────────────────────────────┐
│                 │   │                            │   │                                             │
│  拠点（左端）    │───│  Shared Account（中央左）   │───│  Service Account（右側）                     │
│                 │   │                            │   │                                             │
│  - 20拠点       │   │  - Client VPN Endpoint     │   │  ┌─────────────────────────────────────┐   │
│  - 2,000台      │   │  - Transit Gateway         │   │  │ VPC（dev）10.0.0.0/16              │   │
│                 │   │  - CloudTrail等            │   │  │ - ALB, ECS, RDS, Cognito, ECR...   │   │
│                 │   │                            │   │  └─────────────────────────────────────┘   │
└─────────────────┘   └────────────────────────────┘   │  ┌─────────────────────────────────────┐   │
                                                        │  │ VPC（stg）10.1.0.0/16              │   │
        ↑                                               │  │ - ALB, ECS, RDS, Cognito, ECR...   │   │
        │                                               │  └─────────────────────────────────────┘   │
        └── Client VPN 接続                             │  ┌─────────────────────────────────────┐   │
                                                        │  │ VPC（prod）10.2.0.0/16             │   │
                                                        │  │ - ALB, ECS, RDS, Cognito, ECR...   │   │
┌─────────────────┐                                     │  └─────────────────────────────────────┘   │
│                 │                                     │                                             │
│  インターネット  │─── 事業者（パブリック）             │  + CloudFront, S3（フロントエンド配信）      │
│                 │         ↓                           │  + CloudWatch, SNS, S3（ログ）             │
└─────────────────┘   CloudFront / ALB (Public)         └─────────────────────────────────────────────┘
```

### 2.2 配置座標（おおよそ）

- **キャンバスサイズ**: 2400px × 1600px
- **拠点**: (100, 400) - (300, 600)
- **Shared Account**: (400, 200) - (800, 1000)
- **Service Account**: (900, 100) - (2300, 1500)
- **インターネット**: (100, 1200) - (300, 1400)

---

## 3. 拠点（左端）

### 3.1 拠点コンテナ

- **図形**: 角丸四角形
- **サイズ**: 200px × 200px
- **位置**: (100, 400)
- **塗りつぶし**: オレンジ系（#fff3e6）
- **枠線**: オレンジ（#ff9900）、太さ3px
- **ラベル**: `拠点（20拠点、172.16.0.0/16）`

### 3.2 拠点端末

- **図形**: 小さい角丸四角形
- **サイズ**: 160px × 80px
- **位置**: (120, 450)（拠点コンテナ内）
- **塗りつぶし**: 白（#ffffff）
- **枠線**: オレンジ（#ff9900）、太さ1px
- **ラベル**: `拠点端末\n（各拠点100台、計2,000台）`
- **フォント**: Arial, 10pt, 中央揃え

---

## 4. Shared Account（中央左）

### 4.1 Shared Account コンテナ

- **図形**: 角丸四角形
- **サイズ**: 400px × 800px
- **位置**: (400, 200)
- **塗りつぶし**: 青系（#e6f3ff）
- **枠線**: 青（#0066cc）、太さ3px
- **ラベル**: `Shared Account（共有基盤）`
- **フォント**: Arial, 14pt, 太字

### 4.2 Client VPN Endpoint セクション

- **図形**: 角丸四角形（点線枠）
- **サイズ**: 360px × 150px
- **位置**: (420, 230)（Shared Account内）
- **塗りつぶし**: オレンジ系（#ffebcc）
- **枠線**: オレンジ（#ff6600）、太さ2px
- **ラベル**: `Client VPN（暫定実装）`

#### 4.2.1 Client VPN Endpoint

- **図形**: 角丸四角形
- **サイズ**: 140px × 60px
- **位置**: (440, 250)
- **塗りつぶし**: 白（#ffffff）
- **枠線**: オレンジ（#ff6600）、太さ1px
- **ラベル**: `Client VPN Endpoint\n（証明書認証）\n172.16.0.0/22`
- **フォント**: Arial, 9pt, 中央揃え

#### 4.2.2 注釈（将来のDirect Connect移行）

- **図形**: 角丸四角形（点線枠）
- **サイズ**: 160px × 60px
- **位置**: (600, 250)
- **塗りつぶし**: 黄色系（#ffffcc）
- **枠線**: オレンジ（#ffaa00）、太さ1px、点線（dash-array: 5 5）
- **ラベル**: `⚠️ 暫定実装\n将来 Direct Connect に移行\n（BGP ASN確定後）`
- **フォント**: Arial, 8pt, 中央揃え

### 4.3 Transit Gateway セクション

- **図形**: 角丸四角形
- **サイズ**: 360px × 120px
- **位置**: (420, 400)
- **塗りつぶし**: 白（#ffffff）
- **枠線**: 青（#0066cc）、太さ2px
- **ラベル**: `Transit Gateway`

#### 4.3.1 Transit Gateway

- **図形**: 角丸四角形
- **サイズ**: 320px × 60px
- **位置**: (440, 420)
- **塗りつぶし**: 青系（#cce6ff）
- **枠線**: 青（#0066cc）、太さ1px
- **ラベル**: `Transit Gateway\n（ネットワークハブ）\nASN: 64512`
- **フォント**: Arial, 10pt, 中央揃え

### 4.4 監査・セキュリティ セクション

- **図形**: 角丸四角形
- **サイズ**: 360px × 320px
- **位置**: (420, 540)
- **塗りつぶし**: 白（#ffffff）
- **枠線**: 紫（#9900cc）、太さ2px
- **ラベル**: `監査・セキュリティ`

#### 4.4.1 CloudTrail

- **図形**: 角丸四角形
- **サイズ**: 150px × 50px
- **位置**: (440, 570)
- **塗りつぶし**: 紫系（#f0e6ff）
- **枠線**: 紫（#9900cc）、太さ1px
- **ラベル**: `CloudTrail\n（組織全体）`
- **フォント**: Arial, 9pt, 中央揃え

#### 4.4.2 Config

- **図形**: 角丸四角形
- **サイズ**: 150px × 50px
- **位置**: (610, 570)
- **塗りつぶし**: 紫系（#f0e6ff）
- **枠線**: 紫（#9900cc）、太さ1px
- **ラベル**: `Config\n（組織全体）`
- **フォント**: Arial, 9pt, 中央揃え

#### 4.4.3 GuardDuty

- **図形**: 角丸四角形
- **サイズ**: 150px × 50px
- **位置**: (440, 630)
- **塗りつぶし**: 紫系（#f0e6ff）
- **枠線**: 紫（#9900cc）、太さ1px
- **ラベル**: `GuardDuty\n（組織全体）`
- **フォント**: Arial, 9pt, 中央揃え

#### 4.4.4 Security Hub

- **図形**: 角丸四角形
- **サイズ**: 150px × 50px
- **位置**: (610, 630)
- **塗りつぶし**: 紫系（#f0e6ff）
- **枠線**: 紫（#9900cc）、太さ1px
- **ラベル**: `Security Hub\n（組織全体）`
- **フォント**: Arial, 9pt, 中央揃え

#### 4.4.5 S3 Bucket（監査ログ集約）

- **図形**: 角丸四角形
- **サイズ**: 320px × 50px
- **位置**: (440, 690)
- **塗りつぶし**: 紫系（#f0e6ff）
- **枠線**: 紫（#9900cc）、太さ1px
- **ラベル**: `S3 Bucket（監査ログ集約）`
- **フォント**: Arial, 9pt, 中央揃え

### 4.5 AWS Organizations セクション

- **図形**: 角丸四角形
- **サイズ**: 360px × 80px
- **位置**: (420, 880)
- **塗りつぶし**: 白（#ffffff）
- **枠線**: 青（#0066cc）、太さ2px
- **ラベル**: `AWS Organizations`

#### 4.5.1 Organizations

- **図形**: 角丸四角形
- **サイズ**: 320px × 40px
- **位置**: (440, 900)
- **塗りつぶし**: 青系（#cce6ff）
- **枠線**: 青（#0066cc）、太さ1px
- **ラベル**: `Organizations（管理アカウント）`
- **フォント**: Arial, 9pt, 中央揃え

---

## 5. Service Account（右側）

### 5.1 Service Account コンテナ

- **図形**: 角丸四角形
- **サイズ**: 1400px × 1400px
- **位置**: (900, 100)
- **塗りつぶし**: 赤系（#ffe6e6）
- **枠線**: 赤（#cc0000）、太さ3px
- **ラベル**: `Service Account（サービスアカウント）`
- **フォント**: Arial, 14pt, 太字

### 5.2 CloudFront + S3（事業者向けフロントエンド配信）

- **図形**: 角丸四角形
- **サイズ**: 400px × 120px
- **位置**: (920, 130)
- **塗りつぶし**: 白（#ffffff）
- **枠線**: 緑（#00cc00）、太さ2px
- **ラベル**: `フロントエンド配信`

#### 5.2.1 CloudFront

- **図形**: 角丸四角形
- **サイズ**: 180px × 50px
- **位置**: (940, 150)
- **塗りつぶし**: 緑系（#e6ffe6）
- **枠線**: 緑（#00cc00）、太さ1px
- **ラベル**: `CloudFront Distribution\n（事業者向けフロントエンド配信）`
- **フォント**: Arial, 8pt, 中央揃え

#### 5.2.2 S3 Bucket

- **図形**: 角丸四角形
- **サイズ**: 180px × 50px
- **位置**: (1130, 150)
- **塗りつぶし**: 緑系（#e6ffe6）
- **枠線**: 緑（#00cc00）、太さ1px
- **ラベル**: `S3 Bucket\nフロントエンド配信`
- **フォント**: Arial, 9pt, 中央揃え

### 5.3 VPC（dev）

- **図形**: 角丸四角形
- **サイズ**: 1360px × 280px
- **位置**: (920, 270)
- **塗りつぶし**: グレー系（#f0f0f0）
- **枠線**: グレー（#666666）、太さ2px
- **ラベル**: `VPC（dev - 10.0.0.0/16）`
- **フォント**: Arial, 12pt, 太字

#### 5.3.1 Transit Gateway Attachment

- **図形**: 角丸四角形
- **サイズ**: 180px × 40px
- **位置**: (940, 290)
- **塗りつぶし**: 青系（#cce6ff）
- **枠線**: 青（#0066cc）、太さ1px
- **ラベル**: `Transit Gateway Attachment`
- **フォント**: Arial, 8pt, 中央揃え

#### 5.3.2 Public Subnet

- **図形**: 角丸四角形
- **サイズ**: 280px × 200px
- **位置**: (940, 340)
- **塗りつぶし**: 赤系（#ffe6e6）
- **枠線**: 赤（#cc0000）、太さ1px
- **ラベル**: `Public Subnet（10.0.0.0/24）`

**Public Subnet 内の要素**:
- **Internet Gateway**: (960, 360), 120px × 30px, ラベル: `Internet Gateway`
- **ALB (Internal)**: (960, 400), 120px × 30px, ラベル: `ALB (Internal)\n業務アプリ`
- **ALB (Public)**: (960, 440), 120px × 30px, ラベル: `ALB (Public)\n事業者アプリ`
- **NAT Gateway**: (960, 480), 120px × 30px, ラベル: `NAT Gateway`

#### 5.3.3 Private Subnet

- **図形**: 角丸四角形
- **サイズ**: 280px × 200px
- **位置**: (1240, 340)
- **塗りつぶし**: 緑系（#e6ffe6）
- **枠線**: 緑（#00cc00）、太さ1px
- **ラベル**: `Private Subnet（10.0.2.0/24）`

**Private Subnet 内の要素**:
- **ECS Fargate（業務API）**: (1260, 360), 240px × 30px, ラベル: `ECS Fargate - 業務API`
- **ECS Fargate（事業者API）**: (1260, 400), 240px × 30px, ラベル: `ECS Fargate - 事業者API`
- **ECS Fargate（バッチ）**: (1260, 440), 240px × 30px, ラベル: `ECS Fargate - バッチ`

#### 5.3.4 DB Subnet

- **図形**: 角丸四角形
- **サイズ**: 280px × 200px
- **位置**: (1540, 340)
- **塗りつぶし**: オレンジ系（#fff3e6）
- **枠線**: オレンジ（#ff9900）、太さ1px
- **ラベル**: `DB Subnet（10.0.4.0/24）`

**DB Subnet 内の要素**:
- **RDS PostgreSQL**: (1560, 390), 240px × 60px, ラベル: `RDS PostgreSQL\n（シングルAZ）`

### 5.4 VPC（stg）

- **図形**: 角丸四角形
- **サイズ**: 1360px × 280px
- **位置**: (920, 570)
- **塗りつぶし**: グレー系（#f0f0f0）
- **枠線**: グレー（#666666）、太さ2px
- **ラベル**: `VPC（stg - 10.1.0.0/16）`
- **フォント**: Arial, 12pt, 太字

**構成はVPC（dev）と同様、CIDRとラベルを変更**:
- Public Subnet: `10.1.0.0/24, 10.1.1.0/24`
- Private Subnet: `10.1.2.0/24, 10.1.3.0/24`
- DB Subnet: `10.1.4.0/24, 10.1.5.0/24`
- NAT Gateway: `NAT Gateway（AZ-a）`, `NAT Gateway（AZ-c）`（2つ）
- RDS: `RDS PostgreSQL\n（マルチAZ）`

### 5.5 VPC（prod）

- **図形**: 角丸四角形
- **サイズ**: 1360px × 280px
- **位置**: (920, 870)
- **塗りつぶし**: グレー系（#f0f0f0）
- **枠線**: グレー（#666666）、太さ2px
- **ラベル**: `VPC（prod - 10.2.0.0/16）`
- **フォント**: Arial, 12pt, 太字

**構成はVPC（stg）と同様、CIDRを変更**:
- Public Subnet: `10.2.0.0/24, 10.2.1.0/24`
- Private Subnet: `10.2.2.0/24, 10.2.3.0/24`
- DB Subnet: `10.2.4.0/24, 10.2.5.0/24`

### 5.6 共通サービス（全環境共通）

- **図形**: 角丸四角形
- **サイズ**: 1360px × 280px
- **位置**: (920, 1170)
- **塗りつぶし**: 白（#ffffff）
- **枠線**: グレー（#666666）、太さ2px
- **ラベル**: `共通サービス（全環境共通）`
- **フォント**: Arial, 12pt, 太字

**共通サービス内の要素**:
- **Cognito（職員用）**: (940, 1200), 200px × 50px, ラベル: `Cognito\nユーザープール\n（職員用）`
- **Cognito（事業者用）**: (1160, 1200), 200px × 50px, ラベル: `Cognito\nユーザープール\n（事業者用）`
- **Secrets Manager**: (940, 1270), 200px × 50px, ラベル: `Secrets Manager\n（DB接続情報）`
- **ECR**: (1160, 1270), 200px × 50px, ラベル: `ECR\n（コンテナレジストリ）`
- **CloudWatch Logs**: (1380, 1200), 200px × 50px, ラベル: `CloudWatch Logs`
- **S3（ログ保管）**: (1380, 1270), 200px × 50px, ラベル: `S3 Bucket\n（ログ保管）`
- **CloudWatch Alarms**: (1600, 1200), 200px × 50px, ラベル: `CloudWatch Alarms`
- **SNS**: (1600, 1270), 200px × 50px, ラベル: `SNS\n（通知）`

---

## 6. インターネット（左下）

### 6.1 インターネット コンテナ

- **図形**: 角丸四角形
- **サイズ**: 200px × 200px
- **位置**: (100, 1200)
- **塗りつぶし**: 緑系（#e6ffe6）
- **枠線**: 緑（#00cc00）、太さ2px
- **ラベル**: `インターネット`

### 6.2 事業者

- **図形**: 小さい角丸四角形
- **サイズ**: 160px × 80px
- **位置**: (120, 1250)（インターネットコンテナ内）
- **塗りつぶし**: 白（#ffffff）
- **枠線**: 緑（#00cc00）、太さ1px
- **ラベル**: `事業者\n（パブリック）`
- **フォント**: Arial, 10pt, 中央揃え

---

## 7. データフロー（矢印）

### 7.1 拠点 → 業務アプリ（閉域接続）

**色**: オレンジ（#ff6600）、太さ3px

1. 拠点端末 → Client VPN Endpoint
   - 始点: (280, 500)
   - 終点: (440, 310)
   - ラベル: `Client VPN接続\n（証明書認証）`

2. Client VPN Endpoint → Transit Gateway
   - 始点: (580, 310)
   - 終点: (600, 440)
   - ラベル: `Transit Gateway Attachment`

3. Transit Gateway → VPC（dev） Transit Gateway Attachment
   - 始点: (760, 440)
   - 終点: (940, 310)
   - ラベル: `TGW Attachment（dev）`

4. Transit Gateway → VPC（stg） Transit Gateway Attachment
   - 始点: (760, 460)
   - 終点: (940, 610)
   - ラベル: `TGW Attachment（stg）`

5. Transit Gateway → VPC（prod） Transit Gateway Attachment
   - 始点: (760, 480)
   - 終点: (940, 910)
   - ラベル: `TGW Attachment（prod）`

6. Transit Gateway Attachment（dev） → ALB (Internal)（dev）
   - 始点: (1120, 310)
   - 終点: (1020, 415)

7. ALB (Internal)（dev） → ECS Fargate（業務API）（dev）
   - 始点: (1080, 415)
   - 終点: (1260, 375)

8. ECS Fargate（業務API）（dev） → RDS PostgreSQL（dev）
   - 始点: (1500, 375)
   - 終点: (1560, 420)

**注**: stg/prod も同様の矢印を描く（座標をy軸方向に移動）

### 7.2 事業者 → 事業者アプリ（パブリック接続）

**色**: 緑（#00cc00）、太さ3px

1. 事業者 → CloudFront
   - 始点: (280, 1290)
   - 終点: (940, 175)
   - ラベル: `HTTPS\n（静的コンテンツ）`

2. CloudFront → S3 Bucket
   - 始点: (1120, 175)
   - 終点: (1130, 175)

3. 事業者 → ALB (Public)（dev）
   - 始点: (280, 1290)
   - 終点: (1020, 455)
   - ラベル: `HTTPS（API）`

4. ALB (Public)（dev） → ECS Fargate（事業者API）（dev）
   - 始点: (1080, 455)
   - 終点: (1260, 415)

5. ECS Fargate（事業者API）（dev） → RDS PostgreSQL（dev）
   - 始点: (1500, 415)
   - 終点: (1560, 420)

**注**: stg/prod も同様の矢印を描く

### 7.3 認証・シークレット・監視（点線）

**色**: グレー（#666666）、太さ1px、点線（dash-array: 5 5）

1. ECS Fargate（業務API）（dev） → Cognito（職員用）
   - 始点: (1380, 375)
   - 終点: (1040, 1225)
   - ラベル: `認証`

2. ECS Fargate（事業者API）（dev） → Cognito（事業者用）
   - 始点: (1380, 415)
   - 終点: (1260, 1225)
   - ラベル: `認証`

3. ECS Fargate（業務API）（dev） → Secrets Manager
   - 始点: (1380, 385)
   - 終点: (1040, 1295)
   - ラベル: `シークレット取得`

4. ECS Fargate（業務API）（dev） → CloudWatch Logs
   - 始点: (1400, 375)
   - 終点: (1480, 1225)
   - ラベル: `ログ送信`

5. CloudWatch Logs → S3（ログ保管）
   - 始点: (1580, 1225)
   - 終点: (1480, 1295)

**注**: stg/prod も同様の点線矢印を描く

### 7.4 監査ログ集約（点線、紫色）

**色**: 紫（#9900cc）、太さ1px、点線（dash-array: 5 5）

1. VPC（dev） → CloudTrail
   - 始点: (920, 400)
   - 終点: (515, 595)
   - ラベル: `監査ログ転送`

2. VPC（stg） → Config
   - 始点: (920, 700)
   - 終点: (685, 595)

3. VPC（prod） → GuardDuty
   - 始点: (920, 1000)
   - 終点: (515, 655)

4. CloudTrail → S3 Bucket（監査ログ集約）
   - 始点: (590, 595)
   - 終点: (600, 715)

5. Config → S3 Bucket（監査ログ集約）
   - 始点: (760, 595)
   - 終点: (600, 715)

6. GuardDuty → S3 Bucket（監査ログ集約）
   - 始点: (590, 655)
   - 終点: (600, 715)

7. Security Hub → S3 Bucket（監査ログ集約）
   - 始点: (760, 655)
   - 終点: (600, 715)

### 7.5 AWS Organizations 管理（点線、青色）

**色**: 青（#0066cc）、太さ1px、点線（dash-array: 5 5）

1. Organizations → Service Account（全体）
   - 始点: (760, 920)
   - 終点: (900, 800)
   - ラベル: `管理`

---

## 8. 凡例

- **図形**: 角丸四角形
- **サイズ**: 300px × 200px
- **位置**: (2050, 1300)
- **塗りつぶし**: 白（#ffffff）
- **枠線**: 黒（#000000）、太さ1px
- **ラベル**: `凡例`

**凡例の内容**:
- 🟦 **Shared Account**: 青系（#e6f3ff）
- 🟥 **Service Account**: 赤系（#ffe6e6）
- 🟧 **拠点**: オレンジ系（#fff3e6）
- 🟩 **インターネット**: 緑系（#e6ffe6）
- 🟨 **注釈（暫定実装）**: 黄色系（#ffffcc）、点線
- 🟧 **閉域接続（Client VPN、Transit Gateway）**: オレンジ色の矢印（太線）
- 🟩 **パブリック接続（インターネット）**: 緑色の矢印（太線）
- 🟪 **監査ログ転送**: 紫色の点線矢印
- 🟦 **AWS Organizations 管理**: 青色の点線矢印

---

## 9. 実装手順

### 9.1 準備
1. draw.io を開く
2. 新規ドキュメント作成
3. キャンバスサイズを 2400px × 1600px に設定

### 9.2 実装順序
1. **背景コンテナ**: 拠点、Shared Account、Service Account、インターネット
2. **Shared Account 内の要素**: Client VPN、Transit Gateway、監査・セキュリティ、Organizations
3. **Service Account 内の要素**:
   - CloudFront + S3
   - VPC（dev）- Transit Gateway Attachment、Public Subnet、Private Subnet、DB Subnet
   - VPC（stg）- 同上
   - VPC（prod）- 同上
   - 共通サービス
4. **データフロー矢印**:
   - 拠点 → 業務アプリ（閉域接続）- オレンジ色
   - 事業者 → 事業者アプリ（パブリック接続）- 緑色
   - 認証・シークレット・監視 - グレー点線
   - 監査ログ集約 - 紫色点線
   - AWS Organizations 管理 - 青色点線
5. **凡例**

### 9.3 品質チェック
- [ ] すべてのAWSサービスが網羅されているか
- [ ] 3つのVPC（dev/stg/prod）が明示的に表現されているか
- [ ] Client VPN（暫定実装）が明記され、将来のDirect Connect移行が注釈されているか
- [ ] データフローが色分けされているか
- [ ] ラベルが読みやすいか
- [ ] CIDR が正確か

---

## 10. 出力ファイル

- **ファイル名**: `マルチアカウント全体構成図_v1.2.drawio`
- **保存場所**: `docs/03_基本設計/01_システム構成/`
- **エクスポート**:
  - PNG形式: `マルチアカウント全体構成図_v1.2.png`（300dpi）
  - SVG形式: `マルチアカウント全体構成図_v1.2.svg`（ベクター形式）

---

## 11. 参照ドキュメント

- **システム構成設計書**: `docs/03_基本設計/01_システム構成/システム構成設計書_v1.2.md`
- **ネットワーク設計書**: `docs/03_基本設計/02_ネットワーク/ネットワーク設計書.md`
- **パラメーターシート**: `docs/03_基本設計/02_ネットワーク/パラメーターシート.md`

---

**作成者**: architect サブエージェント
**最終更新**: 2025-10-29 v1.0
**委譲先**: coder サブエージェント
