# 06. ストレージ設計

**作成日**: 2025-10-25
**バージョン**: 1.0
**ステータス**: PM レビュー待ち

---

## 6.1 S3 概要

### 用途

本システムでは、以下の用途でS3を使用します：

1. **フロントエンド配信**: React SPA の静的ファイル配信
2. **ログ保管**: CloudWatch Logs、ALB アクセスログの長期保管
3. **レポート保管**: 業務バッチで生成したレポート（PDF/Excel）の保管

---

## 6.2 S3 バケット設計

### バケット一覧

| # | バケット名 | 用途 | 暗号化 | バージョニング | ライフサイクル |
|---|----------|------|--------|--------------|-------------|
| 1 | facilities-prod-frontend | フロントエンド配信 | SSE-S3 | 有効 | なし |
| 2 | facilities-prod-logs | ログ保管 | SSE-S3 | 有効 | あり |
| 3 | facilities-prod-reports | レポート保管 | SSE-S3 | 有効 | あり |
| 4 | facilities-prod-cloudformation | CloudFormation テンプレート保管 | SSE-S3 | 有効 | なし |

**バケット命名規則**:
- `facilities-[環境]-[用途]`
- 環境: dev, stg, prod
- 用途: frontend, logs, reports, cloudformation

---

## 6.3 フロントエンド配信用バケット設計

### バケット設定（facilities-prod-frontend）

| 項目 | 設定値 | 備考 |
|------|--------|------|
| リージョン | ap-northeast-1 | 東京リージョン |
| 暗号化 | SSE-S3（AES-256） | |
| バージョニング | 有効 | デプロイ失敗時のロールバック用 |
| パブリックアクセス | ブロック（すべて） | CloudFront 経由のみアクセス可能 |
| バケットポリシー | CloudFront OAI のみ許可 | |

### バケットポリシー

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowCloudFrontOAI",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity XXXXX"
      },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::facilities-prod-frontend/*"
    }
  ]
}
```

### フォルダ構成

```
facilities-prod-frontend/
├── index.html
├── favicon.ico
├── static/
│   ├── css/
│   │   └── main.xxxxxxxx.css
│   ├── js/
│   │   └── main.xxxxxxxx.js
│   └── media/
│       └── logo.xxxxxxxx.png
└── manifest.json
```

---

## 6.4 CloudFront 設計

### CloudFront Distribution 設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| オリジン | facilities-prod-frontend.s3.ap-northeast-1.amazonaws.com | S3 バケット |
| オリジンアクセス | Origin Access Identity (OAI) | S3 への直接アクセスをブロック |
| デフォルトルートオブジェクト | index.html | |
| ビューワープロトコルポリシー | Redirect HTTP to HTTPS | HTTPS 強制 |
| 許可される HTTP メソッド | GET, HEAD, OPTIONS | 静的コンテンツのみ |
| 圧縮 | 有効 | gzip、Brotli |
| WAF | 無効 | フロントエンドは静的ファイルのみ |
| SSL/TLS 証明書 | ACM 証明書 | カスタムドメイン使用 |
| 最小TLSバージョン | TLSv1.3 | セキュリティ強化 |
| ログ記録 | 有効 | S3（facilities-prod-logs）に保存 |

### カスタムドメイン

| 項目 | 設定値 | 備考 |
|------|--------|------|
| ドメイン名 | facilities.example.go.jp | Route53 で管理 |
| SSL/TLS 証明書 | ACM（us-east-1） | CloudFront は us-east-1 のACM証明書が必要 |

### キャッシュ設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| デフォルトTTL | 86400秒（24時間） | |
| 最大TTL | 31536000秒（1年） | |
| 最小TTL | 0秒 | |
| キャッシュキーポリシー | CachingOptimized | AWS推奨 |

---

## 6.5 ログ保管用バケット設計

### バケット設定（facilities-prod-logs）

| 項目 | 設定値 | 備考 |
|------|--------|------|
| リージョン | ap-northeast-1 | 東京リージョン |
| 暗号化 | SSE-S3（AES-256） | |
| バージョニング | 有効 | |
| パブリックアクセス | ブロック（すべて） | |
| ライフサイクルポリシー | あり | コスト最適化 |

### フォルダ構成

```
facilities-prod-logs/
├── cloudwatch/
│   ├── ecs/
│   │   ├── staff-api/
│   │   │   └── 2025/10/25/
│   │   │       └── log.gz
│   │   └── vendor-api/
│   └── rds/
├── alb/
│   ├── staff-alb/
│   │   └── AWSLogs/
│   └── vendor-alb/
└── cloudfront/
    └── XXXXX.2025-10-25-00.xxxxxxxx.gz
```

### ライフサイクルポリシー

| ログ種別 | 期間 | ストレージクラス | 備考 |
|---------|------|----------------|------|
| 直近3ヶ月 | 0-90日 | S3 Standard | CloudWatch Logs に保持、S3にも保存 |
| 3ヶ月～1年 | 91-365日 | S3 Standard | たまに参照 |
| 1年～2年 | 366-730日 | S3 Glacier Flexible Retrieval | アーカイブ（取り出しに数時間） |
| 2年経過 | 731日以降 | 削除 | 監査要件を満たしたら削除 |

### ライフサイクルポリシー（CloudFormation）

```yaml
LogsBucketLifecycleConfiguration:
  Type: AWS::S3::Bucket
  Properties:
    BucketName: facilities-prod-logs
    LifecycleConfiguration:
      Rules:
        - Id: TransitionToGlacier
          Status: Enabled
          Transitions:
            - TransitionInDays: 365
              StorageClass: GLACIER
          ExpirationInDays: 730
```

---

## 6.6 レポート保管用バケット設計

### バケット設定（facilities-prod-reports）

| 項目 | 設定値 | 備考 |
|------|--------|------|
| リージョン | ap-northeast-1 | 東京リージョン |
| 暗号化 | SSE-S3（AES-256） | |
| バージョニング | 有効 | |
| パブリックアクセス | ブロック（すべて） | |
| ライフサイクルポリシー | あり | コスト最適化 |

### フォルダ構成

```
facilities-prod-reports/
├── monthly/
│   └── 2025/
│       └── 10/
│           └── monthly_report_2025-10.pdf
└── annual/
    └── 2025/
        └── annual_report_2025.pdf
```

### ライフサイクルポリシー

| レポート種別 | 期間 | ストレージクラス | 備考 |
|------------|------|----------------|------|
| 直近1年 | 0-365日 | S3 Standard | 頻繁に参照 |
| 1年～3年 | 366-1095日 | S3 Standard-IA | たまに参照 |
| 3年経過 | 1096日以降 | 削除 | 保管期限 |

---

## 6.7 CloudFormation テンプレート保管用バケット設計

### バケット設定（facilities-prod-cloudformation）

| 項目 | 設定値 | 備考 |
|------|--------|------|
| リージョン | ap-northeast-1 | 東京リージョン |
| 暗号化 | SSE-S3（AES-256） | |
| バージョニング | 有効 | テンプレート履歴管理 |
| パブリックアクセス | ブロック（すべて） | |

### フォルダ構成

```
facilities-prod-cloudformation/
├── network/
│   └── main.yaml
├── storage/
│   └── main.yaml
└── compute/
    └── main.yaml
```

---

## 6.8 S3 セキュリティ設定

### バケットポリシー（ログ保管用）

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowALBLogging",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::582318560864:root"
      },
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::facilities-prod-logs/alb/*"
    },
    {
      "Sid": "AllowCloudFrontLogging",
      "Effect": "Allow",
      "Principal": {
        "Service": "cloudfront.amazonaws.com"
      },
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::facilities-prod-logs/cloudfront/*"
    },
    {
      "Sid": "DenyUnencryptedObjectUploads",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::facilities-prod-logs/*",
      "Condition": {
        "StringNotEquals": {
          "s3:x-amz-server-side-encryption": "AES256"
        }
      }
    }
  ]
}
```

### パブリックアクセスブロック（すべてのバケット）

| 項目 | 設定値 |
|------|--------|
| BlockPublicAcls | true |
| IgnorePublicAcls | true |
| BlockPublicPolicy | true |
| RestrictPublicBuckets | true |

---

## 6.9 ヒアリング事項（仮決定）

以下の項目は、本来ユーザーに確認すべきですが、合理的な仮決定をしました：

| 項目 | 仮決定内容 | 理由 | ユーザー確認推奨度 |
|------|----------|------|------------------|
| ログ保管期間 | 2年 | 監査要件を考慮 | 低 |
| Glacierへの移行期間 | 1年後 | コスト最適化 | 低 |
| レポート保管期間 | 3年 | 業務上の保管期限 | 中 |
| CloudFront キャッシュTTL | 24時間 | 一般的な設定 | 低 |
| TLS最小バージョン | TLSv1.3 | セキュリティ強化 | 低 |

---

**作成者**: architect サブエージェント
**最終更新**: 2025-10-25
