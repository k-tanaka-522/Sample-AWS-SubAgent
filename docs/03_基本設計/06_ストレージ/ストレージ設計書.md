# 06. ストレージ設計

**作成日**: 2025-10-25
**バージョン**: 1.1
**ステータス**: PM レビュー待ち

**更新履歴**:
- v1.1 (2025-10-25): 設定値を削除、設計理由と設計アプローチのみに簡潔化
- v1.0 (2025-10-25): 初版作成

---

## 6.1 ストレージ設計概要

### 設計方針

本システムでは、以下の用途でS3とCloudFrontを使用します：

1. **フロントエンド配信**: React SPA の静的ファイル配信（CloudFront経由）
2. **ログ保管**: CloudWatch Logs、ALB アクセスログの長期保管
3. **レポート保管**: 業務バッチで生成したレポート（PDF/Excel）の保管
4. **CloudFormation テンプレート保管**: インフラコードのバージョン管理

**ADR-008: S3 + CloudFront でフロントエンド配信を採用**

| 決定事項 | 理由 |
|---------|------|
| **S3 + CloudFront** を採用 | ✅ 静的ファイル配信に最適、スケーラビリティ、コスト効率、WAF不要（静的ファイルのみ） |
| **代替案1: S3単体** | ❌ HTTPS対応が煩雑、パフォーマンス劣る |
| **代替案2: ECS + Nginx** | ❌ 運用コストが高い、オーバースペック |

---

## 6.2 S3 バケット設計

### バケット設計方針

**命名規則**:
- `facilities-[環境]-[用途]`
- 環境: dev, stg, prod
- 用途: frontend, logs, reports, cloudformation

**セキュリティ設計**:
- すべてのバケットで**パブリックアクセスブロック**を有効化
- 暗号化: SSE-S3（AES-256）
- バージョニング: 有効（デプロイ失敗時のロールバック、改ざん防止）

**具体的なバケット設定値は、`05_実装準備/パラメーターシート.xlsx` を参照してください。**

---

## 6.3 フロントエンド配信用バケット設計

### 設計アプローチ

**セキュリティ強化**:
- CloudFront OAI（Origin Access Identity）のみアクセス許可
- S3への直接アクセスをブロック（パブリックアクセスブロック）
- バケットポリシーでCloudFront OAIのみ許可

**デプロイ戦略**:
- バージョニング有効化により、デプロイ失敗時のロールバック可能
- CI/CDパイプライン（GitHub Actions）から自動デプロイ

**具体的なバケット名、ARN、バケットポリシー等は、パラメーターシートを参照してください。**

---

## 6.4 CloudFront 設計

### 設計アプローチ

**パフォーマンス最適化**:
- gzip、Brotli 圧縮有効化
- キャッシュTTL: 長期キャッシュ（デフォルト24時間）
- CachingOptimized ポリシー（AWS推奨）

**セキュリティ強化**:
- TLS 1.3 必須（TLS 1.2以下を拒否）
- HTTPS強制（Redirect HTTP to HTTPS）
- カスタムドメイン + ACM証明書

**WAF適用**:
- フロントエンドは静的ファイルのみのため、WAF無効（コスト削減）
- 事業者アプリALBのみWAF有効化

**具体的なCloudFront Distribution ID、カスタムドメイン、ACM証明書ARN等は、パラメーターシートを参照してください。**

---

## 6.5 ログ保管用バケット設計

### 設計アプローチ

**コスト最適化**:
- ライフサイクルポリシーによる自動ストレージクラス移行
  - 直近3ヶ月: S3 Standard（CloudWatch Logsにも保持）
  - 3ヶ月～1年: S3 Standard（たまに参照）
  - 1年～2年: S3 Glacier Flexible Retrieval（アーカイブ）
  - 2年経過: 削除

**監査要件準拠**:
- 2年間の保管（ISMAP準拠）
- CloudWatch Logs から S3 への自動エクスポート
- バージョニング有効化（改ざん防止）

**フォルダ構成**:
```
facilities-prod-logs/
├── cloudwatch/        # CloudWatch Logs エクスポート
├── alb/               # ALB アクセスログ
├── cloudfront/        # CloudFront アクセスログ
└── cloudtrail/        # CloudTrail 監査ログ
```

**具体的なライフサイクルポリシー、保持期間の日数等は、パラメーターシートを参照してください。**

---

## 6.6 レポート保管用バケット設計

### 設計アプローチ

**ビジネス要件への対応**:
- 月次レポート、年次レポートをPDF/Excel形式で保管
- ECS バッチタスクから S3 に保存
- 3年間の保管（業務上の保管期限）

**コスト最適化**:
- ライフサイクルポリシー
  - 直近1年: S3 Standard（頻繁に参照）
  - 1年～3年: S3 Standard-IA（たまに参照）
  - 3年経過: 削除

**具体的なバケット名、フォルダ構成、ライフサイクルポリシーの日数等は、パラメーターシートを参照してください。**

---

## 6.7 CloudFormation テンプレート保管用バケット設計

### 設計アプローチ

**インフラコードのバージョン管理**:
- CloudFormation テンプレートを S3 に保管
- バージョニング有効化（テンプレート履歴管理）
- DR対策として大阪リージョンへのクロスリージョンレプリケーション（将来的に検討）

**具体的なバケット名、フォルダ構成等は、パラメーターシートを参照してください。**

---

## 6.8 S3 セキュリティ設計

### セキュリティ設計方針

**すべてのバケットに共通**:
- **パブリックアクセスブロック**: すべてのバケットで有効化
- **暗号化**: SSE-S3（AES-256）
- **バージョニング**: 有効化（改ざん防止、ロールバック可能）

**バケットポリシーによるアクセス制御**:
- フロントエンドバケット: CloudFront OAI のみ許可
- ログバケット: ALB、CloudFront、CloudWatch Logs からのログ記録を許可
- 暗号化されていないオブジェクトのアップロード拒否

**具体的なバケットポリシーJSON、ARN等は、パラメーターシートを参照してください。**

---

## 6.9 ヒアリング結果と仮決定

### 仮決定事項

以下の項目は、本来ユーザーに確認すべきですが、合理的な仮決定をしました：

| 項目 | 仮決定内容 | 理由 | ユーザー確認推奨度 |
|------|----------|------|------------------|
| ログ保管期間 | 2年 | ISMAP監査要件を考慮 | 低 |
| Glacierへの移行期間 | 1年後 | コスト最適化とアクセス頻度のバランス | 低 |
| レポート保管期間 | 3年 | 業務上の保管期限（一般的な文書保管期限） | 中 |
| CloudFront キャッシュTTL | 24時間 | 静的ファイルの一般的な設定 | 低 |
| TLS最小バージョン | TLSv1.3 | ISMAP準拠、セキュリティ強化 | 低 |

---

**作成者**: architect サブエージェント
**最終更新**: 2025-10-25
