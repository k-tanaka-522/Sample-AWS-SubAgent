# 04. データベース設計

**作成日**: 2025-10-25
**バージョン**: 1.0
**ステータス**: PM レビュー待ち

---

## 4.1 RDS PostgreSQL 概要

### 採用理由（ADR-002参照）

- ACID保証による発注管理のトランザクション整合性確保
- マルチAZ構成による高可用性（99.9%）
- 自動バックアップとPITR（35日）によるデータ保護
- 現行システムからの移行がスムーズ（PostgreSQL継続）

---

## 4.2 RDS インスタンス設計

### インスタンス構成（環境別）

| 環境 | インスタンス識別子 | インスタンスタイプ | ストレージ | マルチAZ | 備考 |
|------|------------------|------------------|----------|---------|------|
| **dev** | facilities-dev-db | db.t4g.micro | 20GB (gp3) | 無効 | 開発用（コスト削減） |
| **stg** | facilities-stg-db | db.t4g.small | 50GB (gp3) | 有効 | 検証用 |
| **prod** | facilities-prod-db | db.t4g.medium | 100GB (gp3) | 有効 | 本番用（初期値） |

### インスタンスタイプのスペック

| インスタンスタイプ | vCPU | メモリ | 月額（マルチAZ） | 用途 |
|------------------|------|--------|----------------|------|
| db.t4g.micro | 2 | 1GB | 約13,000円 | dev環境 |
| db.t4g.small | 2 | 2GB | 約26,000円 | stg環境 |
| db.t4g.medium | 2 | 4GB | 約53,000円 | prod環境 |

**注**: 実運用後、CloudWatchメトリクス（CPU使用率、メモリ使用率、接続数）を見て調整する。

---

## 4.3 RDS 詳細設定（prod環境）

### 基本設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| エンジン | PostgreSQL | |
| エンジンバージョン | 14.11 | 安定版 |
| インスタンスクラス | db.t4g.medium | |
| マルチAZ配置 | 有効 | 自動フェイルオーバー |
| ストレージタイプ | gp3 | 汎用SSD |
| 割り当てられたストレージ | 100GB | 初期値 |
| 最大ストレージしきい値 | 500GB | 自動拡張の上限 |
| ストレージの自動スケーリング | 有効 | 100GB → 500GB |
| IOPS | 3,000 | gp3 デフォルト |
| スループット | 125 MB/s | gp3 デフォルト |

### ネットワーク設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| VPC | facilities-prod-vpc | |
| サブネットグループ | facilities-prod-db-subnet-group | DB Subnet 1, 2 |
| パブリックアクセス | 無効 | 完全閉域 |
| VPC セキュリティグループ | rds-sg | |
| アベイラビリティーゾーン | ap-northeast-1a, 1c | マルチAZ |
| ポート | 5432 | PostgreSQL デフォルト |

### データベース設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| データベース名 | facilities | |
| マスターユーザー名 | admin | Secrets Manager で管理 |
| マスターパスワード | （Secrets Manager） | ハードコード禁止 |
| パラメータグループ | default.postgres14 | カスタムパラメータグループを作成推奨 |
| オプショングループ | default:postgres-14 | |

### バックアップ設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| 自動バックアップ | 有効 | |
| バックアップ保持期間 | 7日間 | 1週間分のバックアップを保持 |
| バックアップウィンドウ | 17:00-18:00 UTC（JST 02:00-03:00） | 業務時間外の低負荷時間帯 |
| バックアップコピー先 | 大阪リージョン | DR対策 |

### ポイントインタイムリカバリ（PITR）

| 項目 | 設定値 | 備考 |
|------|--------|------|
| PITR 有効化 | 有効 | |
| 保持期間 | 35日（最長） | 任意の時点に復旧可能 |

**PITR の利点**:
- 5分前の状態に復旧可能（RPO: 5分以内）
- 誤ってデータを削除した場合の復旧
- 自動バックアップと併用

---

## 4.4 暗号化設定

### 保存時の暗号化

| 項目 | 設定値 | 備考 |
|------|--------|------|
| 暗号化 | 有効 | |
| KMS キー | AWS マネージド (aws/rds) | カスタムKMSキーも使用可能 |
| 暗号化アルゴリズム | AES-256 | |

### 転送時の暗号化

| 項目 | 設定値 | 備考 |
|------|--------|------|
| SSL/TLS | 必須 | TLS 1.3 推奨 |
| 証明書 | RDS提供の証明書 | |

**接続文字列例**:
```
postgresql://admin:PASSWORD@facilities-prod-db.xxxxx.ap-northeast-1.rds.amazonaws.com:5432/facilities?sslmode=require
```

---

## 4.5 監視・アラート設定

### CloudWatch メトリクス

| メトリクス | 閾値 | アラート通知 | 備考 |
|-----------|------|------------|------|
| CPU使用率 | 80%以上 | SNS → メール、Slack、Teams | 2分間連続で超えた場合 |
| フリーストレージ容量 | 10GB以下 | SNS → メール、Slack、Teams | ストレージ不足の警告 |
| データベース接続数 | 最大接続数の80% | SNS → メール、Slack、Teams | 接続数上限に近づいた場合 |
| レプリカラグ | 60秒以上 | SNS → メール、Slack、Teams | マルチAZレプリケーション遅延 |
| スワップ使用量 | 256MB以上 | SNS → メール、Slack、Teams | メモリ不足の警告 |

### Enhanced Monitoring

| 項目 | 設定値 | 備考 |
|------|--------|------|
| Enhanced Monitoring | 有効 | |
| モニタリングロール | rds-monitoring-role | |
| 粒度 | 60秒 | OSレベルのメトリクス取得 |

**取得メトリクス**:
- CPU使用率（詳細）
- メモリ使用率
- ディスクI/O
- ネットワークI/O
- プロセス一覧

---

## 4.6 パラメータグループ設定

### カスタムパラメータグループ（推奨）

デフォルトのパラメータグループではなく、カスタムパラメータグループを作成し、以下の設定を調整します。

| パラメータ | デフォルト値 | 推奨値 | 理由 |
|-----------|------------|--------|------|
| `max_connections` | LEAST({DBInstanceClassMemory/9531392},5000) | 200 | 接続数上限を制限（接続プーリング使用） |
| `shared_buffers` | {DBInstanceClassMemory/32768} | {DBInstanceClassMemory/16384} | キャッシュサイズを増やす |
| `effective_cache_size` | {DBInstanceClassMemory/16384} | {DBInstanceClassMemory*3/4} | クエリプランナーのヒント |
| `work_mem` | 4MB | 16MB | ソート・ハッシュ処理のメモリ |
| `maintenance_work_mem` | GREATEST({DBInstanceClassMemory/63963136},65536) | 256MB | VACUUM、CREATE INDEX のメモリ |
| `log_statement` | none | all | すべてのSQL文をログ出力（監査要件） |
| `log_min_duration_statement` | -1 | 1000 | 1秒以上かかるクエリをログ出力（スロークエリ） |

**注**: `max_connections` は接続プーリング（例: pg_bouncer）を使用することを前提に、200に制限する。

---

## 4.7 メンテナンス設定

### メンテナンスウィンドウ

| 項目 | 設定値 | 備考 |
|------|--------|------|
| メンテナンスウィンドウ | 日曜日 17:00-18:00 UTC（JST 02:00-03:00） | 業務時間外 |
| 自動マイナーバージョンアップグレード | 有効 | セキュリティパッチ適用 |

**メンテナンスウィンドウの目的**:
- OS パッチ適用
- PostgreSQL マイナーバージョンアップグレード
- マルチAZ構成のため、ダウンタイムは最小限（数分）

---

## 4.8 データ移行計画

### 移行対象

- **現行RDS PostgreSQL**: 既存データベース
- **新規RDS PostgreSQL**: 3環境（dev/stg/prod）で新規構築

### 移行方式

| 環境 | 移行方式 | 備考 |
|------|---------|------|
| dev | 現行本番のスナップショット復元 | 開発用データ |
| stg | 現行本番のスナップショット復元 | 検証用データ |
| prod | AWS DMS（Database Migration Service）または論理バックアップ | 本番稼働時 |

### 移行手順（prod環境）

#### 方式1: AWS DMS 使用（推奨）

1. **レプリケーションインスタンス作成**
   - インスタンスタイプ: dms.t3.medium
   - VPC: facilities-prod-vpc
   - サブネット: Private Subnet

2. **ソースエンドポイント作成**
   - エンジン: PostgreSQL
   - サーバー: 現行RDSエンドポイント
   - ポート: 5432
   - SSL mode: require

3. **ターゲットエンドポイント作成**
   - エンジン: PostgreSQL
   - サーバー: 新規RDSエンドポイント
   - ポート: 5432
   - SSL mode: require

4. **レプリケーションタスク作成**
   - タスクタイプ: Full load + CDC（変更データキャプチャ）
   - LOB設定: Limited LOB mode
   - テーブルマッピング: すべてのテーブル

5. **カットオーバー**
   - アプリケーション停止
   - 最終同期確認
   - 新RDSへの接続切り替え
   - アプリケーション起動

#### 方式2: 論理バックアップ（pg_dump/pg_restore）

1. **現行RDSからバックアップ**
   ```bash
   pg_dump -h current-rds-endpoint \
           -U admin \
           -d facilities \
           -F c \
           -f facilities_backup.dump
   ```

2. **新規RDSへ復元**
   ```bash
   pg_restore -h facilities-prod-db.xxxxx.ap-northeast-1.rds.amazonaws.com \
              -U admin \
              -d facilities \
              -F c \
              facilities_backup.dump
   ```

3. **データ整合性チェック**
   ```sql
   -- レコード数確認
   SELECT COUNT(*) FROM equipment;
   SELECT COUNT(*) FROM orders;
   ```

### 移行スケジュール

1. dev環境構築・データ移行（設計フェーズ完了後）
2. stg環境構築・データ移行（実装フェーズ中）
3. prod環境構築・データ移行（本番稼働直前）

---

## 4.9 災害対策（DR）

### RDS スナップショット

| 項目 | 設定値 | 備考 |
|------|--------|------|
| 自動スナップショット | 毎日（深夜2:00） | 7日間保持 |
| 手動スナップショット | デプロイ前 | 無期限保持（手動削除） |
| スナップショットコピー | 大阪リージョン | DR対策 |

### DR 手順（東京リージョン壊滅時）

1. **大阪リージョンのスナップショットから復元**
   ```bash
   aws rds restore-db-instance-from-db-snapshot \
     --db-instance-identifier facilities-prod-db-dr \
     --db-snapshot-identifier arn:aws:rds:ap-northeast-3:ACCOUNT_ID:snapshot:facilities-prod-db-snapshot \
     --region ap-northeast-3
   ```

2. **VPCエンドポイント更新**
   - 新しいRDSエンドポイントをSecrets Managerに登録
   - ECS タスク再起動

3. **動作確認**

**目標復旧時間（RTO）**: 24時間以内

---

## 4.10 ヒアリング事項（仮決定）

以下の項目は、本来ユーザーに確認すべきですが、合理的な仮決定をしました：

| 項目 | 仮決定内容 | 理由 | ユーザー確認推奨度 |
|------|----------|------|------------------|
| RDS インスタンスタイプ（prod） | db.t4g.medium | 性能要件とコストのバランス | 中 |
| RDS ストレージ（prod） | 100GB（初期値） | データ量の見積もりに基づく | 中 |
| バックアップ保持期間 | 7日間 | 1週間分で十分 | 低 |
| PITR 保持期間 | 35日（最長） | 長期的な復旧可能性を確保 | 低 |
| バックアップウィンドウ | 深夜2:00-3:00（JST） | 業務時間外の低負荷時間帯 | 低 |
| メンテナンスウィンドウ | 日曜日 深夜2:00-3:00（JST） | 業務時間外、システム停止日 | 低 |
| DR リージョン | 大阪リージョン | 東京リージョンからの地理的距離 | 高（災害対策のため） |
| パラメータグループ設定 | カスタム（log_statement=all等） | 監査要件を考慮 | 中 |

---

**作成者**: architect サブエージェント
**最終更新**: 2025-10-25
