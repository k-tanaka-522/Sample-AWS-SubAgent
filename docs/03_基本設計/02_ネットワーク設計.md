# 02. ネットワーク設計

**作成日**: 2025-10-25
**バージョン**: 1.1
**ステータス**: PM レビュー待ち
**更新履歴**:
- v1.1 (2025-10-25): マルチアカウント構成、Transit Gateway、拠点接続（Direct Connect）を追加

---

## 2.0 ネットワーク全体構成

### マルチアカウント・マルチVPC構成

本プロジェクトは、以下の2つのAWSアカウントで構成されます：

| アカウント | 役割 | 主要リソース |
|----------|------|-------------|
| **Shared Account** | ネットワークハブ・監査ログ集約 | Transit Gateway、Direct Connect Gateway、Organizations（管理アカウント）、CloudTrail組織証跡、AWS Config、GuardDuty、Security Hub |
| **Service Account** | アプリケーション実行環境 | VPC、ECS、RDS、ALB、Cognito等 |

### ネットワーク接続構成

```
拠点（20拠点、計2,000台）
  ↓ Direct Connect（100Mbps）
Direct Connect Gateway（Shared Account）
  ↓
Transit Gateway（Shared Account）
  ↓ Transit Gateway Attachment
Service VPC（Service Account）
  ↓
  ├─ 閉域接続: 拠点 ⇔ 業務アプリ（内部ALB）
  └─ インターネット接続: 事業者 → 事業者アプリ（パブリックALB）
```

---

## 2.1 VPC設計

### VPC CIDR設計（Service Account）

| 環境 | VPC CIDR | 説明 | IPアドレス数 |
|------|----------|------|-------------|
| **dev** | 10.0.0.0/16 | 開発環境 | 65,536 |
| **stg** | 10.1.0.0/16 | ステージング環境 | 65,536 |
| **prod** | 10.2.0.0/16 | 本番環境 | 65,536 |

### 拠点CIDR設計

| ネットワーク | CIDR | 説明 | IPアドレス数 |
|------------|------|------|-------------|
| **拠点ネットワーク** | 172.16.0.0/16 | 20拠点の集約CIDR | 65,536 |
| 拠点01 | 172.16.1.0/24 | 端末100台 + 余裕 | 256 |
| 拠点02 | 172.16.2.0/24 | 端末100台 + 余裕 | 256 |
| ... | ... | ... | ... |
| 拠点20 | 172.16.20.0/24 | 端末100台 + 余裕 | 256 |

**設計方針**:
- 各環境で独立したVPCを作成
- CIDRブロックは重複しないように設計（拠点: 172.16.x.x、Service VPC: 10.x.x.x）
- Transit Gateway で拠点とService VPCを接続

### VPC設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| DNS resolution | 有効 | RDSエンドポイント名前解決のため |
| DNS hostnames | 有効 | ECS TaskにDNS名を割り当てるため |
| DHCP Options | デフォルト | AWS提供のDHCPオプション使用 |

---

## 2.2 サブネット設計

### サブネット構成（prod環境: 10.2.0.0/16）

| サブネット種別 | AZ | CIDR | 用途 | IPアドレス数 |
|-------------|----|----|------|-------------|
| **Public Subnet 1** | ap-northeast-1a | 10.2.0.0/24 | ALB、NAT Gateway | 256 |
| **Public Subnet 2** | ap-northeast-1c | 10.2.1.0/24 | ALB、NAT Gateway | 256 |
| **Private Subnet 1** | ap-northeast-1a | 10.2.2.0/24 | ECS Fargate | 256 |
| **Private Subnet 2** | ap-northeast-1c | 10.2.3.0/24 | ECS Fargate | 256 |
| **DB Subnet 1** | ap-northeast-1a | 10.2.4.0/24 | RDS PostgreSQL | 256 |
| **DB Subnet 2** | ap-northeast-1c | 10.2.5.0/24 | RDS PostgreSQL | 256 |

### サブネット配置図

```mermaid
graph TB
    subgraph VPC["VPC (10.2.0.0/16) - prod"]
        subgraph AZ1["AZ: ap-northeast-1a"]
            PublicSubnet1["Public Subnet<br/>10.2.0.0/24"]
            PrivateSubnet1["Private Subnet<br/>10.2.2.0/24"]
            DBSubnet1["DB Subnet<br/>10.2.4.0/24"]
        end

        subgraph AZ2["AZ: ap-northeast-1c"]
            PublicSubnet2["Public Subnet<br/>10.2.1.0/24"]
            PrivateSubnet2["Private Subnet<br/>10.2.3.0/24"]
            DBSubnet2["DB Subnet<br/>10.2.5.0/24"]
        end

        PublicSubnet1 --> PrivateSubnet1
        PublicSubnet2 --> PrivateSubnet2
        PrivateSubnet1 --> DBSubnet1
        PrivateSubnet2 --> DBSubnet2
    end

    style PublicSubnet1 fill:#ffe6e6
    style PublicSubnet2 fill:#ffe6e6
    style PrivateSubnet1 fill:#e6ffe6
    style PrivateSubnet2 fill:#e6ffe6
    style DBSubnet1 fill:#fff3e6
    style DBSubnet2 fill:#fff3e6
```

### サブネット種別の役割

#### Public Subnet
- **用途**: インターネットに直接接続するリソース
- **配置するリソース**:
  - ALB（Application Load Balancer）
  - NAT Gateway
- **インターネットアクセス**: Internet Gateway経由

#### Private Subnet
- **用途**: インターネットに直接公開しないリソース
- **配置するリソース**:
  - ECS Fargate タスク
- **インターネットアクセス**: NAT Gateway経由（アウトバウンドのみ）

#### DB Subnet
- **用途**: データベース専用サブネット
- **配置するリソース**:
  - RDS PostgreSQL
- **インターネットアクセス**: 不可（完全閉域）

### dev/stg環境のサブネット設計

#### dev環境（10.0.0.0/16）

| サブネット種別 | AZ | CIDR | 用途 |
|-------------|----|----|------|
| Public Subnet 1 | ap-northeast-1a | 10.0.0.0/24 | ALB、NAT Gateway |
| Private Subnet 1 | ap-northeast-1a | 10.0.2.0/24 | ECS Fargate |
| DB Subnet 1 | ap-northeast-1a | 10.0.4.0/24 | RDS PostgreSQL |

**注**: dev環境はシングルAZ構成でコスト削減

#### stg環境（10.1.0.0/16）

| サブネット種別 | AZ | CIDR | 用途 |
|-------------|----|----|------|
| Public Subnet 1 | ap-northeast-1a | 10.1.0.0/24 | ALB、NAT Gateway |
| Public Subnet 2 | ap-northeast-1c | 10.1.1.0/24 | ALB、NAT Gateway |
| Private Subnet 1 | ap-northeast-1a | 10.1.2.0/24 | ECS Fargate |
| Private Subnet 2 | ap-northeast-1c | 10.1.3.0/24 | ECS Fargate |
| DB Subnet 1 | ap-northeast-1a | 10.1.4.0/24 | RDS PostgreSQL |
| DB Subnet 2 | ap-northeast-1c | 10.1.5.0/24 | RDS PostgreSQL |

---

## 2.3 ルーティング設計

### ルートテーブル構成（prod環境）

#### Public Subnet ルートテーブル

| Destination | Target | 説明 |
|------------|--------|------|
| 10.2.0.0/16 | local | VPC内通信 |
| 0.0.0.0/0 | igw-xxxxx | インターネット向け通信（Internet Gateway） |

**関連付けサブネット**:
- Public Subnet 1 (10.2.0.0/24)
- Public Subnet 2 (10.2.1.0/24)

#### Private Subnet 1 ルートテーブル（AZ-a）

| Destination | Target | 説明 |
|------------|--------|------|
| 10.2.0.0/16 | local | VPC内通信 |
| 172.16.0.0/16 | tgw-xxxxx | 拠点向け通信（Transit Gateway） |
| 0.0.0.0/0 | nat-xxxxx (AZ-a) | インターネット向け通信（NAT Gateway AZ-a） |

**関連付けサブネット**:
- Private Subnet 1 (10.2.2.0/24)

#### Private Subnet 2 ルートテーブル（AZ-c）

| Destination | Target | 説明 |
|------------|--------|------|
| 10.2.0.0/16 | local | VPC内通信 |
| 172.16.0.0/16 | tgw-xxxxx | 拠点向け通信（Transit Gateway） |
| 0.0.0.0/0 | nat-yyyyy (AZ-c) | インターネット向け通信（NAT Gateway AZ-c） |

**関連付けサブネット**:
- Private Subnet 2 (10.2.3.0/24)

#### DB Subnet ルートテーブル

| Destination | Target | 説明 |
|------------|--------|------|
| 10.2.0.0/16 | local | VPC内通信のみ |

**関連付けサブネット**:
- DB Subnet 1 (10.2.4.0/24)
- DB Subnet 2 (10.2.5.0/24)

**注**: DB Subnetはインターネットアクセス不可（完全閉域）

### ルーティングフロー図

```mermaid
graph LR
    Internet["インターネット"]
    IGW["Internet Gateway"]
    NATGW1["NAT Gateway<br/>AZ-a"]
    NATGW2["NAT Gateway<br/>AZ-c"]

    subgraph PublicSubnet["Public Subnet"]
        ALB["ALB"]
    end

    subgraph PrivateSubnet1["Private Subnet AZ-a"]
        ECS1["ECS Fargate"]
    end

    subgraph PrivateSubnet2["Private Subnet AZ-c"]
        ECS2["ECS Fargate"]
    end

    subgraph DBSubnet["DB Subnet"]
        RDS["RDS PostgreSQL"]
    end

    Internet <-->|双方向| IGW
    IGW <-->|双方向| ALB
    ALB -->|リクエスト転送| ECS1
    ALB -->|リクエスト転送| ECS2
    ECS1 -->|アウトバウンド| NATGW1
    ECS2 -->|アウトバウンド| NATGW2
    NATGW1 -->|外部API呼び出し| Internet
    NATGW2 -->|外部API呼び出し| Internet
    ECS1 -->|SQL| RDS
    ECS2 -->|SQL| RDS

    style PublicSubnet fill:#ffe6e6
    style PrivateSubnet1 fill:#e6ffe6
    style PrivateSubnet2 fill:#e6ffe6
    style DBSubnet fill:#fff3e6
```

---

## 2.4 Internet Gateway / NAT Gateway 設計

### Internet Gateway

| 項目 | 設定値 | 備考 |
|------|--------|------|
| 配置場所 | VPC | VPCに1つアタッチ |
| 用途 | パブリックサブネットからのインターネット双方向通信 | ALBへのアクセス、NAT Gatewayからの外部通信 |

### NAT Gateway

#### NAT Gateway 配置（prod環境）

| NAT Gateway | 配置AZ | 配置サブネット | Elastic IP | 用途 |
|------------|--------|---------------|-----------|------|
| NAT GW 1 | ap-northeast-1a | Public Subnet 1 | eipalloc-xxxxx | Private Subnet 1 からのインターネットアクセス |
| NAT GW 2 | ap-northeast-1c | Public Subnet 2 | eipalloc-yyyyy | Private Subnet 2 からのインターネットアクセス |

**設計方針**:
- **マルチAZ配置**: AZ障害時にも他のAZのNAT Gatewayが動作
- **AZ毎にNAT Gateway**: クロスAZ通信を最小化し、可用性向上
- **コスト**: 月額約26,800円（2AZ × $0.062/h × 24h × 30日）

#### dev環境のNAT Gateway

| NAT Gateway | 配置AZ | 配置サブネット | 備考 |
|------------|--------|---------------|------|
| NAT GW 1 | ap-northeast-1a | Public Subnet 1 | シングルAZ構成（コスト削減） |

---

## 2.5 VPC エンドポイント設計

### VPC エンドポイント（オプション、コスト最適化）

VPC エンドポイントを使用することで、NAT Gateway 経由の通信を削減し、コストを削減できます。

#### 推奨するVPCエンドポイント（prod環境）

| サービス | エンドポイントタイプ | 用途 | コスト削減効果 |
|---------|------------------|------|---------------|
| S3 | Gateway | ECS → S3 通信（ログ保管） | NAT Gateway データ転送料削減 |
| ECR (API) | Interface | ECS → ECR 通信（イメージPull） | NAT Gateway データ転送料削減 |
| ECR (DKR) | Interface | ECS → ECR 通信（イメージPull） | NAT Gateway データ転送料削減 |
| CloudWatch Logs | Interface | ECS → CloudWatch Logs 通信 | NAT Gateway データ転送料削減 |
| Secrets Manager | Interface | ECS → Secrets Manager 通信 | NAT Gateway データ転送料削減 |

**VPCエンドポイント設計図**

```mermaid
graph TB
    subgraph VPC["VPC"]
        subgraph PrivateSubnet["Private Subnet"]
            ECS["ECS Fargate"]
        end

        subgraph VPCEndpoints["VPC Endpoints"]
            S3EP["S3 Gateway<br/>Endpoint"]
            ECREP["ECR Interface<br/>Endpoint"]
            CWEP["CloudWatch Logs<br/>Interface Endpoint"]
            SMEP["Secrets Manager<br/>Interface Endpoint"]
        end
    end

    subgraph AWSServices["AWS Services"]
        S3["S3"]
        ECR["ECR"]
        CloudWatch["CloudWatch"]
        SecretsManager["Secrets Manager"]
    end

    ECS -->|VPC Endpoint| S3EP
    ECS -->|VPC Endpoint| ECREP
    ECS -->|VPC Endpoint| CWEP
    ECS -->|VPC Endpoint| SMEP

    S3EP -->|AWS PrivateLink| S3
    ECREP -->|AWS PrivateLink| ECR
    CWEP -->|AWS PrivateLink| CloudWatch
    SMEP -->|AWS PrivateLink| SecretsManager

    style PrivateSubnet fill:#e6ffe6
    style VPCEndpoints fill:#fff3e6
```

**コスト試算（VPCエンドポイント使用時）**:
- S3 Gateway Endpoint: 無料
- Interface Endpoint（ECR、CloudWatch、Secrets Manager）: 約$0.01/h × 3サービス × 24h × 30日 = 約21.6ドル/月（約3,200円/月）
- NAT Gateway データ転送料削減: 約10,000円/月削減（見積もり）
- **差引: 約6,800円/月のコスト削減**

**注**: VPCエンドポイントの採用は、運用開始後のデータ転送量を見て判断可能。

---

## 2.6 ネットワークACL（NACL）設計

### NACL 設計方針

- **デフォルトNACL使用**: すべてのサブネットでデフォルトNACL（全許可）を使用
- **Security Groupで制御**: ネットワークセキュリティはSecurity Groupで実施
- **理由**: NACLはステートレスで管理が複雑になるため、よりシンプルなSecurity Groupで制御

### NACL ルール（デフォルト）

#### Inbound

| ルール# | タイプ | プロトコル | ポート | ソース | 許可/拒否 |
|---------|--------|----------|--------|--------|---------|
| 100 | すべて | すべて | すべて | 0.0.0.0/0 | 許可 |
| * | すべて | すべて | すべて | 0.0.0.0/0 | 拒否 |

#### Outbound

| ルール# | タイプ | プロトコル | ポート | 送信先 | 許可/拒否 |
|---------|--------|----------|--------|--------|---------|
| 100 | すべて | すべて | すべて | 0.0.0.0/0 | 許可 |
| * | すべて | すべて | すべて | 0.0.0.0/0 | 拒否 |

---

## 2.7 Transit Gateway 設計（Shared Account）

### Transit Gateway 構成

| 項目 | 設定値 | 備考 |
|------|--------|------|
| 配置アカウント | Shared Account | ネットワークハブとして集中管理 |
| ASN | 64512 | デフォルトASN |
| デフォルトルートテーブル | 有効 | 自動伝播 |
| DNS サポート | 有効 | |
| VPN ECMP サポート | 有効 | |
| マルチキャストサポート | 無効 | 今回は不使用 |

### Transit Gateway Attachment（Service Account）

| Attachment名 | アタッチ先 | 環境 | サブネット | 備考 |
|-------------|----------|------|----------|------|
| facilities-dev-tgw-attach | facilities-dev-vpc | dev | Private Subnet 1 | シングルAZ |
| facilities-stg-tgw-attach | facilities-stg-vpc | stg | Private Subnet 1, 2 | マルチAZ |
| facilities-prod-tgw-attach | facilities-prod-vpc | prod | Private Subnet 1, 2 | マルチAZ |

### Transit Gateway Route Table

| Destination | Target | 説明 |
|------------|--------|------|
| 10.0.0.0/16 | facilities-dev-tgw-attach | dev環境向け |
| 10.1.0.0/16 | facilities-stg-tgw-attach | stg環境向け |
| 10.2.0.0/16 | facilities-prod-tgw-attach | prod環境向け |
| 172.16.0.0/16 | dxgw-xxxxx | 拠点向け（Direct Connect Gateway経由） |

### クロスアカウント共有（AWS RAM）

Transit Gateway を Shared Account から Service Account に共有：

| 項目 | 設定値 |
|------|--------|
| リソース | Transit Gateway（tgw-xxxxx） |
| 共有先 | Service Account（AWS Organizations 経由） |
| プリンシパル | Service Account ID または OU ID |

---

## 2.8 Direct Connect 設計（Shared Account）

### Direct Connect 構成

| 項目 | 設定値 | 備考 |
|------|--------|------|
| 配置アカウント | Shared Account | |
| 専用線タイプ | Hosted Connection（100Mbps） | |
| ロケーション | （工事完了次第確定） | |
| 月額料金 | 約¥5,670/月 | |
| データ転送料（送信） | ¥9/GB | |

### Direct Connect Gateway 構成

| 項目 | 設定値 | 備考 |
|------|--------|------|
| 名前 | facilities-dxgw | |
| ASN | 65000 | 拠点側ルーターのASN |
| 接続先 | Transit Gateway | |
| 許可プレフィックス | 172.16.0.0/16 | 拠点CIDR |

### Virtual Interface (VIF)

| 項目 | 設定値 | 備考 |
|------|--------|------|
| VIF タイプ | Transit Virtual Interface | |
| VLAN ID | （工事完了次第確定） | |
| BGP ASN（AWS側） | 64512 | Transit Gateway ASN |
| BGP ASN（拠点側） | 65000 | 拠点ルーターASN |
| 認証 | BGP MD5 認証 | セキュリティ強化 |

### 拠点接続フロー

```mermaid
graph LR
    A[拠点20拠点<br/>172.16.0.0/16] -->|Direct Connect<br/>100Mbps| B[Direct Connect Gateway<br/>Shared Account]
    B -->|Transit VIF| C[Transit Gateway<br/>Shared Account]
    C -->|TGW Attachment| D[Service VPC<br/>Service Account<br/>10.x.0.0/16]
    D -->|内部ALB| E[ECS Fargate<br/>業務アプリ]

    style A fill:#ffe6e6
    style B fill:#e6f3ff
    style C fill:#e6f3ff
    style D fill:#e6ffe6
    style E fill:#fff3e6
```

### 冗長化構成（将来の拡張）

現在は単一のDirect Connect接続ですが、将来的に以下の冗長化が可能です：

| 冗長化方式 | 構成 | 追加コスト |
|----------|------|----------|
| Direct Connect 冗長化 | 2本目のDirect Connect追加 | 約¥5,670/月 |
| VPN バックアップ | Site-to-Site VPN を追加 | 約¥4,000/月 |

---

## 2.9 ネットワーク設計のベストプラクティス

### AWS Well-Architected Framework 準拠

| 柱 | 実装内容 |
|----|----------|
| **セキュリティ** | ✅ プライベートサブネットでECS配置<br/>✅ DB Subnetは完全閉域<br/>✅ Security Groupで最小権限 |
| **信頼性** | ✅ マルチAZ構成（2AZ）<br/>✅ NAT Gatewayも冗長化 |
| **パフォーマンス** | ✅ VPCエンドポイントで低レイテンシ |
| **コスト最適化** | ✅ dev環境はシングルAZ<br/>✅ VPCエンドポイントでNAT Gateway料金削減 |

### セキュリティベストプラクティス

1. **最小権限の原則**:
   - DB SubnetはVPC内通信のみ
   - Private SubnetはNAT Gateway経由のアウトバウンドのみ

2. **多層防御**:
   - ネットワーク層（Subnet分離）
   - トランスポート層（Security Group）
   - アプリケーション層（WAF）

3. **監視と記録**:
   - VPC Flow Logs 有効化（すべてのサブネット）
   - CloudTrail で AWS API 呼び出しを記録

---

## 2.10 ヒアリング事項

以下の項目は、ユーザーヒアリングで確定しました：

| 項目 | 確定内容 | ヒアリング結果 |
|------|---------|--------------|
| ✅ 拠点接続方式 | AWS Direct Connect（100Mbps） | ユーザー確認済み |
| ✅ 拠点数・端末数 | 20拠点、各100台（計2,000台） | ユーザー確認済み |
| ✅ 拠点CIDR | 172.16.0.0/16（各拠点 /24） | ユーザー確認済み |
| ✅ アクセス方向 | 双方向（拠点 ⇔ Service Account） | ユーザー確認済み |
| ✅ Shared Account構築 | 今回のプロジェクトに含める | ユーザー確認済み |
| ✅ 監査ログ集約 | Shared Accountで集約 | ユーザー確認済み |
| ✅ AWS Organizations | 使用する（Shared Accountが管理アカウント） | ユーザー確認済み |
| ✅ Direct Connect接続方式 | Direct Connect Gateway + Transit Gateway | ユーザー確認済み |

以下の項目は、本来ユーザーに確認すべきですが、合理的な仮決定をしました：

| 項目 | 仮決定内容 | 理由 | ユーザー確認推奨度 |
|------|----------|------|------------------|
| VPC CIDR設計 | dev: 10.0.0.0/16, stg: 10.1.0.0/16, prod: 10.2.0.0/16 | 標準的な分割、重複なし | 低 |
| サブネット分割 | /24 単位（256 IPアドレス） | ECS タスク数を考慮して十分な余裕 | 低 |
| NAT Gateway 配置 | マルチAZ（2AZ） | 可用性向上のため必須 | 低 |
| Transit Gateway ASN | 64512 | AWS デフォルトASN | 低 |
| 拠点ルーター ASN | 65000 | プライベートASN範囲 | 中（拠点側ネットワーク担当に確認） |
| BGP 認証 | MD5 認証 | セキュリティベストプラクティス | 低 |

---

**作成者**: PM（architect サブエージェント監修）
**最終更新**: 2025-10-25 v1.1（マルチアカウント構成、Transit Gateway、Direct Connect追加）
