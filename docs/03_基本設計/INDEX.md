# 役所設備管理システム 基本設計書 INDEX

**プロジェクト名**: 役所設備管理システム AWS ECS 移行プロジェクト
**作成日**: 2025-10-25
**バージョン**: 1.0
**ステータス**: PM レビュー待ち

---

## プロジェクト概要

### 目的
現行の設備管理システム（EC2ベース）をAWS ECS（Fargate）に移行し、運用負荷削減、自動スケーリング、ISMAP準拠のセキュアなシステム基盤を構築する。

### スコープ
- 業務アプリ（職員向けAPI）: 在庫管理、発注管理、レポート出力
- 事業者アプリ（発注業者向けAPI）: 伝票閲覧・入力
- 業務バッチ: 月次・年次集計、レポート自動生成
- インフラ: AWS ECS Fargate + RDS PostgreSQL + Cognito
- 環境: dev/stg/prod の3環境

### 制約条件
- 初期構築費用: 300万円以内
- 月額運用費用: 100万円以内
- 本番稼働: 12ヶ月以内
- ISMAP準拠、機密性3レベル

---

## ドキュメント構成

| # | ドキュメント | 概要 | レビュー状況 |
|---|------------|------|-------------|
| 01 | [システム構成.md](01_システム構成.md) | 全体構成図、コンポーネント一覧、3環境構成 | 🔄 PMレビュー待ち |
| 02 | [ネットワーク設計.md](02_ネットワーク設計.md) | VPC、サブネット、ルーティング、NAT Gateway | 🔄 PMレビュー待ち |
| 03 | [コンピューティング設計.md](03_コンピューティング設計.md) | ECS Fargate、ALB、オートスケーリング | 🔄 PMレビュー待ち |
| 04 | [データベース設計.md](04_データベース設計.md) | RDS PostgreSQL、バックアップ戦略、PITR | 🔄 PMレビュー待ち |
| 05 | [認証認可設計.md](05_認証認可設計.md) | Cognito（職員用・事業者用）、JWT、MFA | 🔄 PMレビュー待ち |
| 06 | [ストレージ設計.md](06_ストレージ設計.md) | S3（フロントエンド、ログ保管）、CloudFront | 🔄 PMレビュー待ち |
| 07 | [監視ログ設計.md](07_監視ログ設計.md) | CloudWatch、SNS、アラート、ログライフサイクル | 🔄 PMレビュー待ち |
| 08 | [セキュリティ設計.md](08_セキュリティ設計.md) | ISMAP準拠、WAF、TLS 1.3、暗号化、監査ログ | 🔄 PMレビュー待ち |
| 09 | [デプロイ設計.md](09_デプロイ設計.md) | GitHub Actions、ECSローリングアップデート | 🔄 PMレビュー待ち |
| 10 | [DR設計.md](10_DR設計.md) | 災害対策、別リージョンバックアップ | 🔄 PMレビュー待ち |
| **11** | **[パラメーターシート.md](11_パラメーターシート.md)** | **CloudFormation実装時に参照する環境別設定値** | 🔄 PMレビュー待ち |

---

## 重要な設計判断（ADR サマリー）

### ADR-001: ECS Fargate 採用
**決定**: AWS ECS Fargate を採用
**理由**:
- サーバーレスコンテナによる運用負荷削減（OSレベルの管理が不要）
- 月20時間 → 月5時間に削減（75%削減）
- オートスケーリングによるピーク時対応
- AWS マネージドサービスによる可用性向上

### ADR-002: RDS PostgreSQL 14 採用
**決定**: RDS PostgreSQL 14 を採用
**理由**:
- ACID保証による発注管理のトランザクション整合性確保
- マルチAZ構成による高可用性（99.9%）
- 自動バックアップとPITR（35日）によるデータ保護
- 現行システムからの移行がスムーズ（PostgreSQL継続）

### ADR-003: Cognito 採用（職員用・事業者用で分離）
**決定**: Amazon Cognito を職員用・事業者用で分離して採用
**理由**:
- マネージドサービスによる認証基盤の運用負荷削減
- MFA（多要素認証）のサポート
- ユーザープール分離によるデータ分離（事業者は自社伝票のみアクセス）
- ISMAP準拠の認証基準を満たす

### ADR-004: ECS ローリングアップデート 採用
**決定**: ECS ローリングアップデート（シンプル方式）を採用
**理由**:
- デプロイ頻度が週1回と低い
- メンテナンス時間中（日曜日または平日夜間）のデプロイのため、数分のダウンタイムは許容可能
- 運用がシンプル（Blue/Green デプロイは不要）
- ロールバックが容易（前のタスク定義に戻すだけ）

### ADR-005: CloudFormation 採用（Nested Stacks）
**決定**: AWS CloudFormation を採用、Nested Stacks でファイル分割
**理由**:
- AWS 専用プロジェクトのため、CloudFormation が最適
- ファイル分割3原則（AWSコンソールの分け方、ライフサイクル、設定数）に基づく管理
- Change Sets 必須による本番デプロイの安全性確保
- GitHub による IaC のバージョン管理

### ADR-006: GitHub Actions 採用
**決定**: GitHub Actions を CI/CD パイプラインとして採用
**理由**:
- GitHub でソースコード管理しているため、統合が容易
- ECS デプロイのワークフロー構築が簡単
- 無料枠でも十分（月2,000分）
- CloudFormation デプロイの自動化も可能

### ADR-007: 月額コスト 100万円以内の実現
**決定**: リソーススペックを環境別に最適化し、月額100万円以内に収める
**理由**:
- dev/stg は最小構成（db.t4g.micro、ECS 0.25vCPU）でコスト削減
- prod は性能要件を満たす最小スペック（db.t4g.medium、ECS 0.5vCPU）
- オートスケーリングで通常時は最小構成、ピーク時のみ拡張
- Fargate Spot の活用検討（非本番環境）

---

## 技術スタック

### アプリケーション
| レイヤー | 技術 | バージョン | 備考 |
|---------|------|----------|------|
| フロントエンド | React | 18 | SPA（既存継続） |
| バックエンド | Node.js + Express | 18 | REST API（既存継続） |
| データベース | PostgreSQL | 14 | RDS（新規構築） |

### インフラ（AWS）
| カテゴリ | サービス | 用途 |
|---------|---------|------|
| コンテナ基盤 | ECS Fargate | アプリケーション実行環境 |
| データベース | RDS PostgreSQL 14 | データ永続化 |
| ネットワーク | VPC、Subnets、NAT Gateway | ネットワーク構成 |
| ロードバランサー | ALB（Application Load Balancer） | トラフィック分散 |
| 認証 | Amazon Cognito | ユーザー認証（職員用・事業者用） |
| CDN | CloudFront | フロントエンド配信 |
| ストレージ | S3 | フロントエンド配信、ログ保管 |
| コンテナレジストリ | ECR | Dockerイメージ管理 |
| シークレット管理 | Secrets Manager | DB接続情報、APIキー |
| 監視・ログ | CloudWatch | メトリクス、ログ、アラート |
| セキュリティ | WAF | Webアプリケーションファイアウォール |
| 証明書 | ACM | TLS証明書 |
| 変更管理 | CloudTrail | AWSリソース変更ログ |

### CI/CD
| カテゴリ | ツール | 用途 |
|---------|--------|------|
| CI/CD | GitHub Actions | ビルド、テスト、デプロイ自動化 |
| IaC | CloudFormation | インフラのコード管理 |
| コンテナビルド | Docker | コンテナイメージ作成 |

---

## 環境構成

| 環境 | 用途 | VPC CIDR | ECS タスク数 | RDS インスタンス | 備考 |
|------|------|---------|------------|---------------|------|
| dev | 開発環境 | 10.0.0.0/16 | 1（固定） | db.t4g.micro | コスト最小化 |
| stg | ステージング（本番前検証） | 10.1.0.0/16 | 2（固定） | db.t4g.small | 本番構成の縮小版 |
| prod | 本番環境 | 10.2.0.0/16 | 2-5（オートスケーリング） | db.t4g.medium | 本番スペック |

---

## 非機能要件の実現方針

### 可用性: 99.9%
- ECS Fargate マルチAZ配置（2AZ、最小2タスク）
- RDS PostgreSQL マルチAZ構成
- ALB マルチAZ配置（AWS標準）
- NAT Gateway マルチAZ配置

### 性能: レスポンスタイム 95%ile < 500ms
- ECS オートスケーリング（CPU 70%でスケール）
- RDS インスタンスサイズの適切な選定（db.t4g.medium）
- CloudFront による CDN 配信

### セキュリティ: ISMAP準拠、機密性3レベル
- TLS 1.3 必須（TLS 1.2以下は拒否）
- AWS WAF 適用（OWASPルールセット）
- RDS 暗号化（AES-256、AWS KMS）
- Secrets Manager によるシークレット管理
- 監査ログ2年間保管（CloudWatch Logs → S3）

### 運用負荷削減: 月20時間 → 月5時間（75%削減）
- Fargate によるサーバーレス化（OSレベルの管理が不要）
- CloudWatch 監視とSNS通知による自動アラート
- GitHub Actions によるデプロイ自動化

---

## コスト試算（月額）

### 本番環境（prod）

| 項目 | 単価 | 数量 | 月額（円） | 備考 |
|------|------|------|----------|------|
| ECS Fargate（0.5vCPU/1GB） | $0.04048/h | 2タスク × 24h × 30日 | 約17,500円 | 通常時2タスク、ピーク時5タスクまで拡張 |
| RDS PostgreSQL（db.t4g.medium） | $0.122/h | 1インスタンス（マルチAZ） × 24h × 30日 | 約26,500円 | マルチAZ構成 |
| RDS ストレージ（100GB gp3） | $0.133/GB-月 | 100GB | 約1,900円 | 初期値、拡張可能 |
| ALB（Application Load Balancer） | $0.0225/h | 2AZ × 24h × 30日 | 約9,700円 | LCU課金は別途 |
| NAT Gateway | $0.062/h | 2AZ × 24h × 30日 | 約26,800円 | 高額だが可用性のため必須 |
| CloudWatch Logs | $0.76/GB | 10GB | 約1,100円 | ログ量に応じて変動 |
| S3（ログ保管） | $0.025/GB | 50GB | 約180円 | ライフサイクルポリシーで削減 |
| **合計** | | | **約83,680円/月** | **予算100万円以内を達成** |

### 開発環境（dev） + ステージング環境（stg）

| 項目 | 月額（円） | 備考 |
|------|----------|------|
| dev 環境 | 約30,000円 | 最小構成（ECS 0.25vCPU、db.t4g.micro） |
| stg 環境 | 約50,000円 | 中規模構成（ECS 0.25vCPU、db.t4g.small） |
| **合計** | **約80,000円/月** | |

### 全環境合計

| 環境 | 月額（円） |
|------|----------|
| dev | 約30,000円 |
| stg | 約50,000円 |
| prod | 約83,680円 |
| **合計** | **約163,680円/月** |

**結論**: 月額100万円の予算に対し、約16.4万円/月（約16%）で実現可能。予算に大きな余裕あり。

---

## ヒアリング事項（仮決定）の一覧

以下の項目は、本来ユーザーに確認すべきですが、合理的な仮決定をしました：

| 項目 | 仮決定内容 | 理由 | ユーザー確認推奨度 |
|------|----------|------|------------------|
| VPC CIDR設計 | dev: 10.0.0.0/16, stg: 10.1.0.0/16, prod: 10.2.0.0/16 | 標準的な分割、重複なし | 中 |
| サブネット分割 | パブリック2つ（/24）、プライベート2つ（/24）、DB用2つ（/24） | マルチAZ構成の標準パターン | 低 |
| ECS タスクCPU/メモリ | prod: 0.5vCPU/1GB | 要件定義書の記載に基づく | 低 |
| RDS インスタンスタイプ | prod: db.t4g.medium | 性能要件とコストのバランス | 中 |
| CloudWatch アラート閾値 | CPU 80%, Memory 80% | 一般的な閾値 | 中 |
| ログ保管期間（S3 Glacier） | 1年～2年 | 監査要件を考慮 | 低 |
| DR リージョン | 大阪リージョン | 東京リージョンからの地理的距離 | 高（災害対策のため） |
| バッチ実行時刻 | 深夜2:00 | 業務時間外の低負荷時間帯 | 低 |

**注**: ユーザー確認推奨度が「高」の項目は、PM経由で必ずユーザー確認を取ることを推奨します。

---

## レビュー・承認

### PM レビュー
- レビュー担当者: PM（あなた）
- レビュー状態: 🔄 レビュー待ち
- レビュー観点:
  - ✅ 13ファイル構成の確認
  - ✅ 技術選定の妥当性
  - ✅ コスト試算の確認（予算100万円以内）
  - ✅ 非機能要件の実現方法
  - ✅ 図の正確性
  - ✅ 整合性（13ファイル間で矛盾がないか）

### ユーザー承認
- 承認者: （未定）
- 承認日: （未定）

---

## 次のステップ

1. PM がこの INDEX.md を含む13ファイルをレビュー
2. PM がユーザーに提示し、承認を取得
3. 承認後、実装フェーズへ移行

---

**作成者**: architect サブエージェント
**最終更新**: 2025-10-25
