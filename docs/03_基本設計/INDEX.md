# 役所設備管理システム 基本設計書 INDEX

**プロジェクト名**: 役所設備管理システム AWS ECS 移行プロジェクト
**作成日**: 2025-10-25
**バージョン**: 2.2
**ステータス**: ユーザー承認完了、実装開始

**更新履歴**:
- v2.2 (2025-10-25): **AWS X-Ray 設計追加**（ADR-010: AWS X-Ray 採用）
- v2.1 (2025-10-25): **設計書クリーンアップ完了**（設定値を除去し、Why/Howのみに簡潔化、パラメーターシートとの役割分担を明確化）
- v2.0 (2025-10-25): **ドメインディレクトリ構成に変更**（設計書とパラメーターシートをセット化）、Client VPN 暫定実装
- v1.1 (2025-10-25): マルチアカウント構成追加（Shared Account + Transit Gateway + Direct Connect）
- v1.0 (2025-10-25): 初版作成

---

## プロジェクト概要

### 目的
現行の設備管理システム（EC2ベース）をAWS ECS（Fargate）に移行し、運用負荷削減、自動スケーリング、ISMAP準拠のセキュアなシステム基盤を構築する。

### スコープ
- 業務アプリ（職員向けAPI）: 在庫管理、発注管理、レポート出力
- 事業者アプリ（発注業者向けAPI）: 伝票閲覧・入力
- 業務バッチ: 月次・年次集計、レポート自動生成
- インフラ:
  - **Service Account**: AWS ECS Fargate + RDS PostgreSQL + Cognito
  - **Shared Account**: Transit Gateway + **Client VPN（暫定）** + 組織レベル監査基盤
- 環境: dev/stg/prod の3環境（Service Account）
- 拠点接続: 20拠点（各100台の端末）を**Client VPN経由**で接続（暫定、将来Direct Connectへ移行）

### 制約条件
- 初期構築費用: 300万円以内
- 月額運用費用: 100万円以内（**実績: 約31.7万円/月、68.3%の余裕**）
- 本番稼働: 12ヶ月以内
- ISMAP準拠、機密性3レベル

---

## ドキュメント構成（ドメインディレクトリ方式）

基本設計書は、**ドメインごとにディレクトリを分割**し、各ドメインに「設計書」と「パラメーターシート」をセットで配置しています。

| # | ドメイン | 設計書 | パラメーターシート | 概要 |
|---|---------|-------|------------------|------|
| 01 | **システム構成** | [設計書](01_システム構成/システム構成設計書.md) | - | マルチアカウント構成、全体構成図、コンポーネント一覧 |
| 02 | **ネットワーク** | [設計書](02_ネットワーク/ネットワーク設計書.md) | [パラメーター](02_ネットワーク/パラメーターシート.md) | Transit Gateway、Client VPN、VPC、サブネット、NAT Gateway |
| 03 | **コンピューティング** | [設計書](03_コンピューティング/コンピューティング設計書.md) | [パラメーター](03_コンピューティング/パラメーターシート.md) | ECS Fargate、ALB、オートスケーリング、バッチ、**X-Ray サイドカー** |
| 04 | **データベース** | [設計書](04_データベース/データベース設計書.md) | [パラメーター](04_データベース/パラメーターシート.md) | RDS PostgreSQL、バックアップ戦略、PITR |
| 05 | **認証認可** | [設計書](05_認証認可/認証認可設計書.md) | [パラメーター](05_認証認可/パラメーターシート.md) | Cognito（職員用・事業者用）、JWT、MFA |
| 06 | **ストレージ** | [設計書](06_ストレージ/ストレージ設計書.md) | [パラメーター](06_ストレージ/パラメーターシート.md) | S3（フロントエンド、ログ保管）、CloudFront |
| 07 | **監視ログ** | [設計書](07_監視ログ/監視ログ設計書.md) | [パラメーター](07_監視ログ/パラメーターシート.md) | CloudWatch、SNS、アラート、ログライフサイクル、組織監査、**AWS X-Ray** |
| 08 | **セキュリティ** | [設計書](08_セキュリティ/セキュリティ設計書.md) | [パラメーター](08_セキュリティ/パラメーターシート.md) | ISMAP準拠、WAF、TLS 1.3、暗号化、監査ログ |
| 09 | **デプロイ** | [設計書](09_デプロイ/デプロイ設計書.md) | [パラメーター](09_デプロイ/パラメーターシート.md) | GitHub Actions、ECSローリングアップデート、Change Sets |
| 10 | **DR** | [設計書](10_DR/DR設計書.md) | [パラメーター](10_DR/パラメーターシート.md) | 災害対策、別リージョンバックアップ |
| 99 | **全体サマリー** | - | [コスト試算](99_全体サマリー/コスト試算.md)<br/>[命名規則](99_全体サマリー/命名規則.md)<br/>[ユーザー確認事項](99_全体サマリー/ユーザー確認事項.md) | 全体のコスト、命名規則、確認事項 |

**ドメインディレクトリ方式のメリット**:
- ✅ **設計書（Why/How）とパラメーター（What）がセットで管理される**
- ✅ **設計書は設計理由と方針のみに集中**（具体的な設定値はパラメーターシートに記載）
- ✅ ドメインごとに独立してレビュー・編集可能
- ✅ Git差分が見やすい（変更の影響範囲が明確）
- ✅ 将来の拡張が容易（別紙、テスト仕様書等を同じディレクトリに追加可能）

---

## 重要な設計判断（ADR サマリー）

### ADR-001: ECS Fargate 採用
**決定**: AWS ECS Fargate を採用
**理由**: サーバーレスコンテナによる運用負荷削減（月20時間 → 月5時間、75%削減）、オートスケーリング、AWS マネージドサービスによる可用性向上

### ADR-002: RDS PostgreSQL 14 採用
**決定**: RDS PostgreSQL 14 を採用
**理由**: ACID保証、マルチAZ構成（99.9%）、自動バックアップとPITR（35日）、現行システムからの移行がスムーズ

### ADR-003: Cognito 採用（職員用・事業者用で分離）
**決定**: Amazon Cognito を職員用・事業者用で分離して採用
**理由**: マネージドサービスによる運用負荷削減、MFA サポート、ユーザープール分離によるデータ分離、ISMAP準拠

### ADR-004: ECS ローリングアップデート 採用
**決定**: ECS ローリングアップデート（シンプル方式）を採用
**理由**: デプロイ頻度が週1回と低い、メンテナンス時間中のデプロイのため数分のダウンタイムは許容可能、運用がシンプル

### ADR-005: CloudFormation 採用（Nested Stacks）
**決定**: AWS CloudFormation を採用、Nested Stacks でファイル分割
**理由**: ファイル分割3原則（AWSコンソールの分け方、ライフサイクル、設定数）に基づく管理、Change Sets 必須による安全性確保

### ADR-006: GitHub Actions 採用
**決定**: GitHub Actions を CI/CD パイプラインとして採用
**理由**: GitHub との統合が容易、ECS デプロイのワークフロー構築が簡単、無料枠で十分

### ADR-007: 月額コスト 100万円以内の実現
**決定**: リソーススペックを環境別に最適化し、月額100万円以内に収める
**理由**: dev/stg は最小構成、prod は性能要件を満たす最小スペック、オートスケーリングで通常時は最小構成

### ADR-008: マルチアカウント構成採用
**決定**: Shared Account と Service Account の2アカウント構成を採用
**理由**: 拠点（20拠点、2,000端末）との接続拡張に備えネットワークハブを分離、組織レベルの監査ログを Shared Account に集約、ISMAP 準拠のセキュリティガバナンス強化

### ADR-009: Client VPN 暫定採用
**決定**: 拠点接続に AWS Client VPN を暫定採用、将来 Direct Connect へ移行
**理由**: BGP ASN 準備中のため暫定実装、Transit Gateway 経由で全 Service VPC にアクセス可能、将来の Direct Connect 移行が容易

### ADR-010: AWS X-Ray 採用（v2.2 追加）
**決定**: AWS X-Ray を分散トレーシングツールとして採用
**理由**:
- ECS Fargate、RDS、S3、Cognito等のAWSサービスとの統合が容易
- サイドカーコンテナでアプリケーションコードへの影響を最小化
- X-Ray Service Mapで依存関係を可視化（ECS → RDS、ECS → S3、ECS → Cognito の呼び出しフロー）
- 非機能要件（レスポンスタイム 95%ile < 500ms）の達成確認が可能
- CloudWatch と統合してアラート可能（エラー率、レスポンスタイム）
- 月額コスト増は約3,420円（全体の1.1%）で、品質管理のメリットがコストを大きく上回る

**代替案**:
- New Relic: 高機能だがコストが高い（月額数万円）
- Datadog APM: 高機能だがコストが高い（月額数万円）
- OpenTelemetry + Jaeger: オープンソースだが運用負荷が高い

**結果**:
- コスト効率が高く（月額約3,420円）、AWSサービスとの統合が容易
- サンプリング率調整でコスト最適化が可能（prod: 5%、stg: 10%、dev: 100%）

---

## 技術スタック

### アプリケーション
| レイヤー | 技術 | バージョン |
|---------|------|----------|
| フロントエンド | React | 18 |
| バックエンド | Node.js + Express | 18 |
| データベース | PostgreSQL | 14 |

### インフラ（AWS）

#### Shared Account（共有基盤）
| サービス | 用途 |
|---------|------|
| AWS Organizations | マルチアカウント一元管理、SCP適用 |
| Transit Gateway | VPC・拠点間ルーティング |
| **Client VPN** | **拠点との閉域接続（暫定、将来Direct Connectへ）** |
| CloudTrail（組織） | 組織全体のAWS API呼び出し記録 |
| Config（組織） | リソース設定変更の記録 |
| GuardDuty（組織） | 不正アクセス・異常検知 |
| Security Hub（組織） | セキュリティアラート集約 |

#### Service Account（サービスアカウント）
| サービス | 用途 |
|---------|------|
| ECS Fargate | アプリケーション実行環境 |
| RDS PostgreSQL 14 | データ永続化 |
| VPC、Subnets、NAT Gateway | ネットワーク構成 |
| ALB | トラフィック分散 |
| Cognito | ユーザー認証（職員用・事業者用） |
| CloudFront | フロントエンド配信 |
| S3 | フロントエンド配信、ログ保管 |
| ECR | Dockerイメージ管理 |
| Secrets Manager | DB接続情報、APIキー |
| CloudWatch | メトリクス、ログ、アラート |
| **AWS X-Ray** | **分散トレーシング、パフォーマンス分析** |
| WAF | Webアプリケーションファイアウォール |
| ACM | TLS証明書 |

### CI/CD
| ツール | 用途 |
|--------|------|
| GitHub Actions | ビルド、テスト、デプロイ自動化 |
| CloudFormation | インフラのコード管理 |
| Docker | コンテナイメージ作成 |

---

## 環境構成

| 環境 | VPC CIDR | ECS タスク数 | RDS インスタンス | 月額コスト |
|------|---------|------------|---------------|----------|
| dev | 10.0.0.0/16 | 1（固定） | db.t4g.micro | 約3.1万円 |
| stg | 10.1.0.0/16 | 2（固定） | db.t4g.small | 約5.1万円 |
| prod | 10.2.0.0/16 | 2-5（オートスケーリング） | db.t4g.medium | 約8.6万円 |

---

## 非機能要件の実現方針

### 可用性: 99.9%
- ECS Fargate マルチAZ配置（2AZ、最小2タスク）
- RDS PostgreSQL マルチAZ構成
- ALB マルチAZ配置（AWS標準）
- NAT Gateway マルチAZ配置

### 性能: レスポンスタイム 95%ile < 500ms
- ECS オートスケーリング（CPU 70% **または** 応答時間 95%ile > 1秒）
- RDS インスタンスサイズの適切な選定（db.t4g.medium）
- CloudFront による CDN 配信
- **AWS X-Ray による継続的なパフォーマンス監視とボトルネック特定**

### セキュリティ: ISMAP準拠、機密性3レベル
- TLS 1.3 必須（TLS 1.2以下は拒否）
- AWS WAF 適用（OWASPルールセット）
- RDS 暗号化（AES-256、AWS KMS）
- Secrets Manager によるシークレット管理
- 監査ログ2年間保管（CloudWatch Logs → S3）

### 運用負荷削減: 月20時間 → 月5時間（75%削減）
- Fargate によるサーバーレス化（OSレベルの管理が不要）
- CloudWatch 監視とSNS通知による自動アラート
- GitHub Actions によるデプロイ自動化
- **AWS X-Ray による効率的なエラー追跡（トレースIDでログ検索）**

---

## コスト試算（月額）

| アカウント | 月額コスト | 内訳 |
|----------|----------|------|
| **Shared Account** | 約14.9万円 | Client VPN（約13.7万円）、Transit Gateway、組織監査 |
| **Service Account** | 約16.7万円 | dev（約3.1万円）+ stg（約5.1万円）+ prod（約8.6万円） |
| **合計** | **約31.7万円/月** | **予算100万円の31.7%、68.3%の余裕** |

**X-Ray 追加によるコスト増**:
- dev: +約600円
- stg: +約1,000円
- prod: +約1,820円
- **合計: +約3,420円/月（全体の1.1%）**

**コスト最適化の余地**:
- Direct Connect 移行で Client VPN コスト削減（約9.6万円/月削減見込み）

詳細は [99_全体サマリー/コスト試算.md](99_全体サマリー/コスト試算.md) を参照。

---

## レビュー・承認

### PM レビュー
- レビュー担当者: PM
- レビュー状態: ✅ 完了
- レビュー日: 2025-10-25

### ユーザー承認
- 承認者: ユーザー
- 承認状態: ✅ 完了
- 承認日: 2025-10-25

---

## 次のステップ

1. ✅ 基本設計書完成（ドメインディレクトリ構成 + AWS X-Ray 追加）
2. ✅ CloudFormation 実装完了（44ファイル）
3. 🔄 デプロイ実施（dev → stg → prod）
4. ⏳ テストフェーズ（X-Ray による性能テスト・エラー追跡）
5. ⏳ 納品フェーズ

---

**作成者**: architect サブエージェント + PM
**最終更新**: 2025-10-25
