# コンピューティング - パラメーターシート

**作成日**: 2025-10-25
**バージョン**: 1.3
**ステータス**: ユーザー承認完了、実装開始

---

## 概要

このドキュメントは、ECS Fargate、ALB、バッチ処理に関するCloudFormation実装時に参照する設定値を環境別にまとめたものです。

---

## 2. ECS Fargateパラメーター

### 2.1 ECS Cluster

| 環境 | Cluster 名 | キャパシティプロバイダー | Container Insights |
|------|-----------|----------------------|-------------------|
| dev | facilities-dev-cluster | FARGATE, FARGATE_SPOT | 有効 |
| stg | facilities-stg-cluster | FARGATE, FARGATE_SPOT | 有効 |
| prod | facilities-prod-cluster | FARGATE | 有効 |

### 2.2 ECS Task Definition（業務アプリ: staff-api）

| 環境 | Task Definition名 | CPU | メモリ | ポート | 備考 |
|------|------------------|-----|--------|--------|------|
| dev | facilities-staff-api | 0.25 vCPU (256) | 0.5GB (512) | 3000 | 開発用最小構成 |
| stg | facilities-staff-api | 0.25 vCPU (256) | 0.5GB (512) | 3000 | 検証用 |
| prod | facilities-staff-api | 0.5 vCPU (512) | 1GB (1024) | 3000 | 本番用 |

### 2.3 ECS Task Definition（事業者アプリ: vendor-api）

| 環境 | Task Definition名 | CPU | メモリ | ポート | 備考 |
|------|------------------|-----|--------|--------|------|
| dev | facilities-vendor-api | 0.25 vCPU (256) | 0.5GB (512) | 3000 | 開発用最小構成 |
| stg | facilities-vendor-api | 0.25 vCPU (256) | 0.5GB (512) | 3000 | 検証用 |
| prod | facilities-vendor-api | 0.5 vCPU (512) | 1GB (1024) | 3000 | 本番用 |

### 2.4 ECS Task Definition（バッチ: batch）

| 環境 | Task Definition名 | CPU | メモリ | 備考 |
|------|------------------|-----|--------|------|
| dev | facilities-batch | 0.25 vCPU (256) | 0.5GB (512) | 開発用最小構成 |
| stg | facilities-batch | 1 vCPU (1024) | 2GB (2048) | 検証用 |
| prod | facilities-batch | 2 vCPU (2048) | 4GB (4096) | 本番用（大量データ処理） |

### 2.5 ECS Service（タスク数）

| 環境 | staff-api タスク数 | vendor-api タスク数 | batch タスク数 | 備考 |
|------|------------------|-------------------|--------------|------|
| dev | 1（固定） | 1（固定） | 手動起動 | シングルタスク |
| stg | 2（固定） | 2（固定） | 手動起動 | マルチAZ |
| prod | 2-5（オートスケーリング） | 2-5（オートスケーリング） | 手動起動 | CPU 70%でスケール |

### 2.6 オートスケーリング設定（prod環境）

| パラメーター | staff-api | vendor-api | 備考 |
|------------|----------|-----------|------|
| 最小タスク数 | 2 | 2 | 通常時 |
| 最大タスク数 | 5 | 5 | ピーク時 |
| スケールアウト閾値 | CPU 70% **または** 応答時間 95%ile > 1秒 | CPU 70% **または** 応答時間 95%ile > 1秒 | 2分間連続 |
| スケールイン閾値 | CPU 50% **かつ** 応答時間 95%ile < 500ms | CPU 50% **かつ** 応答時間 95%ile < 500ms | 5分間連続 |
| クールダウン期間 | 300秒 | 300秒 | 頻繁なスケール防止 |

**注**: CPU使用率だけでなく、応答時間メトリクスも追加（DBアクセス待ちによる遅延に対応）

---

## 4. ALB（Application Load Balancer）パラメーター

### 4.1 ALB 構成

| ALB名 | 環境 | スキーム | サブネット | リスナー | ターゲットグループ |
|-------|------|---------|----------|---------|----------------|
| facilities-staff-alb | prod | internal | Public 1, 2 | HTTPS 443 | staff-api-tg |
| facilities-vendor-alb | prod | internet-facing | Public 1, 2 | HTTPS 443 | vendor-api-tg |

### 4.2 ターゲットグループ設定

| ターゲットグループ名 | ターゲットタイプ | プロトコル | ポート | 登録解除の遅延 |
|-------------------|---------------|----------|--------|--------------|
| staff-api-tg | ip | HTTP | 3000 | 300秒 |
| vendor-api-tg | ip | HTTP | 3000 | 300秒 |

### 4.3 ヘルスチェック設定

| パラメーター | 設定値 | 備考 |
|------------|--------|------|
| ヘルスチェックパス | /health | |
| プロトコル | HTTP | |
| ポート | 3000 | |
| 間隔 | 30秒 | |
| タイムアウト | 5秒 | |
| 正常判定しきい値 | 2回連続成功 | |
| 異常判定しきい値 | 2回連続失敗 | |

---

## 7. バッチ処理スケジュール

### 7.1 EventBridge スケジュール（prod環境）

| バッチ処理 | スケジュール（cron） | 実行時刻（UTC） | 実行時刻（JST） | 備考 |
|----------|-------------------|--------------|--------------|------|
| 月次レポート生成 | cron(0 17 1 * ? *) | 毎月1日 17:00 | 毎月1日 02:00 | 深夜実行 |
| 年次レポート生成 | cron(0 17 1 1 ? *) | 毎年1月1日 17:00 | 毎年1月1日 02:00 | 深夜実行 |
| 発注期限アラート | cron(0 8 * * ? *) | 毎日 08:00 | 毎日 17:00 | 業務終了時 |

**注**: EventBridgeのスケジュール式はUTC時刻のため、JST → UTC に変換（-9時間）

---

**作成者**: SRE（PM 委譲タスク）
**最終更新**: 2025-10-25
