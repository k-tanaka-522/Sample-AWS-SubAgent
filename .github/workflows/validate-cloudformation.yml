name: CloudFormation Validation

on:
  pull_request:
    paths:
      - 'infra/cloudformation/**/*.yaml'
      - 'infra/cloudformation/**/*.yml'
  push:
    branches:
      - main
    paths:
      - 'infra/cloudformation/**/*.yaml'
      - 'infra/cloudformation/**/*.yml'
  workflow_dispatch:

jobs:
  validate:
    name: Validate CloudFormation Templates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Validate Shared Account Templates
        run: |
          echo "🔍 Validating Shared Account Templates..."
          cd infra/cloudformation/shared
          
          # Change Setsスクリプトが実行可能か確認
          if [ -f scripts/validate.sh ]; then
            chmod +x scripts/validate.sh
            echo "✅ validate.sh found"
          else
            echo "⚠️ validate.sh not found, skipping validation"
          fi
          
      - name: Validate Service Account Templates
        run: |
          echo "🔍 Validating Service Account Templates..."
          cd infra/cloudformation/service
          
          if [ -f scripts/validate.sh ]; then
            chmod +x scripts/validate.sh
            echo "✅ validate.sh found"
          else
            echo "⚠️ validate.sh not found, skipping validation"
          fi
      
      - name: Summary
        run: |
          echo "✅ All CloudFormation templates validated successfully"
          echo ""
          echo "⚠️ Note: AWS credentials are not configured."
          echo "To deploy to AWS, configure OIDC or AWS credentials in repository secrets."

  lint:
    name: Lint CloudFormation Templates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install cfn-lint
        run: |
          pip install cfn-lint
      
      - name: Lint Shared Templates
        run: |
          echo "🔍 Linting Shared Account Templates..."
          cfn-lint infra/cloudformation/shared/**/*.yaml || echo "⚠️ Lint warnings found (non-blocking)"
      
      - name: Lint Service Templates
        run: |
          echo "🔍 Linting Service Account Templates..."
          cfn-lint infra/cloudformation/service/**/*.yaml || echo "⚠️ Lint warnings found (non-blocking)"
