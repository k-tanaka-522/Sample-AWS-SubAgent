AWSTemplateFormatVersion: '2010-09-09'
Description: ECS Task Definition for Vendor API

Parameters:
  Environment:
    Type: String
    AllowedValues:
      - dev
      - stg
      - prod
    Description: Environment name

  ProjectName:
    Type: String
    Description: Project name for resource naming

  ECSTaskCpu:
    Type: String
    Description: Task CPU
    Default: '512'

  ECSTaskMemory:
    Type: String
    Description: Task Memory
    Default: '1024'

  ECSTaskExecutionRoleArn:
    Type: String
    Description: ECS Task Execution Role ARN

  ECSTaskRoleArn:
    Type: String
    Description: ECS Task Role ARN

  VendorAPILogGroupName:
    Type: String
    Description: CloudWatch Log Group Name for Vendor API

  DBSecretArn:
    Type: String
    Description: DB Secret ARN from Secrets Manager

Resources:
  VendorAPITaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub ${ProjectName}-${Environment}-vendor-api
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: !Ref ECSTaskCpu
      Memory: !Ref ECSTaskMemory
      ExecutionRoleArn: !Ref ECSTaskExecutionRoleArn
      TaskRoleArn: !Ref ECSTaskRoleArn
      ContainerDefinitions:
        - Name: vendor-api
          Image: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ProjectName}-vendor-api:latest
          Essential: true
          PortMappings:
            - ContainerPort: 4000
              Protocol: tcp
          Environment:
            - Name: NODE_ENV
              Value: !Ref Environment
            - Name: PORT
              Value: '4000'
            - Name: LOG_LEVEL
              Value: info
          Secrets:
            - Name: DATABASE_URL
              ValueFrom: !Sub ${DBSecretArn}:DATABASE_URL::
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref VendorAPILogGroupName
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs
          HealthCheck:
            Command:
              - CMD-SHELL
              - curl -f http://localhost:4000/health || exit 1
            Interval: 30
            Timeout: 5
            Retries: 3
            StartPeriod: 60
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-vendor-api-task
        - Key: Environment
          Value: !Ref Environment

Outputs:
  VendorAPITaskDefinitionArn:
    Description: Vendor API Task Definition ARN
    Value: !Ref VendorAPITaskDefinition
    Export:
      Name: !Sub ${ProjectName}-${Environment}-VendorAPITaskDefArn
