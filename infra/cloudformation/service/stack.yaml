AWSTemplateFormatVersion: '2010-09-09'
Description: 'Master Stack - Facility Management System Infrastructure'

Parameters:
  Environment:
    Type: String
    AllowedValues:
      - dev
      - stg
      - prod
    Description: Environment name

  ProjectName:
    Type: String
    Default: facility
    Description: Project name for resource naming

  # Network Parameters
  VpcCidr:
    Type: String
    Description: VPC CIDR block

  PublicSubnet1Cidr:
    Type: String
    Description: Public Subnet 1 CIDR

  PublicSubnet2Cidr:
    Type: String
    Description: Public Subnet 2 CIDR

  PrivateSubnet1Cidr:
    Type: String
    Description: Private Subnet 1 CIDR

  PrivateSubnet2Cidr:
    Type: String
    Description: Private Subnet 2 CIDR

  DataSubnet1Cidr:
    Type: String
    Description: Data Subnet 1 CIDR

  DataSubnet2Cidr:
    Type: String
    Description: Data Subnet 2 CIDR

  # Database Parameters
  DBInstanceClass:
    Type: String
    Description: RDS instance class

  DBAllocatedStorage:
    Type: Number
    Description: RDS allocated storage (GB)

  DBMultiAZ:
    Type: String
    AllowedValues:
      - 'true'
      - 'false'
    Description: Enable Multi-AZ for RDS

  DBBackupRetentionPeriod:
    Type: Number
    Description: RDS backup retention period (days)

  # ECS Parameters
  ECSTaskCpu:
    Type: Number
    Description: ECS Task CPU units

  ECSTaskMemory:
    Type: Number
    Description: ECS Task Memory (MB)

  ECSDesiredCount:
    Type: Number
    Description: Desired number of ECS tasks

  ECSMinCapacity:
    Type: Number
    Description: Minimum number of tasks for Auto Scaling

  ECSMaxCapacity:
    Type: Number
    Description: Maximum number of tasks for Auto Scaling

  BatchTaskCpu:
    Type: Number
    Description: Batch Task CPU units

  BatchTaskMemory:
    Type: Number
    Description: Batch Task Memory (MB)

  # Monitoring Parameters
  AlertEmail:
    Type: String
    Default: 'changeme@example.com'
    Description: Email address for CloudWatch alarms

  # Template S3 Bucket
  TemplateS3Bucket:
    Type: String
    Description: S3 bucket name for nested CloudFormation templates

  TemplateS3Prefix:
    Type: String
    Default: 'cloudformation/service'
    Description: S3 prefix for nested templates

Resources:
  # ============================================================================
  # Network Layer
  # ============================================================================
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/network/vpc-and-igw.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
        VpcCidr: !Ref VpcCidr
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-vpc-stack
        - Key: Environment
          Value: !Ref Environment

  SubnetsStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: VPCStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/network/subnets.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
        PublicSubnet1Cidr: !Ref PublicSubnet1Cidr
        PublicSubnet2Cidr: !Ref PublicSubnet2Cidr
        PrivateSubnet1Cidr: !Ref PrivateSubnet1Cidr
        PrivateSubnet2Cidr: !Ref PrivateSubnet2Cidr
        DataSubnet1Cidr: !Ref DataSubnet1Cidr
        DataSubnet2Cidr: !Ref DataSubnet2Cidr
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-subnets-stack

  RouteTablesStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: SubnetsStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/network/route-tables.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-route-tables-stack

  SecurityGroupsStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: SubnetsStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/network/security-groups.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-security-groups-stack

  VPCEndpointsStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - RouteTablesStack
      - SecurityGroupsStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/network/vpc-endpoints.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-vpc-endpoints-stack

  # ============================================================================
  # Security Layer
  # ============================================================================
  KMSKeysStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/security/kms-keys.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-kms-keys-stack

  # ============================================================================
  # Compute Layer - IAM Roles
  # ============================================================================
  ECSExecutionRoleStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: KMSKeysStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/compute/ecs-execution-role.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-ecs-execution-role-stack

  ECSTaskRoleStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/compute/ecs-task-role.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-ecs-task-role-stack

  # ============================================================================
  # Security Layer - Secrets
  # ============================================================================
  SecretsManagerStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - KMSKeysStack
      - ECSTaskRoleStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/security/secrets-manager.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-secrets-manager-stack

  # ============================================================================
  # Database Layer
  # ============================================================================
  RDSSubnetGroupStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: SubnetsStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/database/rds-subnet-group.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-rds-subnet-group-stack

  RDSParameterGroupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/database/rds-parameter-group.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-rds-parameter-group-stack

  RDSOptionGroupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/database/rds-option-group.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-rds-option-group-stack

  RDSStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - RDSSubnetGroupStack
      - RDSParameterGroupStack
      - RDSOptionGroupStack
      - SecurityGroupsStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/database/rds-postgresql.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
        DBInstanceClass: !Ref DBInstanceClass
        DBAllocatedStorage: !Ref DBAllocatedStorage
        DBMultiAZ: !Ref DBMultiAZ
        DBBackupRetentionPeriod: !Ref DBBackupRetentionPeriod
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-rds-stack

  # ============================================================================
  # Compute Layer - ECS
  # ============================================================================
  ECSClusterStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/compute/ecs-cluster.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-ecs-cluster-stack

  ALBStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - SubnetsStack
      - SecurityGroupsStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/compute/alb.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-alb-stack

  ALBTargetGroupsStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: ALBStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/compute/alb-target-groups.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-alb-target-groups-stack

  StaffAPITaskDefinitionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - ECSExecutionRoleStack
      - ECSTaskRoleStack
      - RDSStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/compute/staff-api-task-definition.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
        ECSTaskCpu: !Ref ECSTaskCpu
        ECSTaskMemory: !Ref ECSTaskMemory
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-staff-api-task-def-stack

  VendorAPITaskDefinitionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - ECSExecutionRoleStack
      - ECSTaskRoleStack
      - RDSStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/compute/vendor-api-task-definition.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
        ECSTaskCpu: !Ref ECSTaskCpu
        ECSTaskMemory: !Ref ECSTaskMemory
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-vendor-api-task-def-stack

  BatchTaskDefinitionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - ECSExecutionRoleStack
      - ECSTaskRoleStack
      - RDSStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/compute/batch-task-definition.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
        BatchTaskCpu: !Ref BatchTaskCpu
        BatchTaskMemory: !Ref BatchTaskMemory
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-batch-task-def-stack

  StaffAPIServiceStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - ECSClusterStack
      - StaffAPITaskDefinitionStack
      - ALBTargetGroupsStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/compute/staff-api-service.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
        ECSDesiredCount: !Ref ECSDesiredCount
        ECSMinCapacity: !Ref ECSMinCapacity
        ECSMaxCapacity: !Ref ECSMaxCapacity
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-staff-api-service-stack

  VendorAPIServiceStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - ECSClusterStack
      - VendorAPITaskDefinitionStack
      - ALBTargetGroupsStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/compute/vendor-api-service.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
        ECSDesiredCount: !Ref ECSDesiredCount
        ECSMinCapacity: !Ref ECSMinCapacity
        ECSMaxCapacity: !Ref ECSMaxCapacity
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-vendor-api-service-stack

  # ============================================================================
  # Security Layer - WAF
  # ============================================================================
  WAFStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: ALBStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/security/waf-web-acl.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-waf-stack

  # ============================================================================
  # Auth Layer - Cognito
  # ============================================================================
  CognitoUserPoolStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/auth/cognito-user-pool.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-cognito-user-pool-stack

  CognitoUserPoolClientStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: CognitoUserPoolStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/auth/cognito-user-pool-client.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-cognito-client-stack

  CognitoIdentityPoolStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: CognitoUserPoolClientStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/auth/cognito-identity-pool.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-cognito-identity-pool-stack

  # ============================================================================
  # Frontend Layer - S3 & CloudFront
  # ============================================================================
  S3BucketsStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - KMSKeysStack
      - ECSTaskRoleStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/frontend/s3-buckets.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-s3-buckets-stack

  CloudFrontOACStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/frontend/cloudfront-oac.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-cloudfront-oac-stack

  CloudFrontDistributionsStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - S3BucketsStack
      - CloudFrontOACStack
      - WAFStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/frontend/cloudfront-distributions.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-cloudfront-distributions-stack

  # ============================================================================
  # Monitoring Layer
  # ============================================================================
  SNSTopicsStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: ECSTaskRoleStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/monitoring/sns-topics.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
        AlertEmail: !Ref AlertEmail
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-sns-topics-stack

  CloudWatchAlarmsALBStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - ALBStack
      - SNSTopicsStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/monitoring/cloudwatch-alarms-alb.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-cloudwatch-alarms-alb-stack

  CloudWatchAlarmsECSStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - StaffAPIServiceStack
      - VendorAPIServiceStack
      - SNSTopicsStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/monitoring/cloudwatch-alarms-ecs.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-cloudwatch-alarms-ecs-stack

  CloudWatchAlarmsRDSStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - RDSStack
      - SNSTopicsStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/monitoring/cloudwatch-alarms-rds.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-cloudwatch-alarms-rds-stack

  # ============================================================================
  # Batch Layer
  # ============================================================================
  EventBridgeRulesStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - ECSClusterStack
      - BatchTaskDefinitionStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}/nested/batch/eventbridge-rules.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-eventbridge-rules-stack

Outputs:
  VPCId:
    Description: VPC ID
    Value: !GetAtt VPCStack.Outputs.VPCId

  InternalALBDNSName:
    Description: Internal ALB DNS Name
    Value: !GetAtt ALBStack.Outputs.InternalALBDNSName

  PublicALBDNSName:
    Description: Public ALB DNS Name
    Value: !GetAtt ALBStack.Outputs.PublicALBDNSName

  RDSEndpoint:
    Description: RDS Endpoint
    Value: !GetAtt RDSStack.Outputs.DBEndpointAddress

  StaffDistributionDomain:
    Description: Staff CloudFront Distribution Domain
    Value: !GetAtt CloudFrontDistributionsStack.Outputs.StaffSPADistributionDomainName

  VendorDistributionDomain:
    Description: Vendor CloudFront Distribution Domain
    Value: !GetAtt CloudFrontDistributionsStack.Outputs.VendorSPADistributionDomainName
